/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Control","sap/m/library","sap/base/Log","sap/m/Label","sap/suite/ui/microchart/AreaMicroChart","sap/suite/ui/microchart/ColumnMicroChart","sap/suite/ui/microchart/LineMicroChart"],function(C,m,L,a,A,b,c){"use strict";var V=m.ValueColor;var M=C.extend("sap.fe.macros.microchart.MicroChartContainer",{metadata:{properties:{renderLabels:{type:"boolean",defaultValue:true},uomPath:{type:"string",defaultValue:undefined},measures:{type:"string[]",defaultValue:[]},dimensions:{type:"string[]",defaultValue:[]},dataPointQualifiers:{type:"string[]",defaultValue:[]}},events:{},defaultAggregation:"microChart",aggregations:{microChart:{type:"sap.ui.core.Control",multiple:false},_uomLabel:{type:"sap.m.Label",multiple:false}},publicMethods:[]},renderer:{render:function(r,o){r.write("<div");r.writeControlData(o);r.writeClasses();r.write(">");r.renderControl(o.getMicroChart());if(o.getRenderLabels()&&o.getUomPath()){var s=o._checkIfChartRequiresRuntimeLabels()?undefined:{text:{path:o.getUomPath()}},l=new a(s);l.addStyleClass("sapUiTinyMarginTop");o.setAggregation("_uomLabel",l);r.renderControl(l);}r.write("</div>");}}});M.prototype.onBeforeRendering=function(){var t=this,B=t._getListBindingForRuntimeLabels();if(B){B.detachEvent("change",t._setRuntimeChartLabelsAndUnitOfMeasure,t);t._olistBinding=undefined;}};M.prototype.onAfterRendering=function(){var t=this,B=t._getListBindingForRuntimeLabels();if(!t.getRenderLabels()||!t._checkIfChartRequiresRuntimeLabels()){return;}if(B){B.attachEvent("change",t._setRuntimeChartLabelsAndUnitOfMeasure,t);t._olistBinding=B;}};M.prototype.setRenderLabels=function(v){var t=this;if(!v&&t._olistBinding){t._olistBinding.detachEvent("change",t._setRuntimeChartLabelsAndUnitOfMeasure,t);t._setChartLabels();}this.setProperty("renderLabels",v,false);};M.prototype._checkIfChartRequiresRuntimeLabels=function(){var t=this,o=t.getMicroChart();return(o instanceof A||o instanceof b||o instanceof c);};M.prototype._checkForChartLabelAggregations=function(){var t=this,o=t.getMicroChart();return((o instanceof A&&o.getAggregation("firstYLabel")&&o.getAggregation("lastYLabel")&&o.getAggregation("firstXLabel")&&o.getAggregation("lastXLabel"))||(o instanceof b&&o.getAggregation("leftTopLabel")&&o.getAggregation("rightTopLabel")&&o.getAggregation("leftBottomLabel")&&o.getAggregation("rightBottomLabel"))||o instanceof c);};M.prototype._getListBindingForRuntimeLabels=function(){var t=this,o=t.getMicroChart(),B;if(o instanceof A){var d=o.getChart();B=d&&o.getChart().getBinding("points");}else if(o instanceof b){B=o.getBinding("columns");}else if(o instanceof c){var l=o.getLines();B=l&&l.length&&l[0].getBinding("points");}return B;};M.prototype._setRuntimeChartLabelsAndUnitOfMeasure=function(){var t=this,l=t._olistBinding,d=l.getContexts(),e=t.getMeasures()&&t.getMeasures(),D=t.getDimensions()&&t.getDimensions(),u=this.getUomPath(),o=t.getMicroChart(),U=t.getAggregation("_uomLabel");if(u&&d.length){U.setText(d[0].getObject(u));}if(!t._checkForChartLabelAggregations()){return;}if(!d.length){t._setChartLabels();return;}var f=d[0],g=d[d.length-1],h={value:Infinity},j={value:-Infinity},k={value:Infinity},n={value:-Infinity},p=[],q=o instanceof c,r,s,v,w;e.forEach(function(x,i){s=f.getObject(x);r=f.getObject(D[i]);w=g.getObject(x);v=g.getObject(D[i]);j=v>j.value?{context:g,value:v,index:q?i:0}:j;h=r<h.value?{context:f,value:r,index:q?i:0}:h;n=w>n.value?{context:g,value:w,index:q?i:0}:n;k=s<k.value?{context:f,value:s,index:q?i:0}:k;if(q){p.push(t._getCriticalityFromPoint({context:g,value:w,index:i}));}});t._setChartLabels(n.value,j.value,h.value,k.value);if(q){Promise.all(p).then(function(x){var y=o.getLines();y.forEach(function(z,i){z.setColor(x[i]);});});}else{t._setChartLabelsColors(n,k);}};M.prototype._setChartLabelsColors=function(o,d){var t=this,e=t.getMicroChart();Promise.all([t._getCriticalityFromPoint(d),t._getCriticalityFromPoint(o)]).then(function(f){if(e instanceof A){e.getAggregation("firstYLabel").setProperty("color",f[0],true);e.getAggregation("lastYLabel").setProperty("color",f[1],true);}else if(e instanceof b){e.getAggregation("leftTopLabel").setProperty("color",f[0],true);e.getAggregation("rightTopLabel").setProperty("color",f[1],true);}});};M.prototype._setChartLabels=function(r,d,l,e){var t=this,o=t.getMicroChart();if(o instanceof A){o.getAggregation("firstYLabel").setProperty("label",e,false);o.getAggregation("lastYLabel").setProperty("label",r,false);o.getAggregation("firstXLabel").setProperty("label",l,false);o.getAggregation("lastXLabel").setProperty("label",d,false);}else if(o instanceof b){o.getAggregation("leftTopLabel").setProperty("label",e,false);o.getAggregation("rightTopLabel").setProperty("label",r,false);o.getAggregation("leftBottomLabel").setProperty("label",l,false);o.getAggregation("rightBottomLabel").setProperty("label",d,false);}else if(o instanceof c){o.setProperty("leftTopLabel",e,false);o.setProperty("rightTopLabel",r,false);o.setProperty("leftBottomLabel",l,false);o.setProperty("rightBottomLabel",d,false);}};M.prototype._getCriticalityFromPoint=function(p){var t=this,o=t.getModel().getMetaModel(),d=t.getDataPointQualifiers(),s=o.getMetaPath(p.context.getPath());return o.requestObject(s+"/@com.sap.vocabularies.UI.v1.DataPoint"+(d[p.index]?"#"+(d[p.index]):"")).then(function(D){var e=V.Neutral,f=p.context;if(D.Criticality){e=t._criticality(D.Criticality,f);}else if(D.CriticalityCalculation){var g=D.CriticalityCalculation,h={},G=function(P){var r;if(P.$Path){r=f.getObject(P.$Path);}else if(P.hasOwnProperty("$Decimal")){r=P.$Decimal;}return r;};h.sAcceptanceHigh=g.AcceptanceRangeHighValue?G(g.AcceptanceRangeHighValue):undefined;h.sAcceptanceLow=g.AcceptanceRangeLowValue?G(g.AcceptanceRangeLowValue):undefined;h.sDeviationHigh=g.DeviationRangeHighValue?G(g.DeviationRangeHighValue):undefined;h.sDeviationLow=g.DeviationRangeLowValue?G(g.DeviationRangeLowValue):undefined;h.sToleranceHigh=g.ToleranceRangeHighValue?G(g.ToleranceRangeHighValue):undefined;h.sToleranceLow=g.ToleranceRangeLowValue?G(g.ToleranceRangeLowValue):undefined;h.sImprovementDirection=g.ImprovementDirection.$EnumMember;e=t._criticalityCalculation(h.sImprovementDirection,p.value,h.sDeviationLow,h.sToleranceLow,h.sAcceptanceLow,h.sAcceptanceHigh,h.sToleranceHigh,h.sDeviationHigh);}return e;});};M.prototype._criticality=function(o,d){var i,s=V.Neutral;if(o.$Path){var e=o.$Path;i=d.getObject(e);if(i==='Negative'||i==='1'||i===1){s=V.Error;}else if(i==='Critical'||i==='2'||i===2){s=V.Critical;}else if(e==='Positive'||e==='3'||e===3){s=V.Good;}}else if(o.$EnumMember){i=o.$EnumMember;if(i.indexOf("Negative")>-1){s=V.Error;}else if(i.indexOf("Positive")>-1){s=V.Good;}else if(i.indexOf("Critical")>-1){s=V.Critical;}}else{L.warning("Case not supported, returning the default Value Neutral");}return s;};M.prototype._criticalityCalculation=function(i,v,d,t,s,e,T,D){var f=V.Neutral;d=d==undefined?-Infinity:d;t=t==undefined?d:t;s=s==undefined?t:s;D=D==undefined?Infinity:D;T=T==undefined?D:T;e=e==undefined?T:e;if(i.indexOf('Minimize')>-1){if(v<=e){f=V.Good;}else if(v<=T){f=V.Neutral;}else if(D&&v<=D){f=V.Error;}else{f=V.Critical;}}else if(i.indexOf('Maximize')>-1){if(v>=s){f=V.Good;}else if(v>=t){f=V.Neutral;}else if(D&&v>=d){f=V.Error;}else{f=V.Critical;}}else if(i.indexOf('Target')>-1){if(v<=e&&v>=s){f=V.Good;}else if(v>=t&&v<s||v>e&&v<=T){f=V.Neutral;}else if((d&&v>=d&&v<t)||(v>T&&D&&v<=D)){f=V.Error;}else{f=V.Critical;}}else{L.warning("Case not supported, returning the default Value Neutral");}return f;};return M;},true);
