/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/macros/CommonHelper","sap/ui/mdc/base/FieldBase","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/base/ManagedObject","sap/base/Log"],function(C,F,A,M,L){"use strict";var I="@Org.OData.Measures.V1.ISOCurrency",U="@Org.OData.Measures.V1.Unit",a={},b=', ';a[I]={ui5Type:"sap.ui.model.type.Currency",formatOptions:'parseAsString : true'};function _(i){var m=i.getModel(),f=i.getSetting("sap.fe.macros.Field"),s=f.sideEffects;if(s){return Promise.resolve(s);}s={};return m.requestObject('/$').then(function(e){var d=function(k){return e[k]['$kind']==='EntityType';},g=function(E,S,o){var q=S.indexOf('#')>-1&&S.substr(S.indexOf('#'))||'',j=o.SourceProperties||[],k=o.SourceEntities||[],p=[];j.forEach(function(l){var P=l['$PropertyPath'],n=P.indexOf('/')>0?'/'+E+'/'+P.substr(0,P.lastIndexOf('/')+1)+'@sapui.name':false,r=!n?Promise.resolve(E):m.requestObject(n);P=n?P.substr(P.lastIndexOf('/')+1):P;p.push(r.then(function(O){s[O]=s[O]||[[],{}];s[O][1][P]=s[O][1][P]||[];s[O][1][P].push(E+q+(j.length===1&&'$$ImmediateRequest'||''));}));});k.forEach(function(l){var n=l['$NavigationPropertyPath'],r;if(n===''){r=Promise.resolve(E);}else{r=m.requestObject('/'+E+'/'+n+'/@sapui.name');}p.push(r.then(function(O){s[O]=s[O]||[[],{}];s[O][0].push(E+q+'$$ImmediateRequest');}));});return Promise.all(p);},h=function(E){return m.requestObject('/'+E+'@').then(function(o){var S=Object.keys(o).filter(function(j){return j.indexOf('@com.sap.vocabularies.Common.v1.SideEffects')>-1;}).map(function(j){return g(E,j,o[j]);});return Promise.all(S);});};return Promise.all(Object.keys(e).filter(d).map(h)).then(function(){f.sideEffects=s;return s;});});}var c={getFieldDisplay:function(o,d,f,D,e,p,g,h){var s="",i="";if(h){return c.displayMode(o,g);}else{i=C.getEditMode(o,d,f,D,e,p,false,undefined);if(i==='Editable'){return'Value';}else{s=c.displayMode(o,g);if(M.bindingParser(i)){if(!i.startsWith("{=")){return"{= $"+i+" === 'Editable' ? 'Value' : '"+s+"' }";}return"{= ("+i.slice(2,i.length-1).trim()+") === 'Editable' ? 'Value' : '"+s+"' }";}return s;}}},displayMode:function(p,o){var t=p['@com.sap.vocabularies.Common.v1.Text'],T=t&&((p&&p['@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement'])||(o&&o['@com.sap.vocabularies.UI.v1.TextArrangement']));if(T){if(T.$EnumMember==='com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly'){return'Description';}else if(T.$EnumMember==='com.sap.vocabularies.UI.v1.TextArrangementType/TextLast'){return'ValueDescription';}return'DescriptionValue';}return(t?'DescriptionValue':'Value');},isRequiredInFilter:function(p,d){var e,P,i=false,f,m=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}f=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(f&&f.RequiredProperties){i=f.RequiredProperties.some(function(g){return g.$PropertyPath===P;});}return i;},buildExpressionForCriticalityIcon:function(s){if(s){var e="{= (${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Negative') || (${"+s+"} === '1') || (${"+s+"} === 1) ? 'sap-icon://status-negative' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Critical') || (${"+s+"} === '2') || (${"+s+"} === 2) ? 'sap-icon://status-critical' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Positive') || (${"+s+"} === '3') || (${"+s+"} === 3) ? 'sap-icon://status-positive' : "+"'sap-icon://status-inactive' }";return e;}return undefined;},buildExpressionForCriticalityColor:function(s){if(s){var e="{= (${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Negative') || (${"+s+"} === '1') || (${"+s+"} === 1) ? 'Error' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Critical') || (${"+s+"} === '2') || (${"+s+"} === 2) ? 'Warning' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Positive') || (${"+s+"} === '3') || (${"+s+"} === 3) ? 'Success' : "+"'None' }";return e;}return undefined;},buildExpressionForTextValue:function(p,d){var m=d.context.getModel(),P=d.context.getPath(),t=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text"),T=t?A.value(t,d):undefined,e="";p=A.getNavigationPath(p);if(p.indexOf('/')>-1&&T){e="{"+p.substr(0,p.indexOf('/')+1)+T.substr(1,T.length-2)+"}";}else{e=T;}if(e){e="{ path : '"+e.substr(1,e.length-2)+"', mode : 'OneWay'}";}return e;},getStableIdPartFromDataField:function(d,p){var P="",s="";if(d.$Type&&d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"){return C.replaceSpecialCharsInId(d.Action);}else if(d.$Type&&(d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation")){if(typeof d.SemanticObject=="string"){s=C.replaceSpecialCharsInId(d.SemanticObject);}else if(d.SemanticObject.$Path){s=C.replaceSpecialCharsInId(d.SemanticObject.$Path);}if(typeof d.Action=="string"){s=s+"::"+C.replaceSpecialCharsInId(d.Action);}else if(d.Action&&d.Action.$Path){s=s+"::"+C.replaceSpecialCharsInId(d.Action.$Path);}return s;}else if(d.$Type&&d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"){return C.replaceSpecialCharsInId(d.Target.$AnnotationPath);}else if(d.Value&&d.Value.$Path){return C.replaceSpecialCharsInId(d.Value.$Path);}else if(d.Value&&d.Value.$Apply&&d.Value.$Function==="odata.concat"){for(var i=0;i<d.Value.$Apply.length;i++){if(d.Value.$Apply[i].$Path){if(P){P=P+"::";}P=P+C.replaceSpecialCharsInId(d.Value.$Apply[i].$Path);}}return P;}else if(p&&p.context&&p.context.getObject("@sapui.name")){return C.replaceSpecialCharsInId(p.context.getObject("@sapui.name"));}else{L.error("Annotation Helper: Unable to create a stable ID. Please check the annotations.");}return undefined;},isNotAlwaysHidden:function(d,D){var o=D.context,i=false;if(d.Value&&d.Value.$Path){i=o.getObject("Value/$Path@com.sap.vocabularies.UI.v1.Hidden");}if(!i||i.$Path){i=o.getObject("@com.sap.vocabularies.UI.v1.Hidden");if(!i||i.$Path){i=false;}}return!i;},isSemanticKey:function(s,v){return v&&s&&!(s.every(function(k){return k['$PropertyPath']!==v['$Path'];}))||false;},isLineItem:function(p,i){if(i.context.getPath().indexOf("@com.sap.vocabularies.UI.v1.LineItem")>-1){return true;}return false;},getRequiredForDataField:function(f,e){if(e==='Display'||e==='ReadOnly'||e==='Disabled'){return false;}if(f&&e){if(e.indexOf("{")>-1){var E="%"+e+" === 'Editable'";}if(f.indexOf("{")>-1){var s="%"+f+" === 7";return(e==='Editable')?"{="+s+"}":"{= "+s+" && "+E+"}";}else{return(e==='Editable')?(f=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory"):(f=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory"&&"{= "+E+"}");}}return false;},isRequired:function(f,e){if(e==='Display'||e==='ReadOnly'||e==='Disabled'){return false;}if(f){if(M.bindingParser(f)){var E="{= %"+f+" === 7}";return E;}else{return(f=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory");}}return false;},_createBindingForDraftAdminBlock:function(m,e,f){var p="/"+e+"/DraftAdministrativeData/";return m.requestObject(p).then(function(d){var B="{parts: [{path: 'HasDraftEntity', targetType: 'any'}, "+"{path: 'DraftAdministrativeData/InProcessByUser'}, "+"{path: 'DraftAdministrativeData/LastChangedByUser'} ";if(d.InProcessByUserDescription){B+=" ,{path: 'DraftAdministrativeData/InProcessByUserDescription'}";}if(d.LastChangedByUserDescription){B+=", {path: 'DraftAdministrativeData/LastChangedByUserDescription'}";}B+="], formatter: 'sap.fe.macros.field.FieldRuntime."+f+"'}";return B;});},getBindingForDraftAdminBlockInline:function(i,e){return c._createBindingForDraftAdminBlock(i.getModel(),e,'formatDraftOwnerTextInline');},getBindingForDraftAdminBlockInPopover:function(i,e){return c._createBindingForDraftAdminBlock(i.getModel(),e,'formatDraftOwnerTextInPopover');},propertyName:function(p,i){var P;if(typeof p==='string'){P=p;}else if(p.$Path||p.$PropertyPath){var s=p.$Path?"/$Path":"/$PropertyPath";var d=i.context.getPath();P=i.context.getObject(d+s+"/$@sapui.name");}else{P=i.context.getObject("@sapui.name");}return P;},getConditionsBinding:function(d,p,e){var m=d.getInterface(0).getModel(),f=typeof p==='string'?p:c.propertyName(p,{context:m.createBindingContext(d.getInterface(0).getPath())});if(f.indexOf('/')>-1){var t,s=f.split('/');for(var i=0;i<(s.length-1);i++){var P=m.getObject("/"+e+"/"+s.slice(0,(i+1)).join('/'));if(P&&P.$kind==="NavigationProperty"&&P.$isCollection){s[i]=s[i]+'*';t=true;}}if(t){f=s.join('/');}}return"{$filters>/conditions/"+f+"}";},typeConstraints:function(p,P){var s="",m,t=p.$Type;s+=(p.$Nullable!==undefined&&!p.$Nullable?'nullable: '+p.$Nullable:'');if(["Edm.Decimal","Edm.DateTimeOffset"].indexOf(t)>-1){s+=(p.$Precision?(s?b:'')+'precision: '+p.$Precision:'');s+=(p.$Scale?(s?b:'')+'scale: '+(p.$Scale==="variable"?"'"+p.$Scale+"'":p.$Scale):'');}else if(t==="Edm.String"){m=p.$MaxLength;if(m){s+=(s?b:'');s+="maxLength: "+m;}if(P["@com.sap.vocabularies.Common.v1.IsUpperCase"]){}}return s;},value:function(p,i){var o=i.context,r=o.getObject("./$"),m=typeof p==='string'?p:(p.$Name||o.getObject("./$@sapui.name")),P=o.getObject("@");return Promise.resolve().then(function(v){var R='',s='',f='',d,e,u;if(m&&P){e=P.hasOwnProperty(I)&&I;if(e){d=P[e];u=a[e];R='{'+'parts: ['+'\''+m+'\',\''+d.$Path+'\''+'], type: \''+u.ui5Type+'\'';f+=u.formatOptions;}else{R='{path: \''+m+'\'';R+=',type: \''+F.mapEdmTypes[r.$Type]+'\'';}s+=(s?b:'')+c.typeConstraints(r,P);R+=s?',constraints: {'+s+'}':'';f+=['Edm.Date','Edm.DateTimeOffset'].indexOf(r.$Type)>-1?(f?b:'')+'style : \'medium\'':'';R+=f?',formatOptions : {'+f+'}':'';R+='}';}else{R=A.value(p,{context:o});}return R;});},_format:function(p,i){var o=i.context,d=p.$kind==="Property"?{$PropertyPath:o.getObject("./$@sapui.name")}:p;return A.format(d,{context:o});},constraints:function(p,i){return c.value(p,i).then(function(v){var m=v.match(/constraints:.*?({.*?})/);return m&&m[1]||undefined;});},formatOptions:function(p,i){return c.value(p,i).then(function(v){var m=v.match(/formatOptions:.*?({.*?})/);return m&&m[1]||undefined;});},getFieldGroupIds:function(o,p,e){if(!p){return undefined;}var i=o.getInterface(0);return _(i).then(function(s){var m=i.getModel(),P=p,n=P.indexOf('/')>0?'/'+e+'/'+P.substr(0,P.lastIndexOf('/')+1)+'@sapui.name':false,d=!n?Promise.resolve(e):m.requestObject(n),f,g;P=n?P.substr(P.lastIndexOf('/')+1):P;return d.then(function(O){f=(s[O]&&s[O][0].concat(s[O][1][P]||[]))||[];if(f.length){g=f.reduce(function(r,h){return(r&&r+','+h)||h;});}return g;});});},fieldControl:function(p,i){var m=i&&i.context.getModel();var P=i&&i.context.getPath();var f=m&&m.getObject(P+"@com.sap.vocabularies.Common.v1.FieldControl");if(f){if(f.hasOwnProperty("$EnumMember")){return f.$EnumMember;}else if(f.hasOwnProperty("$Path")){return A.value(f,{context:i.context});}}else{return undefined;}},getNavigationEntity:function(p,o){var d=o&&o.context||p,P=A.getNavigationPath(d.getPath())+'/',e=d.getObject(P),f=Object.keys(e),l=f.length,i=0;for(;i<l;i++){if(e[f[i]].$kind==='NavigationProperty'&&e[f[i]].$ReferentialConstraint&&e[f[i]].$ReferentialConstraint.hasOwnProperty(d.getObject().$Path)){return o?A.getNavigationBinding(f[i]):P+f[i];}}},valueHelpProperty:function(p){var s=p.getPath(),o=p.getObject()||{},P=o.$Path?(s+'/$Path'):s,d=P+"@",e=p.getObject(d),f;if(e){f=e.hasOwnProperty(I)&&I||e.hasOwnProperty(U)&&U;if(f){P=P+f+'/$Path';}}return P;},getHiddenPathExpression:function(d,D){var o=D.context,h,p=o.getPath(),e=A.getNavigationPath(p),H=o.getObject(p+"@com.sap.vocabularies.UI.v1.Hidden");if(H.$Path){if(H.$Path.indexOf("/")>0){var n=H.$Path.split("/")[0];if(o.getObject(e+"/"+n)&&!o.getObject(e+"/"+n).$isCollection){h="%{"+H.$Path+"}";}else{return true;}}else{h="%{"+H.$Path+"}";}}return"{= "+h+"=== true ? false : true }";},getSemanticKeyTitle:function(p,P,d){var n=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("field.NEW_OBJECT");var u=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("field.UNNAMED_OBJECT");var N,s;var e=function(v){N="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+n+"': $"+v+")";s="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+u+"': $"+v+")";return"{= !%{IsActiveEntity} ? !%{HasActiveEntity} ? "+N+" : "+s+" : "+s+"}";};if(p){return e(p);}else if(P){return e(P);}else{d="{"+d+"}";return e(d);}},getTooltip:function(t,v,e){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var T;if(e.indexOf("Rating")!==-1){T=r.getText("table.RATING_INDICATOR_TOOLTIP",[t,v]);}else if(e.indexOf("Progress")!==-1){T=r.getText("table.PROGRESS_INDICATOR_TOOLTIP",[t,v]);}return T;},buildExpressionForProgressIndicatorPercentValue:function(v,t,u){var p="0";var e;v=v.charAt(0)==="{"?"$"+v:v;t=t.charAt(0)==="{"?"$"+t:t;var E="(({0} > 100) ? 100 : (({0} < 0) ? 0 : ({0} * 1)))";var s="(({1} > 0) ? (({0} > {1}) ? 100 : (({0} < 0) ? 0 : ({0} / {1} * 100))) : 0)";if(u){u="'"+u+"'";e="'{'= ({2} === ''%'') ? "+E+" : "+s+" '}'";p=jQuery.sap.formatMessage(e,[v,t,u]);}else{e="'{'= "+s+" '}'";p=jQuery.sap.formatMessage(e,[v,t]);}return p;},buildExpressionForProgressIndicatorDisplayValue:function(v,t,u){var d="";if(v){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc",true).then(function(r){if(u){if(u==='%'){d=v+" %";}else{if(t){d=r.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t])+" "+u;}else{d=v+" "+u;}}}else{if(t){d=r.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t]);}else{d=v;}}return d;});}else{L.warning("Value property is mandatory, the default (empty string) will be returned");}},getMarginClass:function(o,d){if(JSON.stringify(o[o.length-1])==JSON.stringify(d)){return"";}else{return"sapUiTinyMarginBottom";}}};c.getConditionsBinding.requiresIContext=true;c.buildExpressionForTextValue.requiresIContext=true;c.getRequiredForDataField.requiresIContext=true;c.getBindingForDraftAdminBlockInline.requiresIContext=true;c.getBindingForDraftAdminBlockInPopover.requiresIContext=true;c.value.requiresIContext=true;c.getFieldGroupIds.requiresIContext=true;c.fieldControl.requiresIContext=true;return c;},true);
