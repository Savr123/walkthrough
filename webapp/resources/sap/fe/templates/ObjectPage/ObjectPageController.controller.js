/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/controllerextensions/Transaction","sap/fe/controllerextensions/Routing","sap/fe/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding"],function(C,J,T,R,E,O){"use strict";return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{transaction:T,routing:R,editFlow:E,onInit:function(){this.getView().setModel(this.editFlow.getUIStateModel(),"ui");this.getView().setModel(new J(),"localUI");},onBeforeBinding:function(c,p){var t=this._findTables(),f,b;for(var i=0;i<t.length;i++){f=t[i].getCreationRow();if(f){f.setBindingContext(null);}}if(p&&p.editable){if(c===null){b=true;}this.editFlow.setEditMode('Editable',b);}else{if(this.getView().getViewData().viewLevel===1){this.editFlow.setEditMode('Display',false);}else{this.editFlow.setEditMode(undefined,false);}}var o=this.byId("fe::op");var s=function(e){o.scrollToSection(o.getScrollingSectionId());o.detachModelContextChange(s);};o.attachModelContextChange(s);},onAfterBinding:function(b,p){var o=this.byId('fe::op'),t=this,m=b.getModel(),a=this._findTables(),f,P;m.getBindingForReference(p.listBindingId).then(function(B){if(B.isA("sap.ui.model.odata.v4.ODataListBinding")){P=t.byId("fe::paginator");if(P&&!P.getListBinding()){P.setListBinding(B);}}});b=o.getBindingContext();f=this.editFlow.computeEditMode(b);function e(c,l){var F=c.getCreationRow(),A,d,g;if(F){f.then(function(){if(F.getVisible()){A=l.getContext().getPath()+'/'+l.getPath();d=m.bindList(A,null,[],[],{$$updateGroupId:"create"});g=d.create();F.setBindingContext(g);}});}}o._triggerVisibleSubSectionsEvents();function h(l,c){m.getBindingForReference(l).then(function(B){t.editFlow.handlePatchEvents(B);e(c,B);});}this.editFlow.handlePatchEvents(b).then(function(){var n,c;for(var i=0;i<a.length;i++){c=a[i].getCustomData();for(var d in c){if(c[d].getKey()==='namedBindingId'){n=c[d].getValue();}}h(n,a[i]);}});},_findTables:function(){var o=this.byId('fe::op'),t=[];function f(p){for(var e=0;e<p.length;e++){var P=p[e].getAggregation('items')&&p[e].getAggregation('items')[0],c=P&&P.getAggregation('content');if(c&&c.isA('sap.ui.mdc.Table')){t.push(c);}}}var s=o.getSections();for(var a=0;a<s.length;a++){var S=s[a].getSubSections();for(var b=0;b<S.length;b++){f(S[b].getBlocks());f(S[b].getMoreBlocks());}}return t;},handlers:{onDataRequested:function(){var n=this.getView().getController().getOwnerComponent().getRootControl();n.setBusy(true);},onDataReceived:function(e){var s=e&&e.getParameter("error");var n=this.getView().getController().getOwnerComponent().getRootControl();n.setBusy(false);var t=this;if(s){sap.ui.getCore().getLibraryResourceBundle("sap.fe",true).then(function(r){t.routing.navigateToMessagePage(r.getText('SAPFE_DATA_RECEIVED_ERROR'),{title:r.getText('SAPFE_ERROR'),description:s,navContainer:n});});}}}});});
