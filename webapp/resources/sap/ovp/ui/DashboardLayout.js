sap.ui.define(["sap/ui/core/Control","jquery.sap.global","sap/ui/Device","sap/ui/core/ResizeHandler","sap/ovp/app/resources","sap/ovp/app/OVPUtils"],function(C,q,D,R,O,a){"use strict";var b=C.extend("sap.ovp.ui.DashboardLayout",{metadata:{designTime:true,library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},defaultAggregation:"content",events:{afterRendering:{},afterDragEnds:{}},properties:{dragAndDropRootSelector:{group:"Misc",type:"string"},dragAndDropEnabled:{group:"Misc",type:"boolean",defaultValue:true},debounceTime:{group:"Misc",type:"int",defaultValue:150}}},renderer:{render:function(r,c){var d=c.$().width();var e=sap.ui.getCore().getConfiguration().getRTL();var l=c.dashboardLayoutUtil.updateLayoutData(d?d:q(window).width());var f=c.dashboardLayoutUtil.getCards(l.colCount);function g(n){return n.getVisible();}function h(n){return n.id===this.getId().split("--")[1];}var i=c.getContent().filter(g);r.write("<div");r.writeControlData(c);r.addClass("sapUshellEasyScanLayout");if(!D.system.phone){r.addClass("sapOvpDashboardDragAndDrop");}r.addClass("sapOvpDashboard");r.writeClasses();e?r.addStyle("margin-right",l.marginPx+"px"):r.addStyle("margin-left",l.marginPx+"px");r.writeStyles();r.write(">");r.write("<div class='sapUshellEasyScanLayoutInner' role='list' aria-label='Cards'>");if(f.length>0){var j={},k,L,s,m=c.getDashboardLayoutModel().getColCount();for(k=0,L=i.length;k<L;k++){var S=['easyScanLayoutItemWrapper','sapOvpDashboardLayoutItem'];j=f.filter(h.bind(i[k]))[0];c.dashboardLayoutUtil.setCardCssValues(j);s=j.dashboardLayout.column+j.dashboardLayout.colSpan===m+1;if(s){j.dashboardLayout.colSpan===1?S.push('sapOvpNotResizableLeftRight'):S.push('sapOvpNotResizableRight');}if(j.template==='sap.ovp.cards.stack'||j.settings.stopResizing||!D.system.desktop){S.push('sapOvpDashboardLayoutItemNoDragIcon');}r.write("<div id='"+c.dashboardLayoutUtil.getCardDomId(j.id)+"' class='"+S.join(' ')+"' style='"+"; transform:translate3d("+j.dashboardLayout.left+" ,"+j.dashboardLayout.top+" ,0px)"+"; -ms-transform:translate3d("+j.dashboardLayout.left+" ,"+j.dashboardLayout.top+" ,0px)"+"; -moz-transform:translate3d("+j.dashboardLayout.left+" ,"+j.dashboardLayout.top+" ,0px)"+"; -webkit-transform:translate3d("+j.dashboardLayout.left+" ,"+j.dashboardLayout.top+" ,0px)"+"; height:"+j.dashboardLayout.height+"; width:"+j.dashboardLayout.width+";'"+" tabindex='0'; aria-setsize="+L+" aria-posinset="+(k+1));r.writeAccessibilityState(undefined,{role:"listitem"});r.write(">");r.renderControl(i[k]);r.write("</div>");}}r.write("</div>");r.write("<div class='after' tabindex='0'></div>");r.write("</div>");}},init:function(){this.data("sap-ui-fastnavgroup","true",true);this.oColumnLayoutData={};this.resizeHandlerId=this.initResizeHandler();var c=sap.ui.getCore().getComponent(this._sOwnerId);this.dashboardLayoutUtil=c.getDashboardLayoutUtil();this.dashboardLayoutUtil.setLayout(this);},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();delete this.layoutDragAndDrop;}},onBeforeRendering:function(){},onAfterRendering:function(){this.keyboardNavigation=new K(this);if(!this.getDragAndDropRootSelector()){this.setDragAndDropRootSelector("#"+this.getId());}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();}if(this.getDragAndDropEnabled()){this.layoutDragAndDrop=this.dashboardLayoutUtil.getRearrange({rootSelector:this.getDragAndDropRootSelector(),layout:this});this.fireAfterRendering();}},getLayoutDataJSON:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel().getLayoutVariants4Pers();},filterVisibleCards:function(e){return e.getVisible();},getDashboardLayoutUtil:function(){return this.dashboardLayoutUtil;},getDashboardLayoutModel:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel();},getVisibleLayoutItems:function(){var c=this.getContent();var f=c.filter(this.filterVisibleCards);return f;},initResizeHandler:function(){var r;var d=this.getDebounceTime();var c=function(e){window.clearTimeout(r);r=window.setTimeout(this.oControl.resizeHandler.bind(this,e),d);};return R.register(this,c);},resizeHandler:function(e){this.oControl.dashboardLayoutUtil.resizeLayout(e.size.width);},setActive:function(s){if(s){this.removeStyleClass("ovpOverlay");}else{this.addStyleClass("ovpOverlay");}},getActive:function(){return!this.hasStyleClass("ovpOverlay");}});var K=function(o){this.init(o);};K.prototype.init=function(o){this.layoutUtil=o.getDashboardLayoutUtil();this.layoutModel=o.getDashboardLayoutModel();this.keyCodes=q.sap.KeyCodes;this.jqElement=o.$();this.bIgnoreSelfFocus=false;this.sLastFocusableCard=null;this.jqElement.on('keydown',this.keyDownHandler.bind(this));this.jqElement.find(".sapUshellEasyScanLayoutInner").on("focus.keyboardNavigation",this.layoutFocusHandler.bind(this));this.jqElement.on("focus.keyboardNavigation",".easyScanLayoutItemWrapper",this.layoutItemFocusHandler.bind(this));q('body').on('keyup',this.bodyKeyupHandler.bind(this));q('body').on('keydown',this.bodyKeydownHandler.bind(this));q(".sapFDynamicPageContent").on("click",this.layoutClickHandler.bind(this));};K.prototype.spacebarHandler=function(e){a.bCRTLPressed=e.ctrlKey||e.metaKey;var i=sap.ui.getCore().byId(e.target.id);if(i&&i.mEventRegistry.hasOwnProperty('press')){q('#'+e.target.id).addClass('sapMLIBActive');q('#'+e.target.id+' span').css('color','#FFFFFF');i.firePress();}};K.prototype.bodyKeyupHandler=function(e){if(e.ctrlKey||e.metaKey){a.bCRTLPressed=false;}};K.prototype.bodyKeydownHandler=function(e){if(e.ctrlKey||e.metaKey){a.bCRTLPressed=true;}};K.prototype.layoutItemFocusHandler=function(){var j=q(document.activeElement);if(j){var l=j.find("[aria-label]");var i,s="";if(j.find('.valueStateText').length==1){var t=j.find('.valueStateText').find('.sapMObjectNumberText').text();var v=j.find('.valueStateText').find('.sapUiInvisibleText').text();j.find('.valueStateText').attr('aria-label',t+" "+v);j.find('.valueStateText').attr('aria-labelledby',"");}j.find("[role='listitem']").attr('aria-label',"");if(j.hasClass('easyScanLayoutItemWrapper')){var c="";var d=j.find('.cardCount');var e=O.getText("cardPositionInApp",[j.attr('aria-posinset'),j.attr('aria-setsize')]);if(d.length===0){c="countDiv_"+new Date().getTime();var f='<div id="'+c+'" class="cardCount" aria-label="'+e+'" hidden></div>';j.append(f);}else{c=d[0].id;d.attr('aria-label',e);}s+=c+" ";var o=j.find('.cardType');if(o.length!==0){s+=o[0].id+" ";}}if(j.hasClass('sapOvpCardHeader')&&!j.hasClass('sapOvpStackCardContent')){var g="";var h=j.find('.cardHeaderType');if(h.length===0){var k=O.getText("CardHeaderType");g="cardHeaderType_"+new Date().getTime();var m='<div id="'+g+'" class="cardHeaderType" aria-label="'+k+'" hidden></div>';j.append(m);}else{g=h[0].id;}s+=g+" ";}for(i=0;i<l.length;i++){if(l[i].getAttribute("role")==="heading"){s+=l[i].id+" ";}}if(j.hasClass('sapOvpCardHeader')){var n=j.find('.cardHeaderText');if(n.length!==0){for(var i=0;i<n.length;i++){if(s.indexOf(n[i].id)===-1){s+=n[i].id+" ";}}}}if(s.length){j.attr("aria-labelledby",s);}if(j.prop('nodeName')==="LI"&&j.find('.linkListHasPopover').length!==0){if(j.find('#hasDetails').length===0){j.append("<div id='hasDetails' hidden>"+O.getText("HAS_DETAILS")+"</div>");j.attr('aria-describedby',"hasDetails");}}var p=j.attr("id");if((p&&p.indexOf("ovpTable")!=-1)&&j.find("[role='Link']")&&!j.hasClass('sapUiCompSmartLink')){var r=j.closest("td").attr("data-sap-ui-column"),u=j.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<u.length;i++){if(u[i].getAttribute("data-sap-ui")==r&&u[i].hasChildNodes("span")){var w=u[i].firstElementChild.getAttribute("id");j.attr("aria-labelledby",w);}}}}};K.prototype.layoutFocusHandler=function(){if(this.sLastFocusableCard){this.sLastFocusableCard.focus();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;return;}this.jqElement.find(".easyScanLayoutItemWrapper").first().focus();this.sLastFocusableCard=this.jqElement.find(".easyScanLayoutItemWrapper").first();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;};K.prototype.layoutClickHandler=function(e){if(e&&e.target&&e.target.getAttribute("id")&&e.target.getAttribute("id").indexOf("mainView")!==-1){if(this.sLastFocusableCard){this.sLastFocusableCard.focus();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;return;}this.jqElement.find(".easyScanLayoutItemWrapper").first().focus();this.sLastFocusableCard=this.jqElement.find(".easyScanLayoutItemWrapper").first();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;}};K.prototype.ctrlArrowHandler=function(c,d){var o=this.layoutUtil.dashboardLayoutModel.getCardById(d),e=c.dashboardLayout.row,f=o.dashboardLayout.row,n=o.dashboardLayout.column,g=[],h;if(f>e&&o.dashboardLayout.rowSpan>=c.dashboardLayout.rowSpan){h=e+o.dashboardLayout.rowSpan;}else{h=f;}this.layoutUtil.dashboardLayoutModel._arrangeCards(c,{row:h,column:n},'drag',g);this.layoutUtil.dashboardLayoutModel._removeSpaceBeforeCard(g);this.layoutUtil._positionCards(this.layoutModel.aCards);this.layoutUtil.oLayoutCtrl.fireAfterDragEnds({positionChanges:g});};K.prototype.shiftArrowHandler=function(c,s,d){if(c.template==="sap.ovp.cards.stack"){return;}this.resizeStartHandler(c,d);var o=this.layoutUtil.calculateCardProperties(c.id),l=o.leastHeight+2*this.layoutUtil.CARD_BORDER_PX,L=Math.ceil(l/this.layoutUtil.getRowHeightPx());if(s.rowSpan<=L){s.rowSpan=L;s.showOnlyHeader=true;d.classList.add("sapOvpMinHeightContainer");}else{s.showOnlyHeader=false;d.classList.remove("sapOvpMinHeightContainer");}var r=this.layoutUtil.dashboardLayoutModel.resizeCard(c.id,s,true,this.layoutUtil.dragOrResizeChanges);this.resizeStopHandler(r.resizeCard,d);};K.prototype.resizeStartHandler=function(c,d){this.layoutUtil.dragOrResizeChanges=[];this.layoutUtil.resizeStartCard={cardId:c.id,rowSpan:c.dashboardLayout.rowSpan,colSpan:c.dashboardLayout.colSpan,maxColSpan:c.dashboardLayout.maxColSpan,noOfItems:c.dashboardLayout.noOfItems,autoSpan:c.dashboardLayout.autoSpan,showOnlyHeader:c.dashboardLayout.showOnlyHeader};d.classList.add('sapOvpCardResize');c.dashboardLayout.autoSpan=false;};K.prototype.resizeStopHandler=function(c,d){d.classList.remove('sapOvpCardResize');d.style.zIndex='auto';this.layoutUtil._sizeCard(c);this.layoutUtil._positionCards(this.layoutModel.aCards);c.dashboardLayout.maxColSpan=c.dashboardLayout.colSpan;this.layoutUtil.dragOrResizeChanges.push({changeType:"dragOrResize",content:{cardId:c.id,dashboardLayout:{rowSpan:c.dashboardLayout.rowSpan,oldRowSpan:this.layoutUtil.resizeStartCard.rowSpan,colSpan:c.dashboardLayout.colSpan,oldColSpan:this.layoutUtil.resizeStartCard.colSpan,maxColSpan:c.dashboardLayout.maxColSpan,oldMaxColSpan:this.layoutUtil.resizeStartCard.maxColSpan,noOfItems:c.dashboardLayout.noOfItems,oldNoOfItems:this.layoutUtil.resizeStartCard.noOfItems,autoSpan:c.dashboardLayout.autoSpan,oldAutoSpan:this.layoutUtil.resizeStartCard.autoSpan,showOnlyHeader:c.dashboardLayout.showOnlyHeader,oldShowOnlyHeader:this.layoutUtil.resizeStartCard.showOnlyHeader}},isUserDependent:true});this.layoutUtil.getDashboardLayoutModel().extractCurrentLayoutVariant();this.layoutUtil.oLayoutCtrl.fireAfterDragEnds({positionChanges:this.layoutUtil.dragOrResizeChanges});};K.prototype.keyDownHandler=function(e){var c=document.activeElement,s=this.layoutUtil.getCardId(c.id),d=q.extend([],this.layoutModel.aCards),o=this.layoutModel.getCardById(s),f=this.layoutModel.iColCount,t={},g,h,l,r,m,n,p,S,I=sap.ui.getCore().getConfiguration().getRTL(),u=q(document.activeElement);this.layoutModel._sortCardsByRow(d);for(var i=1;i<=f;i++){t[i]=[];}for(var j=0;j<d.length;j++){g=d[j].dashboardLayout.column;h=d[j].dashboardLayout.colSpan;if(h===1){t[g].push(d[j]);}else{for(var k=g;k<g+h;k++){t[k].push(d[j]);}}}r=this.getCardPosition(s,t[o.dashboardLayout.column]);switch(e.keyCode){case this.keyCodes.F6:if(e.shiftKey){this.bIgnoreSelfFocus=true;this.jqElement.find(".sapUshellEasyScanLayoutInner").focus();q.sap.handleF6GroupNavigation(e);}else{this.bIgnoreSelfFocus=true;var v=this.jqElement.scrollTop();this.jqElement.find(".after").focus();q.sap.handleF6GroupNavigation(e);this.jqElement.scrollTop(v);}break;case this.keyCodes.F7:e.preventDefault();if(u.hasClass("easyScanLayoutItemWrapper")){u.find(":sapTabbable").first().focus();}else{u.closest(".easyScanLayoutItemWrapper").focus();}break;case this.keyCodes.ARROW_UP:e.preventDefault();l=o.dashboardLayout.column;r--;m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(s);}else if(e.shiftKey){S={rowSpan:o.dashboardLayout.rowSpan-3,colSpan:o.dashboardLayout.colSpan};this.shiftArrowHandler(o,S,e.target);this.setFocusOnCard(s);}else{if(u&&u.hasClass("easyScanLayoutItemWrapper")){this.setFocusOnCard(m);}}break;case this.keyCodes.ARROW_DOWN:e.preventDefault();l=o.dashboardLayout.column;r++;m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(s);}else if(e.shiftKey){if((o.template==="sap.ovp.cards.linklist"&&o.settings.listFlavor==='carousel'&&o.dashboardLayout.rowSpan>=45)){return;}S={rowSpan:o.dashboardLayout.rowSpan+3,colSpan:o.dashboardLayout.colSpan};this.shiftArrowHandler(o,S,e.target);this.setFocusOnCard(s);}else{this.setFocusOnCard(m);}break;case this.keyCodes.ARROW_LEFT:var w=q(document.activeElement);if(!w.hasClass('easyScanLayoutItemWrapper')){return;}e.preventDefault();l=o.dashboardLayout.column;l--;if(!t[l]||!t[l][r]){do{if(l===0){l=f;r--;break;}if(r<0){break;}l--;}while(!t[l]||!t[l][r])}m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(s);}else if(e.shiftKey){if(I){if((o.template==="sap.ovp.cards.list"&&o.dashboardLayout.colSpan===2)||(o.template==="sap.ovp.cards.linklist"&&o.settings.listFlavor==='carousel'&&o.dashboardLayout.colSpan===3)){return;}S={rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan+1};}else{if(o.dashboardLayout.colSpan===1){return;}S={rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan-1};}this.shiftArrowHandler(o,S,e.target);this.setFocusOnCard(s);}else{this.setFocusOnCard(m);}break;case this.keyCodes.ARROW_RIGHT:e.preventDefault();l=o.dashboardLayout.column+o.dashboardLayout.colSpan;if(!t[l]||!t[l][r]){do{if(l>f){l=1;r++;break;}l++;}while(!t[l]||!t[l][r])}m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(s);}else if(e.shiftKey){if(I){if(o.dashboardLayout.colSpan===1){return;}S={rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan-1};}else{if((o.template==="sap.ovp.cards.list"&&o.dashboardLayout.colSpan===2)||(o.template==="sap.ovp.cards.linklist"&&o.settings.listFlavor==='carousel'&&o.dashboardLayout.colSpan===3)){return;}S={rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan+1};}this.shiftArrowHandler(o,S,e.target);this.setFocusOnCard(s);}else{this.setFocusOnCard(m);}break;case this.keyCodes.PAGE_UP:e.preventDefault();l=o.dashboardLayout.column;if(e.altKey==true){(l===1)?r=0:l=1;m=t[l][r]&&t[l][r].id;}else{n=t[l].length-1;for(var i=n;i>0;i--){p=document.getElementById(this.layoutUtil.getCardDomId(t[l][i].id));if(p.getBoundingClientRect().bottom<0){m=t[l][i].id;break;}}if(!m){m=t[l][0].id;}}this.setFocusOnCard(m);break;case this.keyCodes.PAGE_DOWN:e.preventDefault();l=o.dashboardLayout.column;if(e.altKey==true){m=(l+o.dashboardLayout.colSpan)>f?d[d.length-1].id:t[f][r]&&t[f][r].id;}else{var x=q(window).height();n=t[l].length;for(var i=0;i<n;i++){p=document.getElementById(this.layoutUtil.getCardDomId(t[l][i].id));if(p.getBoundingClientRect().top>x){m=t[l][i].id;break;}}if(!m){m=t[l][n-1].id;}}this.setFocusOnCard(m);break;case this.keyCodes.HOME:e.preventDefault();l=o.dashboardLayout.column;if(e.ctrlKey==true){(r===0)?l=1:r=0;}else{(l===1)?r=0:l=1;}m=t[l][r]&&t[l][r].id;this.setFocusOnCard(m);break;case this.keyCodes.END:e.preventDefault();l=o.dashboardLayout.column;if(e.ctrlKey==true){var y=t[l].length-1;m=(y===r)?d[d.length-1].id:t[l][y]&&t[l][y].id;}else{m=(l+o.dashboardLayout.colSpan)>f?d[d.length-1].id:t[f][r]&&t[f][r].id;}this.setFocusOnCard(m);break;case this.keyCodes.SPACE:case this.keyCodes.ENTER:this.spacebarHandler(e);break;default:break;}};K.prototype.setFocusOnCard=function(c){if(c){var d=document.getElementById(this.layoutUtil.getCardDomId(c));d&&d.focus();this.sLastFocusableCard=d;this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;}};K.prototype.getCardPosition=function(c,d){for(var i=0;i<d.length;i++){if(d[i].id===c){break;}}return i;};return b;});
