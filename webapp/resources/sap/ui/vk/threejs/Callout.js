/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./thirdparty/three","sap/ui/base/ManagedObject","../NS","./Billboard","../ve/thirdparty/html2canvas","./PolylineGeometry","./PolylineMaterial","./PolylineMesh","../BillboardStyle","../LeaderLineMarkStyle"],function(a,B,N,b,c,P,d,e,f,L){"use strict";var C=b.extend(N.getName("threejs.Callout"),{metadata:{properties:{anchorNode:{type:"any",defaultValue:null},depthTest:{type:"boolean",defaultValue:true}}}});C.prototype.init=function(){if(b.prototype.init){b.prototype.init.call(this);}this._lines=[];};C.prototype.setRenderOrder=function(h){b.prototype.setRenderOrder.call(this,h);this._lines.forEach(function(l){l.renderOrder=h;});return this;};C.prototype.setDepthTest=function(h){this.setProperty("depthTest",h,true);this._billboard.material.depthTest=h;this._lines.forEach(function(l){l.material.depthTest=h;});return this;};var g=new THREE.Vector4(),j=new THREE.Vector4(),k=new THREE.Vector4(),m=new THREE.Vector2(),n=new THREE.Vector2(),o=new THREE.Vector2(),q=new THREE.Quaternion(),r=new THREE.Matrix4(),u=new THREE.Vector2(),v=new THREE.Vector3(),w=new THREE.Vector3(),z=new THREE.Vector3(0,0,1),A=new THREE.Vector2(),D=new THREE.Matrix4(),E=new THREE.Matrix4();C.prototype._update=function(h,i,l){if(this._needUpdateTexture){this._needUpdateTexture=false;this._updateTexture();}var s=this.getNode();s.matrix.getInverse(s.parent.matrixWorld);s.matrix.decompose(s.position,s.quaternion,s.scale);s.matrixWorld.identity();var x=this.getPosition(),y=this._billboard.position;if(x){y.copy(x);}else{y.setScalar(0);}var F=this.getAnchorNode();if(F){y.applyMatrix4(F.matrixWorld);}this._billboard.quaternion.copy(i.quaternion);if(l){A.copy(l);}else{l=h.getSize();A.set(l.width,l.height);}D.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);g.copy(y).applyMatrix4(D);m.copy(g).multiplyScalar(1/g.w).multiply(A);var G=g.w*2/(A.x*i.projectionMatrix.elements[0]);this._billboard.scale.set(G*this._width,G*this._height,1);v.setFromMatrixColumn(i.matrixWorld,0).multiplyScalar(G*(Math.round(m.x*0.5)-m.x*0.5));w.setFromMatrixColumn(i.matrixWorld,1).multiplyScalar(G*(Math.round(m.y*0.5)-m.y*0.5));y.add(v).add(w);this._billboard.updateMatrixWorld();var H=this.getStyle()===f.CircularShape;var I=i.near;function J(p,t,K){if(p<t){return p-t;}else if(p>K){return p-K;}return 0;}this._lines.forEach(function(p){if(p.userData.targetNode){p.matrix.copy(p.userData.targetNode.matrixWorld);}else{p.matrix.identity();}p.matrixWorld.copy(p.matrix);if(p.isPolylineMesh){p.material.resolution.copy(A);}if(p.isHaloMesh){return;}var K=p.geometry.vertices;var M=K[0];var O=K[K.length-2];var Q=K[K.length-1];var R=p.userData.startPointMesh;var S=false;var T=[0,K.length-1];if(R!==undefined){M.copy(R.userData.targetVertex);}E.multiplyMatrices(D,p.matrixWorld);if(p.userData.extensionLength>0&&K.length>2){T.push(K.length-2);g.copy(K[K.length-3]).applyMatrix4(E);n.copy(g).multiplyScalar(1/g.w).multiply(A);O.set(Math.sign(n.x-m.x)*0.5*(1+p.userData.extensionLength/this._width),0,0);O.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}g.copy(O).applyMatrix4(E);n.copy(g).multiplyScalar(1/g.w).multiply(A);if(H){var U=u.copy(n).sub(m).length();S=U<this._width;u.multiplyScalar(0.5/U);Q.set(u.x,u.y,0);}else{var V=J(n.x,m.x-this._width,m.x+this._width),W=J(n.y,m.y-this._height,m.y+this._height);S=(V===0&&W===0);if(Math.abs(V)>Math.abs(W)){Q.set(Math.sign(V)*0.5,0,0);}else{Q.set(0,Math.sign(W)*0.5,0);}}if(S){Q.copy(O);}else{Q.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}p.geometry.verticesNeedUpdate=true;if(R!==undefined){R.position.copy(R.userData.targetVertex).applyMatrix4(p.matrixWorld);g.copy(R.position).applyMatrix4(D);var X=g.w/(A.x*i.projectionMatrix.elements[0]);R.scale.setScalar(X);R.visible=false;var Y=false;if(g.w>=I){j.copy(g);k.copy(K[1]).applyMatrix4(E);if(k.w<I){var t=(j.w-I)/(j.w-k.w);k.sub(j).multiplyScalar(t).add(j);}o.copy(j).multiplyScalar(1/j.w);n.copy(k).multiplyScalar(1/k.w);u.copy(n).sub(o).multiply(A);Y=u.length()<R.userData.lineOffset;q.setFromAxisAngle(z,Math.atan2(u.y,u.x));R.quaternion.copy(i.quaternion).multiply(q);R.matrix.compose(R.position,R.quaternion,R.scale);R.matrixWorld.copy(R.matrix);o.multiply(A).sub(m);R.visible=H?o.length()>this._width:Math.abs(o.x)>this._width||Math.abs(o.y)>this._height;if(Y||!R.visible){M.copy(K[1]);}else{M.set(R.userData.lineOffset,0,0).applyMatrix4(R.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}}}p.geometry._updateVertices(T);p.computeLineDistances(E,A,i instanceof THREE.PerspectiveCamera?I:undefined);if(p.userData.haloMesh){p.userData.haloMesh.material.lineLength=p.material.lineLength;}}.bind(this));};C.prototype._createMarkMesh=function(p,t,F,G){var H=F===L.Arrow;var I=window.devicePixelRatio;var J=t.width;var K=J*t.haloWidth;G=(Array.isArray(G)||G instanceof Float32Array)&&G.length===2?G:[1,1];var M,O;if(H){M=Math.max(35*G[0],J*5);O=Math.max(15*G[1],J*2);}else{M=O=Math.max(2*G[0],J*2);}M=Math.ceil(M+K*2);O=Math.ceil(O+K*2);var Q=document.createElement("canvas");Q.width=THREE.Math.ceilPowerOfTwo(M*I);Q.height=THREE.Math.ceilPowerOfTwo(O*I);var R=Q.getContext("2d");var x=M/2,y=O/2;R.fillStyle="#FFF";R.scale(I,I);if(H){R.beginPath();R.moveTo(0,y);R.lineTo(M,0);R.lineTo(M,O);R.closePath();R.fill();var h=M*y/Math.sqrt(M*M+y*y),s=(h-K)/h;var S=M-M*s,T=y*(M*s-K)/M;R.fillStyle=p.getStyle();R.beginPath();R.moveTo(S,y);R.lineTo(M-K,y-T);R.lineTo(M-K,y+T);R.closePath();R.fill();}else{var U=M*0.5,V=U-K;R.beginPath();R.ellipse(x,y,U,U,0,0,Math.PI*2);R.fill();R.fillStyle=p.getStyle();R.beginPath();R.ellipse(x,y,V,V,0,0,Math.PI*2);R.fill();}R.fillRect(M-K,y-J*0.5,K,J);var W=new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(Q),flatShading:true,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide,depthTest:this.getDepthTest()});var X=new THREE.PlaneBufferGeometry(M*2,O*2);if(H){X.translate(M,0,0);}var Y=new THREE.Mesh(X,W);Y.matrixAutoUpdate=false;Y.renderOrder=this.getRenderOrder();Y.userData.lineOffset=(H?M*2-1:M-K*2);var Z=new THREE.Vector2(M*I/Q.width,O*I/Q.height);var $=Y.geometry.attributes.uv.array;for(var i=0,l=$.length;i<l;i+=2){$[i]*=Z.x;$[i+1]=1-(1-$[i+1])*Z.y;}return Y;};C.prototype.addLeaderLine=function(h,t,i,s,l,p,x){var y=this.getNode();if(x>0&&h.length<3){h.push(h[h.length-1].clone());}var F=i.userData.lineStyle||{};F.width=F.width||1;F.haloWidth=F.haloWidth||0;F.endCapStyle=F.endCapStyle||0;var G=F.endCapStyle||h.length>2?1:0;var H=(G&&(s!==L.None||F.endCapStyle===0)?1:0)|(G&&(l!==L.None||F.endCapStyle===0)?2:0);var I=new P();I.setVertices(h);var J;if(F.haloWidth>0){var K=new d({color:0xFFFFFF,lineColor:0xFFFFFF,linewidth:F.width*(F.haloWidth*2+1),dashCapStyle:F.endCapStyle,segmentCapStyle:G,trimStyle:H,transparent:true,depthTest:this.getDepthTest()});J=new e(I,K);J.userData.targetNode=t;J.matrixAutoUpdate=false;J.renderOrder=this.getRenderOrder();J.isHaloMesh=true;y.add(J);this._lines.push(J);}var M=new d({color:0xFFFFFF,lineColor:i.color,linewidth:F.width,dashCapStyle:F.endCapStyle,segmentCapStyle:G,trimStyle:H,dashPattern:F.dashPattern||[],dashScale:F.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var O=new e(I,M);O.userData.targetNode=t;O.userData.extensionLength=x;O.userData.haloMesh=J;O.matrixAutoUpdate=false;O.renderOrder=this.getRenderOrder();y.add(O);this._lines.push(O);if(s!==L.None){var Q=this._createMarkMesh(i.color,F,s,p);Q.userData.targetVertex=I.vertices[0].clone();O.userData.startPointMesh=Q;y.add(Q);}return O;};return C;});
