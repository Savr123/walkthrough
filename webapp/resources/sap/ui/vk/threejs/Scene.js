/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../NS","../Scene","./NodeHierarchy","../RenderMode","./ThreeExtensions","./AnimationSequence"],function(q,N,S,c,R,T,A){"use strict";var d=S.extend(N.getName("threejs.Scene"),{metadata:{},constructor:function(a){S.call(this);this._id=q.sap.uid();this._scene=a;this._state=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map();this._initialView=null;this._materialMap=new Map();}});d.prototype.init=function(){var a=["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","	#include <begin_vertex>","	#include <project_vertex>","	#include <clipping_planes_vertex>","	vec3 eyeDirection = mvPosition.xyz;","	vec3 n1 = normalMatrix * normal1;","	vec3 n2 = normalMatrix * normal2;","	vColor = color;","	vColor.a *= step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n");var b=["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","	#include <clipping_planes_fragment>","	if (vColor.a < ALPHATEST) discard;","	gl_FragColor = vColor;","}"].join("\n");this._outlineColor=new THREE.Vector4(0,0,0,1);this._outlineMaterial=new THREE.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:a,fragmentShader:b,depthWrite:false,depthFunc:THREE.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:THREE.NormalBlending,alphaTest:0.01,clipping:true});this._solidWhiteMaterial=new THREE.MeshBasicMaterial({color:0xFFFFFF});};d.prototype.destroy=function(){if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null;}this._state=null;this._scene=null;this._animationSequenceMap.clear();S.prototype.destroy.call(this);};d.prototype.setDoubleSided=function(v){this.setProperty("doubleSided",v,true);this._scene.traverse(function(a){if(a.material!==undefined){var u=a.userData;var b=THREE.FrontSide;var e;if(u.originalMaterial){if(u.originalMaterial.userData===undefined){u.originalMaterial.userData={};}e=u.originalMaterial.userData;if(e.originalMaterialSide===undefined){e.originalMaterialSide=u.originalMaterial.side;}b=e.originalMaterialSide;}else{if(a.material.userData===undefined){a.material.userData={};}e=a.material.userData;if(e.originalMaterialSide===undefined){e.originalMaterialSide=a.material.side;}b=e.originalMaterialSide;}a.material.side=v?THREE.DoubleSide:b;}});return this;};d.prototype.setViewStateManager=function(v){this._currentViewStateManager=v;return this;};d.prototype.getViewStateManager=function(){return this._currentViewStateManager;};d.prototype.getId=function(){return this._id;};d.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new c(this);}return this._defaultNodeHierarchy;};d.prototype._computeBoundingBox=function(v,i){var b=new THREE.Box3();if(this._scene){this._scene._expandBoundingBox(b,v,i);}return b;};d.prototype.getSceneRef=function(){return this._scene;};d.prototype._setState=function(a){this._state=a;};d.prototype.nodeRefToPersistentId=function(a){var b=this._state;if(Array.isArray(a)){if(!b){return[];}var i=[];a.forEach(function(e){i.push(b.object3DToSid(e));});return i;}else{if(!b){return null;}return b.object3DToSid(a);}};d.prototype.persistentIdToNodeRef=function(a){var b=this._state;if(Array.isArray(a)){if(!b){return[];}var e=[];a.forEach(function(i){e.push(b.sidToObject3D(i));});return e;}else{if(!b){return null;}return b.sidToObject3D(a);}};d.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[];}var a=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(a){return a.enumerateMaterials(true);}else{return[];}};var f=0;function g(a,b){var e=a.x-b.x;if(e<-f){return true;}if(e>f){return false;}var i=a.y-b.y;if(i<-f){return true;}if(i>f){return false;}return a.z-b.z<-f;}function h(a,b,e){if(b<e){var i=p(a,b,e);h(a,b,i-1);h(a,i+1,e);}return a;}function p(a,b,e){var j=a[e],l=b;for(var i=b;i<e;i++){if(g(a[i],j)){s(a,i,l);l++;}}s(a,e,l);return l;}function s(a,i,j){if(i!=j){var b=a[i];a[i]=a[j];a[j]=b;}}var k=new THREE.Vector3();function m(a){a.computeBoundingBox();a.boundingBox.getSize(k);f=Math.max(k.x,k.y,k.z)*1e-4;var v=a.vertices,b=v.length,e=a.faces.length;if(b===0||e===0){return;}var i,j;for(i=0;i<b;i++){v[i].index=i;}h(v,0,v.length-1);var u=[],l=[];u.push(v[0]);l[v[0].index]=u.length-1;for(i=1;i<b;i++){if(g(u[u.length-1],v[i])){u.push(v[i]);}l[v[i].index]=u.length-1;}a.vertices=u;for(i=0,e=a.faces.length,j=0;i<e;i++){var w=a.faces[i];var x=a.faces[j];x.a=l[w.a];x.b=l[w.b];x.c=l[w.c];if(x.a!==x.b&&x.b!==x.c&&x.c!==x.a){j++;}}a.faces.length=j;}function O(a,b){THREE.BufferGeometry.call(this);this.type="OutlineGeometry";var u=Math.cos(THREE.Math.DEG2RAD*((b!==undefined)?b:1));var w={},x,y;var z,B=["a","b","c"];var v=new THREE.Vector3();var C;if(a.isBufferGeometry){C=new THREE.Geometry();C.fromBufferGeometry(a);}else{C=a.clone();}m(C);C.computeFaceNormals();var D=C.vertices;var E=C.faces;for(var F=0,l=E.length;F<l;F++){var G=E[F];for(var i=0,j=2;i<3;j=i++){x=G[B[j]];y=G[B[i]];z=Math.min(x,y)+","+Math.max(x,y);if(w[z]===undefined){w[z]={index1:x,index2:y,face1:F,face2:undefined};}else{w[z].face2=F;}}}var H=[];var I=[];var J=[];for(z in w){var e=w[z];if(e.face2===undefined||(E[e.face1].normal.dot(E[e.face2].normal)<=u&&v.copy(D[e.index2]).sub(D[e.index1]).cross(E[e.face1].normal).dot(E[e.face2].normal)>0)){var K=D[e.index1];H.push(K.x,K.y,K.z);K=D[e.index2];H.push(K.x,K.y,K.z);var L=E[e.face1].normal;I.push(L.x,L.y,L.z);I.push(L.x,L.y,L.z);if(e.face2!==undefined){var M=E[e.face2].normal;J.push(M.x,M.y,M.z);J.push(M.x,M.y,M.z);}else{J.push(0,0,0);J.push(0,0,0);}}}this.addAttribute("position",new THREE.Float32BufferAttribute(H,3));this.addAttribute("normal1",new THREE.Float32BufferAttribute(I,3));this.addAttribute("normal2",new THREE.Float32BufferAttribute(J,3));}O.prototype=Object.create(THREE.BufferGeometry.prototype);O.prototype.constructor=O;function n(b){return(b===null)||(b.min.x>=b.max.x&&b.min.y>=b.max.y&&b.min.z>=b.max.z);}function o(a){var b=null;if(a.isMesh&&a.geometry&&!n(a.geometry.boundingBox)&&(a.name||a.children.length>0)){b=a.geometry;if(b.isBufferGeometry){b=new THREE.Geometry().fromBufferGeometry(b);}}for(var i=0,l=a.children.length;i<l;i++){var e=a.children[i];if(e.isMesh&&e.geometry&&!n(e.geometry.boundingBox)&&!e.name&&e.children.length===0){if(b===null){b=new THREE.Geometry();}var j=e.geometry;if(j.isBufferGeometry){j=new THREE.Geometry().fromBufferGeometry(j);}b.merge(j,e.matrix);}}return b;}function r(a,b){var u=a.userData;if(u.defaultMaterial===undefined){u.defaultMaterial=u.originalMaterial||a.material;}a.material=b;u.originalMaterial=null;a._vkUpdateMaterialColor();a._vkUpdateMaterialOpacity();}function t(a){var u=a.userData;if(u.defaultMaterial){a.material=u.defaultMaterial;delete u.defaultMaterial;u.originalMaterial=null;a._vkUpdateMaterialColor();a._vkUpdateMaterialOpacity();}}d.prototype._createOutlineGeometry=function(a){if(this._scene){this._scene._vkTraverseMeshNodes(function(b){if(b.isOutline){b.visible=true;}else{if(!b.hasOutline){var e=o(b);if(e!==null){b.hasOutline=true;var i=new O(e);i.boundingBox=new THREE.Box3();var l=new THREE.LineSegments(i,this._outlineMaterial);l.isOutline=true;l.renderOrder=b.renderOrder+0.5;b.add(l);}}if(b.isMesh&&b.material&&!b.material.isLineBasicMaterial&&!b.material.isLineMaterial){switch(a){case R.LineIllustration:r(b,this._solidWhiteMaterial);break;case R.ShadedIllustration:var j=(b.userData.defaultMaterial||b.userData.originalMaterial||b.material).clone();if(j.emissive){j.color.multiplyScalar(0.5);j.emissive.multiplyScalar(0.5).addScalar(0.5);}else{j.color.multiplyScalar(0.5).addScalar(0.5);}r(b,j);break;default:t(b);break;}}}}.bind(this));}};d.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(a){if(a.isOutline){a.visible=false;}if(a.isMesh){t(a);}});}};d.prototype.createAnimationSequence=function(i,a,b){var e=new A(i,a,b);this._animationSequenceMap.set(i,e);return e;};d.prototype.getAnimationSequence=function(i){var a=this._animationSequenceMap.get(i);return a;};d.prototype.getInitialView=function(){return this._initialView;};d.prototype.setInitialView=function(v){this._initialView=v;};d.prototype.getMaterial=function(a){return this._materialMap.get(a);};d.prototype.setMaterial=function(a,b){this._materialMap.set(a,b);};d.prototype.clearMaterials=function(){this._materialMap.clear();};return d;});
