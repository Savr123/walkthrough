/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","../NS","../TransformationMatrix"],function(E,N,T){"use strict";var a=E.extend(N.getName("threejs.NodesTransitionHelper"),{metadata:{properties:{},publicMethods:["setViewport","setNodeForDisplay","setDisappearingNode","setAppearingNode","clear","startDisplay","displayNodesMoving"],events:{displaying:{},displayed:{}}}});a.prototype.init=function(){this._viewport=null;this._nodeLocalmMatrixMap=new Map();this._nodeLocalMatrixMapForVisibility=new Map();this._timeIntervalForDisplay=500;this._startTimeForDisplay=0;};a.prototype.destroy=function(){this._viewport=null;this._nodeLocalmMatrixMap=null;this._nodeLocalMatrixMapForVisibility=new Map();};a.prototype.setViewport=function(v){this._viewport=v;};a.prototype.setNodeForDisplay=function(n){this._nodeLocalmMatrixMap.set(n,{oldMatrix:n.getLocalMatrix(),newMatrix:null});};a.prototype.setDisappearingNode=function(n){var o=n.getLocalMatrix();var b=[o[0]*0.0001,o[1],o[2],o[3],o[4]*0.0001,o[5],o[6],o[7],o[8]*0.0001,o[9],o[10],o[11]];this._nodeLocalMatrixMapForVisibility.set(n,{oldMatrix:o,newMatrix:b,visible:false});var c=n.getNodeRef();c.visible=true;};a.prototype.setAppearingNode=function(n){var o=n.getLocalMatrix();var b=[o[0]*0.0001,o[1],o[2],o[3],o[4]*0.0001,o[5],o[6],o[7],o[8]*0.0001,o[9],o[10],o[11]];this._nodeLocalMatrixMapForVisibility.set(n,{oldMatrix:b,newMatrix:o,visible:true});};a.prototype._interpolateNodePositionForVisibility=function(n,d,i){this._interpolateNodePosition(n,d.oldMatrix,d.newMatrix,i);if(i>=1){var b=n.getNodeRef();b.visible=d.visible;if(!b.visible){n.setLocalMatrixNotUpdatingBBox(d.oldMatrix);}}};a.prototype._interpolateNodePosition=function(n,o,b,i){var c=new THREE.Matrix4().fromArray(T.convertTo4x4(o));var d=new THREE.Vector3();var e=new THREE.Quaternion();var f=new THREE.Vector3();c.decompose(d,e,f);var g=new THREE.Matrix4().fromArray(T.convertTo4x4(b));var h=new THREE.Vector3();var j=new THREE.Quaternion();var k=new THREE.Vector3();g.decompose(h,j,k);var p=new THREE.Vector3().lerpVectors(d,h,i);var q=new THREE.Quaternion().copy(e).slerp(j,i);var s=new THREE.Vector3().lerpVectors(f,k,i);var t=new THREE.Matrix4().compose(p,q,s);n.setLocalMatrixNotUpdatingBBox(T.convertTo4x3(t.elements));};a.prototype.startDisplay=function(t){if(this._nodeLocalmMatrixMap.size===0){return;}this._timeIntervalForDisplay=t!==undefined?t:500;this._startTimeForDisplay=Date.now();this._nodeLocalmMatrixMap.forEach(function(m,n){m.newMatrix=n.getLocalMatrix();});this.fireDisplaying();};a.prototype.displayNodesMoving=function(){if(this._startTimeForDisplay===0||this._nodeLocalmMatrixMap===null||this._nodeLocalmMatrixMap.size===0){return;}var i=Math.min((Date.now()-this._startTimeForDisplay)/this._timeIntervalForDisplay,1);i=1-Math.pow(1-i,3);this._nodeLocalmMatrixMap.forEach(function(m,n){if(n&&m.oldMatrix&&m.newMatrix){this._interpolateNodePosition(n,m.oldMatrix,m.newMatrix,i);}}.bind(this));this._nodeLocalMatrixMapForVisibility.forEach(function(d,n){if(n&&d){this._interpolateNodePositionForVisibility(n,d,i);}}.bind(this));if(i===1){this.clear();this.fireDisplayed();}this._viewport.setShouldRenderFrame();};a.prototype.clear=function(){this._nodeLocalmMatrixMap.clear();this._nodeLocalMatrixMapForVisibility.clear();this._startTimeForDisplay=0;};return a;});
