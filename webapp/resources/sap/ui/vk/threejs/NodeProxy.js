/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NS","../NodeProxy","./Material","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","../TransformationMatrix","./ThreeExtensions","../ObjectType"],function(N,a,M,b,d,e,f,T,g,O){"use strict";var h=a.extend(N.getName("threejs.NodeProxy"),{metadata:{},constructor:function(n,o){a.call(this);this._object3D=o;this._nodeHierarchy=n;}});h.prototype.destroy=function(){this._object3D=null;a.prototype.destroy.call(this);};h.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};h.prototype.getNodeRef=function(){return this._object3D;};h.prototype.getNodeId=function(){return this._object3D;};h.prototype.getVeId=function(){if(this._object3D.userData.treeNode){return this._object3D.userData.treeNode.sid;}else{return null;}};h.prototype.getMaterialId=function(){var r=this._object3D;if(this._object3D&&!this._object3D.geometry){if(this._object3D.children.length===1&&this._object3D.children[0].geometry&&(this._object3D.children[0].name===""||this._object3D.children[0].name===undefined)){r=this._object3D.children[0];}}if(r.material!==undefined&&r.material.userData!==undefined&&r.material.userData.materialId!==undefined){return r.material.userData.materialId;}else if(r.userData.originalMaterial!==undefined&&r.userData.originalMaterial.userData!==undefined&&r.userData.originalMaterial.userData.materialId!==undefined){return r.userData.originalMaterial.userData.materialId;}return undefined;};h.prototype.getName=function(){return this._object3D.name||("<"+this._object3D.type+">");};h.prototype._updateAncestorsBoundingBox=function(){var p=this._object3D.parent;while(p){if(p.userData.boundingBox!==undefined){p._vkCalculateObjectOrientedBoundingBox();}p=p.parent;}};h.prototype.getLocalMatrix=function(){return T.convertTo4x3(this._object3D.matrix.elements);};h.prototype.setLocalMatrix=function(v){if(v){var o=this._object3D;o.matrix.fromArray(T.convertTo4x4(v));o.matrix.decompose(o.position,o.quaternion,o.scale);o.updateMatrixWorld(true);this._updateAncestorsBoundingBox();}this.setProperty("localMatrix",v,true);return this;};h.prototype.setLocalMatrixNotUpdatingBBox=function(v){if(v){var o=this._object3D;o.matrix.fromArray(T.convertTo4x4(v));o.matrix.decompose(o.position,o.quaternion,o.scale);o.updateMatrixWorld(true);}this.setProperty("localMatrix",v,true);return this;};h.prototype.getWorldMatrix=function(){return T.convertTo4x3(this._object3D.matrixWorld.elements);};h.prototype.setWorldMatrix=function(v){if(v){var o=this._object3D;o.matrixWorld.fromArray(T.convertTo4x4(v));if(o.parent){o.matrix.multiplyMatrices(new THREE.Matrix4().getInverse(o.parent.matrixWorld),o.matrixWorld);}else{o.matrix.copy(o.matrixWorld);}o.matrix.decompose(o.position,o.quaternion,o.scale);o.updateMatrixWorld(true);this._updateAncestorsBoundingBox();}this.setProperty("worldMatrix",v,true);return this;};h.prototype.getOpacity=function(){return this._object3D.userData.opacity;};h.prototype.setOpacity=function(v){var c=this._nodeHierarchy.getScene().getViewStateManager();if(c){c.setOpacity(this._object3D,v);}else{this._object3D._vkSetOpacity(v);}this.setProperty("opacity",v,true);return this;};h.prototype.getTintColorABGR=function(){return this._object3D.userData.tintColor;};h.prototype.setTintColorABGR=function(v){var c=this._nodeHierarchy.getScene().getViewStateManager();if(c){c.setTintColor(this._object3D,v);}else{this._object3D._vkSetTintColor(v);}this.setProperty("tintColorABGR",v,true);this.setProperty("tintColor",d(e(v)),true);return this;};h.prototype.getTintColor=function(){return d(e(this._object3D.userData.tintColor));};h.prototype.setTintColor=function(v){var c=f(b(v));var i=this._nodeHierarchy.getScene().getViewStateManager();if(i){i.setTintColor(this._object3D,c);}else{this._object3D._vkSetTintColor(c);}this.setProperty("tintColorABGR",c,true);this.setProperty("tintColor",v,true);return this;};h.prototype.getNodeMetadata=function(){return this._object3D.userData.metadata;};h.prototype.getHasChildren=function(){return this._object3D.children.length>0;};h.prototype.getClosed=function(){return!!this._object3D.userData.closed;};h.prototype.assignMaterial=function(v){var s=function(m,n){var i;if(m.userData){i=m.userData.materialId;n.userData.materialId=i;}if(n.material!==undefined){if(n.userData.highlightColor!==undefined){if(n.userData.originalMaterial.side){m.side=n.userData.originalMaterial.side;}n.userData.originalMaterial=m;m.userData.materialUsed++;n.material=m.clone();var c=e(n.userData.highlightColor);n.material.color.lerp(new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0),c.alpha);if(m.userData.defaultHighlightingEmissive){n.material.emissive.copy(m.userData.defaultHighlightingEmissive);}if(m.userData.defaultHighlightingSpecular){n.material.specular.copy(m.userData.defaultHighlightingSpecular);}}else{if(n.material.side){m.side=n.material.side;}n.material=m;m.userData.materialUsed++;delete n.userData.originalMaterial;}if(n.userData.opacity){if(!n.userData.originalMaterial){n.userData.originalMaterial=m;n.material=m.clone();}n.material.opacity*=n.userData.opacity;n.material.transparent=n.material.opacity<0.99;}}};s(v.getMaterialRef(),this._object3D);if(!this._object3D.children){return this;}this._object3D.children.forEach(function(c){if(!c||c.userData.objectType===O.PMI||c.userData.objectType===O.Hotspot){return;}s(v.getMaterialRef(),c);});return this;};h.prototype.enumerateMaterials=function(r){var c=function(n,o,r){if(n){if(n.userData.originalMaterial){o.add(n.userData.originalMaterial);}else if(n.material){o.add(n.material);}if(n.children){n.children.forEach(function(p){if(p){if(r){c(p,o,r);}else if(p.userData.originalMaterial){o.add(p.userData.originalMaterial);}else if(p.material){o.add(p.material);}}});}}};var m=new Set();c(this._object3D,m,r);var j=[];m.forEach(function(v){j.push(v);});var k=[];for(var i=0;i<j.length;i++){var l=new M();l.setMaterialRef(j[i]);k.push(l);}return k;};h.prototype.replaceMaterial=function(m,c){var i=m.getMaterialRef();var j=c.getMaterialRef();if(this._object3D.userData.originalMaterial&&this._object3D.userData.originalMaterial===i){this._object3D.userData.originalMaterial=j;}else if(this._object3D.material&&this._object3D.material===i){this._object3D.material=j;}if(!this._object3D.children){return this;}this._object3D.children.forEach(function(k){if(k&&k.userData.originalMaterial&&k.userData.originalMaterial===i){k.userData.originalMaterial=j;}else if(k&&k.material&&k.material===i){k.material=j;}});return this;};h.prototype.getLocalTranslate=function(){var o=this._object3D;return[o.position.x,o.position.y,o.position.z];};h.prototype.getLocalScale=function(){var o=this._object3D;return[o.scale.x,o.scale.y,o.scale.z];};h.prototype.getLocalRotationInQuaternion=function(){var o=this._object3D;return[o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w];};h.prototype.getLocalRotationInAngleAxis=function(){var o=this._object3D;var q=o.quaternion;if(q.w>1){q.normalise();}var c=2*Math.acos(q.w);var s=Math.sqrt(1-q.w*q.w);var x,y,z;if(s<0.001){x=q.x;y=q.y;z=q.z;}else{x=q.x/s;y=q.y/s;z=q.z/s;}return[x,y,z,c];};h.prototype.getLocalRotationInEuler=function(){var o=this._object3D;var q=o.quaternion;if(q.w>1){q.normalise();}var c=26;var t=q.x*q.y+q.z*q.w;var i,j,k;if(t>0.499){i=2*Math.atan2(q.x,q.w);j=Math.PI/2;k=0;}if(t<-0.499){i=-2*Math.atan2(q.x,q.w);j=-Math.PI/2;k=0;}else{var s=q.x*q.x;var l=q.y*q.y;var m=q.z*q.z;i=Math.atan2(2*q.y*q.w-2*q.x*q.z,1-2*l-2*m);j=Math.asin(2*t);k=Math.atan2(2*q.x*q.w-2*q.y*q.z,1-2*s-2*m);}return[i,j,k,c];};return h;});
