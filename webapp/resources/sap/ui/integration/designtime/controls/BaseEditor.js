/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/base/util/ObjectPath","./Config","sap/base/util/merge","sap/base/util/deepClone","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(C,O,a,m,d,J,B){"use strict";var b=C.extend("sap.ui.integration.designtime.controls.BaseEditor",{metadata:{properties:{"config":{type:"object"},"json":{type:"object",multiple:false}},aggregations:{"propertyEditors":{type:"sap.ui.core.Control"}},associations:{},events:{jsonChanged:{type:"object"}}},exit:function(){this._cleanup();if(this._oMergedConfig){this._oMergedConfig.destroy();}},renderer:function(r,e){r.write("<div");r.writeElementData(e);r.addClass("sapUiIntegrationEditor");r.writeClasses();r.writeStyles();r.write(">");e.getPropertyEditors().forEach(function(p){r.renderControl(p);});r.write("</div>");},setConfig:function(c){var r=this.setProperty("config",c,false);this._initialize();return r;},setJson:function(j){if(typeof j==="string"){j=JSON.parse(j);}var r=this.setProperty("json",j,false);this._initialize();return r;}});b.prototype._cleanup=function(c){if(this._oContextModel){this._oContextModel.destroy();}if(this._oPropertiesModel){this._oPropertiesModel.destroy();}this.destroyPropertyEditors();};b.prototype._initialize=function(){this._cleanup();var M=this._mergeConfig();this._createModels(M);this._createEditors(M);};b.prototype._mergeConfig=function(){if(this._oMergedConfig){this._oMergedConfig.setData(this.getConfig());}else{this._oMergedConfig=new a({data:this.getConfig()});}return d(this._oMergedConfig.getData());};b.prototype._syncPropertyValue=function(p){var c=this._oContextModel.getData();if(c&&p.path){p.value=O.get(p.path.split("/"),c);}if(typeof p.value==="undefined"){p.value=p.defaultValue;}};b.prototype._createModels=function(c){var o=this.getJson();if(c.context){o=O.get(c.context.split("/"),o);}this._oContextModel=new J(o);this._oContextModel.setDefaultBindingMode(B.OneWay);c.properties=Object.keys(c.properties).map(function(p){var P=c.properties[p];P.name=p;if(P.path){this._syncPropertyValue(P);}return P;}.bind(this));this._oPropertiesModel=new J(c.properties);this._oPropertiesModel.setDefaultBindingMode(B.OneWay);};b.prototype._createEditors=function(c){var t=Object.keys(c.propertyEditors);var M=t.map(function(T){return c.propertyEditors[T];});var e={};sap.ui.require(M,function(){Array.from(arguments).forEach(function(E,i){e[t[i]]=E;});for(var i=0;i<c.properties.length;i++){var p=this._oPropertiesModel.getContext("/"+i);var E=e[p.getObject().type];if(E){this._createPropertyEditor(E,p);}}}.bind(this));};b.prototype._createPropertyEditor=function(E,p){var P=new E({visible:typeof p.getObject().visible!==undefined?p.getObject().visible:true});P.setModel(this._oPropertiesModel);P.setBindingContext(p);P.setModel(this._oContextModel,"context");P.attachPropertyChanged(this._onPropertyChanged.bind(this));this.addPropertyEditor(P);};b.prototype._onPropertyChanged=function(e){this._oContextModel.setProperty("/"+e.getParameter("path"),e.getParameter("value"));var p;var i=this._oPropertiesModel.getData().findIndex(function(f){if(f.path===e.getParameter("path")){p=f;return true;}});if(i!==-1){this._syncPropertyValue(p);this._oPropertiesModel.checkUpdate();}this.fireJsonChanged({json:d(this.getJson())});};return b;});
