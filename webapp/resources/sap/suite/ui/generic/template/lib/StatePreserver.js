sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log"],function(B,t,L){"use strict";var c=(sap&&sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getService("CrossApplicationNavigation"):(function(){var r=jQuery.Deferred();r.resolve(Object.create(null));return{createEmptyAppState:function(){return{getKey:function(){return"";},setData:jQuery.noop,save:function(){return Promise.resolve();}};},getAppState:function(){return r;}};})();t.testableStatic(function setCrossAppNavService(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var r="";var I=false;var a=Promise.resolve();var n=null;var A=false;var S=null;var b=null;var l,d;var C=Object.create(null);var o={};var e={};function f(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}f();function h(i){f();for(var K in i){var J=jQuery.extend(true,{},i[K]);C.allEntries[K]=J;var M=J.lifecycle||Object.create(null);if(M.permanent){C.permanentEntries[K]=J;}else if(M.session){C.sessionEntries[K]=J;}if(M.page||M.pagination){C.pageEntries[K]=J;}}return C;}function m(i,P){if(P===i){return;}var N=P.next.next;P.next.next=i.next;i.next=P.next;P.next=N;}function j(i,J,P){if(jQuery.isEmptyObject(J)){return{appStateKey:""};}var K=JSON.stringify(J);var M=0;var N;for(N=i;N.next&&M<10;M++){if(N.next.serialize===K){m(i,N);return{appStateKey:i.next.appStateKey};}N=N.next;}N.next=null;var O=c.createEmptyAppState(s.oComponent.getAppComponent(),!P);var Q={next:i.next,serialize:K,appStateKey:O.getKey()};O.setData(J);O.save();i.next=Q;return{appStateKey:Q.appStateKey};}function k(){var i=j(e,C.sessionEntries,false);var J=Object.create(null);if(i.appStateKey){J.sessionAppStateKey=i.appStateKey;}if(!jQuery.isEmptyObject(C.permanentEntries)){J.permanentEntries=C.permanentEntries;}S=j(o,J,true);A=false;if(b===S.appStateKey){S=null;}else{T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey);}}function p(){if(!A){return;}var i=s.getCurrentState()||Object.create(null);h(i);k();}function q(){var J=T.componentRegistry[s.oComponent.getId()];var K=J.aKeys;var M="";var N=J.route;for(var i=K.length-1;i>0;i--){var O=T.mRoutingTree[N];var P=i===1?O.entitySet:O.navigationProperty;M="/"+P+(K[i]?"("+K[i]+")":"")+M;N=O.parentRoute;}return M;}function u(P,i){return a.then(function(){var J=Object.create(null);var K=(!P||q()===P)&&l;if(K){J[s.appStateName]=K;}return J;});}function v(){if(I){return;}if(!A){A=true;if(n){p();}else{setTimeout(p,0);}}}function w(i){r=i;S=null;l=i;}function x(i,J,U){if(!J){return;}for(var K in J){var M=J[K];if(U||M.lifecycle.page){i[K]=M;}}}function R(i,J,N){h(N);var K=Object.create(null);for(var M in N){K[M]=N[M].data;}s.applyState(K,i);if(n){n();n=null;}w(J);k();}function y(i,J,K){for(var M=i;M.next;M=M.next){if(M.next.appStateKey===K){m(i,M);return;}}var N={next:i.next,serialize:JSON.stringify(J),appStateKey:K};i.next=N;}function z(i,J,K,M,N,P,O,Q){if(I){J();return;}if(b===null){b=K;}else if(K!==b){J();return;}if(Q){var U=Q.getData();y(e,U,O);x(N,U,true);}x(N,P,true);R(M,b,N);i();}function D(i,J,K,M,N,O){var P=O.getData();y(o,P,K);if(P.sessionAppStateKey){var Q=c.getAppState(s.oComponent.getAppComponent(),P.sessionAppStateKey);Q.done(z.bind(null,i,J,K,M,N,P.permanentEntries,P.sessionAppStateKey));Q.fail(z.bind(null,i,J,K,M,N,P.permanentEntries,"",null));}else{z(i,J,K,M,N,P.permanentEntries,"",null);}}function E(i){var J=T.componentRegistry[s.oComponent.getId()];var K=J.utils.getHeaderDataAvailablePromise()||Promise.resolve();return K.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(d,i,J.viewLevel===1);});}function F(i,J){var K=new Promise(function(M,N){E(i).then(function(O){d=i;var P=Object.create(null);x(P,C[O?"allEntries":"pageEntries"],O||J);if(b===r||!b){if(b||O){x(P,C.sessionEntries,true);x(P,C.permanentEntries,true);}R(O,b,P);M();return;}if(!n){a=new Promise(function(U){n=U;});}var Q=c.getAppState(s.oComponent.getAppComponent(),b);Q.done(D.bind(null,M,N,b,O,P));Q.fail(N);},N);});return K;}function G(i){b=i[s.appStateName]||"";if(jQuery.isArray(b)){b=b.sort()[0]||"";}if(S){if(S.appStateKey!==b){L.error("StatePreserver: Got AppstateKey "+b+" expected "+S.appStateKey);return false;}w(b);return true;}return false;}function H(){return{isStateChange:G};}return{getUrlParameterInfo:u,stateChanged:v,applyAppState:F,getAsStateChanger:H};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){jQuery.extend(this,g(T,s));}});});
