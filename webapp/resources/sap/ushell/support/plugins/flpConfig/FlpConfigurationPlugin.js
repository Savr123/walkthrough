// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/support/Plugin","sap/ui/model/json/JSONModel","sap/m/Button","sap/m/IconTabBar","sap/m/IconTabFilter","sap/m/Label","sap/m/Text","sap/m/MessageStrip","sap/m/FlexBox","sap/ui/model/resource/ResourceModel","sap/m/SearchField","sap/m/MessageBox","sap/base/util/isEmptyObject","sap/ui/table/library"],function(P,J,B,I,a,L,T,M,F,R,S,b,c,t){"use strict";var d=t.SelectionMode;var e=this,o,f=P.extend("sap.ushell.support.plugins.flpConfig.FlpConfigurationPlugin",{constructor:function(s){o=new R({bundleName:"sap/ushell/support/plugins/flpConfig/i18n/FlpConfigurationPlugin"});P.apply(this,["sapUiFlpConfigurationPlugin",o.getResourceBundle().getText("PLUGIN_NAME"),s]);this._oSupportStub=s;if(this.runsAsToolPlugin()){e=this;this._aEventIds=[this.getId()+"ReceiveData"];}else{this._aEventIds=[this.getId()+"RequestData"];}}});f.prototype.isToolPlugin=function(){return true;};f.prototype.isAppPlugin=function(){return true;};f.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){var i;setTimeout(function(){e.requestData();},500);i=sap.ui.getCore().createRenderManager();i.write("<div id='"+this.getId()+"'</div>").flush(this.$().get(0));i.destroy();}else{}};f.prototype.exit=function(){P.prototype.exit.apply(this,arguments);};f.prototype.requestData=function(){this._oSupportStub.sendEvent(this.getId()+"RequestData",{eventData:{data:{}}});};f.prototype.onsapUiFlpConfigurationPluginRequestData=function(E){var i={};this.prepareForSending(window["sap-ushell-config"],i);this._oSupportStub.sendEvent(this.getId()+"ReceiveData",{eventData:{data:i}});};f.prototype.onsapUiFlpConfigurationPluginReceiveData=function(E){var e=this;this.flpConfig=E.getParameter("eventData").data;sap.ui.getCore().loadLibraries(["sap.ui.table"],{async:true}).then(function(){sap.ui.require(["sap/ui/table/TreeTable","sap/ui/table/Column"],function(i,C){e.getFlpConfigurationPluginUI(null,i,C);});});};function _(){var H=0,s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey(),i=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();if(Array.isArray(i[s])){i[s].forEach(function(j,k){var u=h(i[s][k],s);if(H<u){H=u;}});if(H>0){sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).expandToLevel(H-1);}else{b.error(new L({text:sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("i18n").getResourceBundle().getText("MISSING_HIERARCHY_LEVEL")}));}}}function g(){var s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey();sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).collapseAll();}f.prototype.onPressSearchNewModel=function(E){var s,u,v,A,w,x,y,z,V,C=[],D={},G="",H={},K={},N=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("Full"),O=E.getParameter("query");if(!N){N=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();}else{N=N.getData();}Object.keys(N).forEach(function(Q){D[Q]=0;});if(O){for(var Q in N){G=Q;s=[];q(N[Q],Q,G,s,O);K[Q]=s;}Object.keys(K).forEach(function(Q){A=K[Q];for(var i=0;i<A.length;i++){w=A[i].split(".");x=[];for(var j=0;j<w.length;j++){if(!isNaN(parseInt(w[j],10))){x.push(parseInt(w[j],10));}else{x.push(w[j]);}}for(var k=0;k<x.length;k+=2){y={"property":""};y[x[0]]=[];if(isNaN(parseInt(x[k],10))){u=x.slice(0,k+1);if(!l(H,u)&&typeof l(H,x.slice(0,x.length-2))!=="object"){p(H,u,[y],x[0],u.length);}V=l(N,x.slice(0,k+2));if(V&&l(H,x.slice(0,k+2))){n(H,V.property,x.slice(0,k+2).toString()+",property");}else if(k!==x.length-2){C.push(x.slice(0,k+2).toString());}}}v=x.slice(0);p(H,x,{"property":"","value":""},x[0],u.length);V=l(N,v);if(V){n(H,V.value,v.toString()+",value");n(H,V.property,v.toString()+",property");}}C.forEach(function(G){V=l(N,G.split(","));if(V&&l(H,G.split(","))){n(H,V.property,G+",property");}});C=[];if(H[Q]&&Array.isArray(H[Q][0][Q])&&H[Q][0][Q].length===0){H[Q]=H[Q].splice(1);}});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(H));sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(N),"Full");var U=0;Object.keys(D).forEach(function(Q){z=Q;if(H[z]&&Array.isArray(H[z])){H[z].forEach(function(i,j){var k=h(H[z][j],z);if(U<k){U=k;}});}sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+Q).expandToLevel(U-1);sap.ui.getCore().byId(Q).setCount(m(H[Q],Q,0));});}else{Object.keys(D).forEach(function(Q){sap.ui.getCore().byId(Q).setCount(m(N[Q],Q,0));});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(N));}};function h(C,s){var H=0;if(C[s]){C[s].forEach(function(i){var j=h(i,s);if(j>H){H=j;}});}return H+1;}function l(j,k){for(var i=0;i<k.length;i++){if(j){j=j[k[i]];}}return j;}function m(C,s,i){if(Array.isArray(C)){C.forEach(function(j){if(j[s]){i=m(j[s],s,i);}else{i+=1;}});return i;}return undefined;}function n(j,v,s){var k=s.split(",");for(var i=0;i<k.length-1;i++){j=j[k[i]];}j[k[k.length-1]]=v;}function p(i,j,v,s,k){if(j.length===1){i[j[0]]=v;}else{var u=j.shift();i[u]=p(typeof i[u]==="undefined"?{}:i[u],j,v,s,k);}if(i[s]&&i.property&&i.value){delete i.value;i.property="";}return i;}function q(C,s,i,j,k){C.forEach(function(u,v){if(u[s]){i=i+"."+v+"."+s;i=q(u[s],s,i,j,k);}else if(u.property.indexOf(k)>-1){i=i+"."+v;j.push(i);i=i.substring(0,i.lastIndexOf("."));}});i=i.substring(0,i.lastIndexOf("."));if(isNaN(parseInt(i.substr(i.lastIndexOf(".")+1),10))){return i;}return i.substring(0,i.lastIndexOf("."));}function r(C,s){if(typeof C!=="object"){return[{property:s,value:C}];}return Object.keys(C).map(function(i){var j={property:i};if(typeof(C[i])==="object"&&Object.keys(C[i]).length!==0){j[s]=r(C[i],s);return j;}if(!c(C[i])||typeof(C[i])!=="object"){j.value=C[i];}else{j.value="";}return j;});}f.prototype.prepareForSending=function(i,j){Object.keys(i).forEach(function(k){var C=i[k];switch(typeof C){case"object":if(C===null){j[k]=C;return;}else if(Array.isArray(C)){j[k]=[];}else{j[k]={};}this.prepareForSending(i[k],j[k]);break;case"undefined":j[k]="undefined";return;case"function":return;default:j[k]=i[k];return;}}.bind(this));};f.prototype.getNewConfigJSON=function(i){var N={};Object.keys(i).forEach(function(s){N[s]=r(i[s],s);});return N;};f.prototype.getFlpConfigurationPluginUI=function(i,j,C){var k,s,u,v={};u=this.getNewConfigJSON(this.flpConfig);k=new J(u);for(var w in u){v[w]=m(u[w],w,0);}if(!sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar")){if(!u||c(u)){new M({text:o.getResourceBundle().getText("ERROR_MESSAGE"),type:"Warning",showIcon:true,showCloseButton:false}).placeAt(this.getId());}else{s=new I("sap-ui-support-flpConfigurationPlugin-TabBar",{headerMode:"Inline"});Object.keys(this.flpConfig).forEach(function(y,z){s.insertItem(new a(y,{key:y,text:y,count:v[y],content:[new j("sap-ui-support-flpConfigurationPlugin-TreeTable"+y,{rows:"{/"+y+"/}",selectionMode:d.None,enableCellFilter:true,extension:[new F({items:[new B({icon:"sap-icon://expand",text:"{i18n>EXPAND_BUTTON}",press:_}),new B({icon:"sap-icon://collapse",text:"{i18n>COLLAPSE_BUTTON}",press:g})]})],columns:[new C({label:new L({text:"{i18n>COLUMN_PROPERTY}"}),template:new T({text:"{property}"})}),new C({label:new L({text:"{i18n>COLUMN_VALUE}"}),template:new T({text:"{value}"})})]})]}),z);});var x=new S({search:this.onPressSearchNewModel});x.placeAt(this.getId());s.setModel(k);s.setModel(o,"i18n");s.placeAt(this.getId());}}};return f;});
