// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessage","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/Log"],function(A,q,O,L){"use strict";var C="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var s,t={},T={},U=0,a=[],p=0;function b(){this.init=function(){var c=this;s=A.getHandlers();A.registerCommunicationHandler("sap.ushell.PostMessage",{oInboundActions:{"callTunnelFunction":{executeServiceCallFn:function(S){var d=S.oMessageData.body.content,e=c.restoreArray(d.arguments);t[d.UUID].fnCallback.apply(this,Object.values(e));return new q.Deferred().resolve().promise();}}}});c.handleMessageEvent=b.prototype._handleMessageEvent.bind(c,c);addEventListener("message",c.handleMessageEvent);};this.restoreArray=function(o){var c=[],i=0;while(o[i]){c.push(o[i]);i++;}return c;};this.destroy=function(){removeEventListener("message",this.handleMessageEvent);};this._handleMessageResponse=function(m){if(m.request_id&&a[m.request_id]){var r=a[m.request_id];if(m.status==="success"){r.resolve(m.body.result);}else{r.reject();}}};this._handleMessageRequest=function(c,m,M){var d=this,P=O.create("sap-ushell-config.services.PostMessage.config"),S=M&&M.service,e,f,g,o,h;L.debug("App Runtime received post message request from origin '"+m.origin+"': "+JSON.stringify(M),null,C);if(!S){return;}if(P&&P.enabled===false){L.warning("App Runtime received message for "+f+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,C);this.sendResponseMessage(m,M,"error",{message:"feature disabled"});return;}if(!this._isTrustedPostMessageSource(c,m)){L.warning("App Runtime received message from untrusted origin '"+m.origin+"': "+JSON.stringify(m.data),null,C);this.sendResponseMessage(m,M,"error",{message:"Invalid request"});return;}if(S.indexOf(".")>0){e=S.split(".");g=e[e.length-1];f=S.substr(0,S.length-g.length-1);}else{this.sendResponseMessage(m,M,"error",{message:"Invalid service name: '"+S+"'"});return;}var i={oMessage:m,oMessageData:M,oContainer:c};try{o=s[f];h=o&&o.oInboundActions[g];if(h&&h.executeServiceCallFn){h.executeServiceCallFn(i).done(function(r){d.sendResponseMessage(m,M,"success",{result:r});}).fail(function(j){d.sendResponseMessage(m,M,"error",{message:j});});}else{this.sendResponseMessage(m,M,"error",{message:"Unknown service name: '"+M.service+"'"});}}catch(E){this.sendResponseMessage(m,M,"error",{message:E.message});}};this._getCFLPWindow=function(){return window.parent;};this._isTrustedPostMessageSource=function(c,m){var d=false,P=c._getCFLPWindow();if(P){d=(m.source===P);}return d;};this.sendResponseMessage=function(m,M,S,B){var r=this.stringify({type:"response",service:M.service,request_id:M.request_id,status:S,body:B});L.debug("Sending post message response to origin ' "+m.origin+"': "+r,null,C);if(typeof m.source!=="object"||m.source===null){L.debug("Cannot send response message to origin ' "+m.origin,"`source` member of request message is not an object",C);return;}m.source.postMessage(r,m.origin);};this._getTargetWindow=function(){return window.parent;};this.postMessage=function(m){var c,d=this._getTargetWindow();if(m){try{if(m.type==="request"&&!m.request_id){m.request_id=this.getId();}c=this.stringify(m);d.postMessage(c,"*");}catch(e){L.error("Message '"+m+"' cannot be posted: "+e,"sap.ui5Isolation.AppCommunicationMgr");}}};this.sendMessageToOuterShell=function(m,P,r){var d=new q.Deferred(),M={"type":"request","service":m,"body":(P||{}),"request_id":r};this.postMessage(M);a[M.request_id]=d;return d.promise();};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+(++p);};}b.prototype._handleMessageEvent=function(c,m){if(m===undefined){return;}var M=m.data;if(typeof M==="string"){try{M=this.parse(m.data,this);}catch(e){L.debug("Message received from origin '"+m.origin+"' cannot be parsed: "+e,M,C);return;}}if(M.type==="request"){return c._handleMessageRequest(c,m,M);}else if(M.type==="response"){return c._handleMessageResponse(M);}};b.prototype.stringify=function(d){var c=function(f){if(t[f]){return{type:"tunnel",UUID:t[f]};}U++;t[U]={fnCallback:f};t[f]=U;return{type:"tunnel",UUID:U};},e=[],r=JSON.stringify(d,function(k,v){if(v!==null){if(typeof v==='object'||typeof v==="function"){if(e.indexOf(v)!==-1){return;}e.push(v);}}if(typeof v==="function"){var n=T[v];if(n){return{type:"reversetunnel",UUID:n};}return c(v);}return v;});return r;};b.prototype.parse=function(d,c){return JSON.parse(d,function(k,v){if(v&&v.type==="tunnel"){var e=function(){return c.sendMessageToOuterShell("sap.ushell.PostMessage.callTunnelFunction",{"content":{UUID:v.UUID,arguments:arguments}});};T[e]=v.UUID;return e;}else if(v&&v.type==="reversetunnel"){return t[v.UUID].fnCallback;}return v;});};return new b();},false);
