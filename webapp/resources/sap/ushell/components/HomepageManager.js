// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/Device","sap/ui/model/Filter","sap/ushell/ui/launchpad/TileState","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/_HomepageManager/DashboardLoadingManager","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/m/SelectDialog","sap/m/StandardListItem","sap/ushell/components/homepage/ComponentKeysHandler","sap/ushell/components/_HomepageManager/PersistentPageOperationAdapter","sap/ushell/components/_HomepageManager/TransientPageOperationAdapter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/model/Context","sap/m/MessageToast","sap/base/Log","sap/ui/performance/Measurement","sap/ushell/Config"],function(Q,B,D,F,T,P,a,e,s,u,r,d,g,m,G,S,b,C,c,f,h,l,n,M,L,o,p){"use strict";var t=l.GenericTileScope;var v={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};var _=[];var w=false;function x(R){_.push(R);if(!w){w=true;_.shift()();}}function y(){if(_.length===0){w=false;}else{_.shift()();}}function z(){_=[];w=false;}var A=[];return B.extend("sap.ushell.components.HomepageManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","resetGroupsOnFailure","addGroupToModel","addTileToGroup","deleteTilesFromGroup"]},analyticsConstants:v,constructor:function(i,j){if(sap.ushell.components.getHomepageManager){var H=sap.ushell.components.getHomepageManager();if(!H.view){H.setDashboardView(j.view);}return H;}sap.ui.getCore().attachThemeChanged(u.handleTilesVisibility);sap.ushell.components.getHomepageManager=(function(q){return function(){return q;};}(this));this.oPageOperationAdapter=c.getInstance();this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oModel=j.model;this.oRouter=j.router;this.oDashboardView=j.view;this.oSortableDeferred=new Q.Deferred();this.oSortableDeferred.resolve();this.registerEvents();this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.tileUuid=null;this.bIsGroupsModelLoading=false;this.segmentsStore=[];this.bIsFirstSegment=true;this.bIsFirstSegmentViewLoaded=false;this.aGroupsFrame=null;this.iMinNumOfTilesForBlindLoading=this.oModel.getProperty("/optimizeTileLoadingThreshold")||100;this.bIsScrollModeAccordingKPI=false;this.oGroupNotLockedFilter=new F("isGroupLocked",h.EQ,false);this.bLinkPersonalizationSupported=this.oPageOperationAdapter.isLinkPersonalizationSupported();this.oDashboardLoadingManager=new a("loadingManager",{oDashboardManager:this});if(this.oRouter){var k=this.oRouter.getTarget("home");k.attachDisplay(function(q){this.oDashboardView=q.getParameter("view");}.bind(this));}var E=s.last("/core/home/enableTransientMode");A.push(s.on("/core/home/enableTransientMode").do(function(N){if(E===N){return;}E=N;this._changeMode(N);}.bind(this)));this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));return undefined;},isBlindLoading:function(){var i=s.last("/core/home/homePageGroupDisplay");if((i===undefined||i==="scroll")&&this.bIsScrollModeAccordingKPI){L.info("isBlindLoading reason IsScrollModeAccordingKPI and IsScrollMode: true");return true;}if(this.oModel.getProperty("/tileActionModeActive")){L.info("isBlindLoading reason TileActionModeActive : true");return true;}return false;},createMoveActionDialog:function(i){var j=this.oGroupNotLockedFilter,k=new S(i,{title:r.i18n.getText("moveTileDialog_title"),rememberSelections:false,search:function(E){var V=E.getParameter("value"),q=new F("title",h.Contains,V),H=E.getSource().getBinding("items");H.filter([q,j]);},contentWidth:"400px",contentHeight:"auto",confirm:function(E){var q=E.getParameter("selectedContexts");this.publishMoveActionEvents(E,q,"movetile");}.bind(this),cancel:function(){var q=Q(".sapUshellTile[tabindex=\"0\"]")[0];if(q){q.focus();}},items:{path:"/groups",filters:[j],template:new b({title:"{title}"})}});return k;},publishMoveActionEvents:function(E,i,j){var k=sap.ui.getCore().getEventBus();if(i.length){var q=this.tileType==="link"?"links":"tiles";k.publish("launchpad",j,{sTileId:this.tileUuid,sToItems:q,sFromItems:q,sTileType:q,toGroupId:i[0].getObject().groupId,toIndex:i[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:E.getSource().getId(),callBack:C.callbackSetFocus.bind(C)});k.publish("launchpad","scrollToGroup",{groupId:i[0].getObject().groupId,groupChanged:false,focus:false});}},_changeLinksScope:function(E){var i=this;if(this.bLinkPersonalizationSupported){var I=E.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(j,k){if(!j.isGroupLocked){i._changeGroupLinksScope(j,I?"Actions":"Display");}});}},_changeGroupLinksScope:function(i,j){var k=this;i.links.forEach(function(q,E){k._changeLinkScope(q.content[0],j);});},_changeLinkScope:function(i,j){var k=i.getScope?i:i.getContent()[0];if(this.bLinkPersonalizationSupported&&k.setScope){k.setScope(j);}},registerEvents:function(){var E=sap.ui.getCore().getEventBus();E.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);E.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);E.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);E.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);E.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);E.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);E.subscribe("launchpad","createGroupAt",this._createGroupAt,this);E.subscribe("launchpad","deleteGroup",this._deleteGroup,this);E.subscribe("launchpad","resetGroup",this._resetGroup,this);E.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);E.subscribe("launchpad","moveGroup",this._moveGroup,this);E.subscribe("launchpad","deleteTile",this._deleteTile,this);E.subscribe("launchpad","movetile",this._moveTile,this);E.subscribe("launchpad","sortableStart",this._sortableStart,this);E.subscribe("launchpad","sortableStop",this._sortableStop,this);E.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);E.subscribe("launchpad","convertTile",this._convertTile,this);this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));},_changeMode:function(i){var j=this.getModel().getProperty("/groups");if(i){this.oPageOperationAdapter=f.getInstance();var k=this.oPageOperationAdapter.transformGroupModel(j);this.getModel().setProperty("/groups",k);}else{this.oPageOperationAdapter=c.getInstance();d.destroyFLPAggregationModels(j);this.getModel().setProperty("/groups",[]);this.loadPersonalizedGroups();}},_addFLPActionsToTile:function(i){var j=this.bLinkPersonalizationSupported&&this.oPageOperationAdapter.isLinkPersonalizationSupported(i),k=[];k.push(this._getMoveTileAction(i));if(j){if(!p.last("/core/extension/PageComposition")){k.push(this._getConvertTileAction(i));}}return k;},_getConvertTileAction:function(i){var E=sap.ui.getCore().getEventBus(),j=this,k=j.oPageOperationAdapter.getTileType(i);return{text:k==="link"?r.i18n.getText("ConvertToTile"):r.i18n.getText("ConvertToLink"),press:function(q){var H={tile:q,callBack:C.callbackSetFocus.bind(C)};E.publish("launchpad","convertTile",H);}};},_getMoveTileAction:function(i){var j=this;return{text:r.i18n.getText("moveTileDialog_action"),press:function(){j.tileType=j.oPageOperationAdapter.getTileType(i);j.tileUuid=j.getModelTileById(j.oPageOperationAdapter.getTileId(i),j.tileType==="link"?"links":"tiles").uuid;var k=j.tileType==="tile"?j.moveTileDialog:j.moveLinkDialog;if(j.tileType==="tile"||j.tileType==="link"){if(!k){k=j.createMoveActionDialog("move"+j.tileType+"Dialog");k.setModel(j.oModel);if(j.tileType==="tile"){j.moveTileDialog=k;}else{j.moveLinkDialog=k;}}else{k.getBinding("items").filter([j.oGroupNotLockedFilter]);}k.open();}}};},_handleTileAppearanceAnimation:function(j){if(!j){return;}var k=["webkit",""];function q(E,H){for(var i=0;i<k.length;i++){H=H.toLowerCase();j.attachBrowserEvent(k[i]+H,function(I){if(I.originalEvent&&I.originalEvent.animationName==="sapUshellTileEntranceAnimation"){j.removeStyleClass("sapUshellTileEntrance");}},false);}}q(j,"AnimationEnd");j.addStyleClass("sapUshellTileEntrance");},destroy:function(){var E=sap.ui.getCore().getEventBus();E.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);E.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);E.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);E.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);E.unsubscribe("launchpad","resetGroup",this._resetGroup,this);E.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);E.unsubscribe("launchpad","moveGroup",this._moveGroup,this);E.unsubscribe("launchpad","deleteTile",this._deleteTile,this);E.unsubscribe("launchpad","movetile",this._moveTile,this);E.unsubscribe("launchpad","sortableStart",this._sortableStart,this);E.unsubscribe("launchpad","sortableStop",this._sortableStop,this);E.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);sap.ui.getCore().detachThemeChanged(u.handleTilesVisibility);A.forEach(function(i){i.off();});c.destroy();f.destroy();sap.ushell.components.getHomepageManager=undefined;B.prototype.destroy.apply(this,arguments);},_sortableStart:function(){this.oSortableDeferred=new Q.Deferred();},_createBookmark:function(i,E,j){var k=j.group?j.group.object:"";delete j.group;function q(){sap.ushell.Container.getServiceAsync("Bookmark").then(function(H){H.addBookmark(j,k).always(y).done(function(){m.showLocalizedMessage("tile_created_msg");}).fail(function(I){L.error("Failed to add bookmark",I,"sap.ushell.ui.footerbar.AddBookmarkButton");m.showLocalizedError("fail_to_add_tile_msg");});});}x(q);},_addBookmarkToModel:function(i,E,j){var k=j.tile,q,H=j.group,I,J,K,N,O;if(!j||!k){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate();}return;}if(!H){q=this.getModel().getProperty("/groups");for(O=0;O<q.length;O++){if(q[O].isDefaultGroup===true){H=q[O].object;break;}}}J=this._getIndexOfGroupByObject(H);K=this.oModel.getProperty("/groups/"+J);I=this.oPageOperationAdapter.getPreparedTileModel(k,K.isGroupLocked);this.getTileView(I);K.tiles.push(I);K.visibilityModes=u.calcVisibilityModes(K,true);N=K.tiles.length;this._updateModelWithTileView(J,N);this.oModel.setProperty("/groups/"+J,K);},_refreshGroupInModel:function(i,E,j){var k=this;this.oPageOperationAdapter.refreshGroup(j).then(function(q){if(!q){return;}var H=k._getIndexOfGroupByObject(q.object);q.visibilityModes=u.calcVisibilityModes(q.object,true);k.oModel.setProperty("/groups/"+H,q);if(q.tiles){q.tiles.forEach(function(I){k.getTileView(I);});}});},_sortableStop:function(){this.oSortableDeferred.resolve();},_handleAfterSortable:function(i){return function(){var j=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){i.apply(null,j);});}.bind(this);},_createGroupAt:function(j,E,k){var q=parseInt(k.location,10),H=this.oModel.getProperty("/groups"),I=this.oPageOperationAdapter.getPreparedGroupModel(null,false,q===H.length,k),J=this.oModel,i;I.index=q;H.splice(q,0,I);for(i=0;i<H.length-1;i++){H[i].isLastGroup=false;}for(i=q+1;i<H.length;i++){H[i].index++;}J.setProperty("/groups",H);},_getIndexOfGroupByObject:function(i){var j=this.oModel.getProperty("/groups");return this.oPageOperationAdapter.getIndexOfGroup(j,i);},getTileActions:function(i){return this.oPageOperationAdapter.getTileActions(i);},addTileToGroup:function(i,j){var k=i+"/tiles",q=this.oModel.getProperty(i),N=this.oModel.getProperty(k).length;var E=this.oModel.getProperty(i+"/isGroupLocked"),H=this.oModel.getProperty("/personalization");q.tiles[N]=this.oPageOperationAdapter.getPreparedTileModel(j,E);this.getTileView(q.tiles[N]);q.visibilityModes=u.calcVisibilityModes(q,H);this._updateModelWithTileView(q.index,N);this.oModel.setProperty(i,q);if(q.isDefaultGroup&&q.tiles.length+q.links.length===1){var I=this.getDashboardView().oAnchorNavigationBar;window.setTimeout(function(){I.updateVisibility();},0);}},addTilesToGroupByCatalogTileId:function(j,k){var q=j.getBindingContext();for(var i=0;i<k.length;i++){this.addTileToGroupByCatalogTileId(q.sPath,k[i]);}},addTileToGroupByCatalogTileId:function(i,j){var N,k,q;if(!s.last("/core/home/enableTransientMode")){return;}q=this.oPageOperationAdapter.getTileModelByCatalogTileId(j);if(!q){return;}this.oDashboardLoadingManager.setTileResolved(q);N=this.oModel.getProperty(i+"/tiles").length;k=this.oModel.getProperty(i);k.tiles[N]=q;this.oModel.setProperty(i,k);},_getPathOfTile:function(i){var j=this.oModel.getProperty("/groups"),k=null,q=null,E,H=function(I,J){if(J.uuid===i){q=I;return false;}return undefined;};Q.each(j,function(I,J){Q.each(J.tiles,H);if(q!==null){k=I;E="tiles";return false;}Q.each(J.links,H);if(q!==null){k=I;E="links";return false;}return undefined;});return k!==null?"/groups/"+k+"/"+E+"/"+q:null;},_moveInArray:function(i,j,q){if(q>=i.length){var k=q-i.length;while((k--)+1){i.push(undefined);}}i.splice(q,0,i.splice(j,1)[0]);},_updateGroupIndices:function(i){var k;for(k=0;k<i.length;k++){i[k].index=k;}},_deleteGroup:function(i,E,j){var k=this,q=this.oModel,H=j.groupId,I=q.getProperty("/groups"),J=g.getIndexOfGroup(I,H),K=I.length-1===J,N=null,O,R;O=K?J-1:J;d.destroyFLPAggregationModel(q.getProperty("/groups/"+J));N=I.splice(J,1)[0];if(K){q.setProperty("/groups/"+O+"/isLastGroup",K);}q.setProperty("/groups",I);this._updateGroupIndices(I);if(O>=0){R=sap.ui.getCore().getEventBus();window.setTimeout(Q.proxy(R.publish,R,"launchpad","scrollToGroup",{groupId:q.getProperty("/groups")[O].groupId}),200);}function U(){k.oPageOperationAdapter.deleteGroup(N).then(function(){m.showLocalizedMessage("group_deleted_msg",[N.title]);y();},function(){k._resetGroupsOnFailure("fail_to_delete_group_msg");});}x(U);},_resetGroup:function(i,E,j){var k=this,q=j.groupId,H=this.oModel,I=H.getProperty("/groups"),J=g.getIndexOfGroup(I,q),K=k.oModel.getProperty("/groups/indexOfDefaultGroup")===J,N=H.getProperty("/groups/"+J),O,R;H.setProperty("/groups/"+J+"/sortable",false);function U(){k.oPageOperationAdapter.resetGroup(N,K).then(function(V){k._handleAfterSortable(function(q,W,X){var I=k.oModel.getProperty("/groups"),J=g.getIndexOfGroup(I,q);k._loadGroup(J,X||W);m.showLocalizedMessage("group_reset_msg",[W.title]);k.oModel.setProperty("/groups/"+J+"/sortable",true);O=sap.ui.getCore().byId("dashboardGroups").getGroupControlByGroupId(q);R=O.getBindingContext().getObject().links;if(R&&R.length&&!O.getIsGroupLocked()){k._changeGroupLinksScope(O.getBindingContext().getObject(),k.oModel.getProperty("/tileActionModeActive")?t.Actions:t.Display);}if(O){O.rerender();e.emit("updateGroups",Date.now());u.handleTilesVisibility();}})(q,N,V);y();},function(){k._resetGroupsOnFailure("fail_to_reset_group_msg");});}x(U);},_moveGroup:function(j,E,k){var q=k.fromIndex,H=k.toIndex,I=this.oModel,J=I.getProperty("/groups"),K=I.getProperty("/tileActionModeActive"),N,O,R=this,i,U;if(!K){q=this._adjustFromGroupIndex(q,J);}N=J[q];O=N.groupId;if(!K){H=this._adjustToGroupIndex(H,J,O);}U=J[H];this._moveInArray(J,q,H);this._updateGroupIndices(J);for(i=0;i<J.length-1;i++){J[i].isLastGroup=false;}J[J.length-1].isLastGroup=true;I.setProperty("/groups",J);function V(){J=I.getProperty("/groups");var N=I.getProperty(g.getModelPathOfGroup(J,O));if(!N.object){return;}R.oPageOperationAdapter.getOriginalGroupIndex(U,J).then(function(W){var X={iFromIndex:q,iToIndex:H};return R.oPageOperationAdapter.moveGroup(N,W,X);}).then(y,function(){R._resetGroupsOnFailure("fail_to_move_group_msg");});}x(V);},_adjustToGroupIndex:function(j,k,q){var E=0,I=false,i=0;for(i=0;i<k.length&&E<j;i++){if(k[i].isGroupVisible){if(k[i].groupId===q){I=true;}else{E++;}}}if(I){return i-1;}return i;},_adjustFromGroupIndex:function(j,k){var q=0,i;for(i=0;i<k.length;i++){if(k[i].isGroupVisible){q++;}if(q===j+1){return i;}}return j;},_changeGroupTitle:function(i,E,j){var k=this,N=j.newTitle,q=this.oModel.getProperty("/groups"),H=j.groupId,I=g.getIndexOfGroup(q,H),J=k.oModel.getProperty("/groups/indexOfDefaultGroup")===I,K=this.oModel.getProperty("/groups/"+I),O=K.title;this.oModel.setProperty("/groups/"+I+"/title",N);function R(){var V;if(K.isLastGroup){V=k.oPageOperationAdapter.addGroupAt(K,undefined,J);}else{var W=k.oModel.getProperty("/groups")[I+1];V=k.oPageOperationAdapter.getOriginalGroupIndex(W,q).then(function(X){return k.oPageOperationAdapter.addGroupAt(K,X,J);});}V.then(function(X){k._handleAfterSortable(function(Y,Z){var $=k.oModel.getProperty("/groups"),a1=g.getIndexOfGroup($,Y);k._loadGroup(a1,Z);})(H,X);y();},function(){k._resetGroupsOnFailure("fail_to_create_group_msg");});}function U(){this.oPageOperationAdapter.renameGroup(K,N,O).then(function(){y();},function(){k._resetGroupsOnFailure("fail_to_rename_group_msg");});}if(!K.object){y.call(this);x(R.bind(this));}else{x(U.bind(this));}},addGroupToModel:function(i){var j=this.oPageOperationAdapter.getPreparedGroupModel(i,false,true,{isRendered:true}),k=this.oModel.getProperty("/groups"),q=k.length,E;if(q>0){k[q-1].isLastGroup=false;}j.index=q;k.push(j);this.oModel.setProperty("/groups/",k);E=new n(this.oModel,"/groups/"+q);return E;},_deleteTile:function(i,E,j){var k=this,q=j.tileId,H=this.oModel.getProperty("/groups"),I=j.items||"tiles";Q.each(H,function(J,K){var N=false;Q.each(K[I],function(O,R){if(R.uuid!==q){return true;}d.destroyTileModel(k.oModel.getProperty("/groups/"+J+"/"+I+"/"+O));var U=K[I].splice(O,1)[0],V=k.oModel.getProperty("/personalization");K.visibilityModes=u.calcVisibilityModes(K,V);k.oModel.setProperty("/groups/"+J,K);function W(){k.oPageOperationAdapter.removeTile(K,U).then(function(){y();},function(){k._resetGroupsOnFailure("fail_to_remove_tile_msg");});}x(W);u.handleTilesVisibility();N=true;return false;});return!N;});},deleteTilesFromGroup:function(i,R){var j=this.oModel.getProperty("/groups"),k=g.getIndexOfGroup(j,i),q=this.oModel.getProperty("/groups/"+k),E=[];["tiles","links"].forEach(function(I){E=q[I].filter(function(J){if(R.indexOf(J.uuid)<0){return true;}return false;});q[I]=E;});q.visibilityModes=u.calcVisibilityModes(q,true);this.oModel.setProperty("/groups/"+k,q);if(q.isDefaultGroup&&q.tiles.length+q.links.length===0){var H=this.getDashboardView().oAnchorNavigationBar;window.setTimeout(function(){H.updateVisibility();},0);}},_getGroupIndex:function(i){var j=this.oModel.getProperty("/groups"),k=this._getNewGroupInfo(j,i);if(k){return k.newGroupIndex;}return undefined;},_convertTile:function(i,E,j){var k=j.tile?j.tile:j,q=j.srcGroupId?this._getGroupIndex(j.srcGroupId):undefined,H=j.srcGroupId?this.oModel.getProperty("/groups/"+q):k.getParent().getBindingContext().getObject(),I=k.getBindingContext().sPath.split("/"),J=k.getBindingContext().getObject(),O=I[I.length-2],K=J.uuid,N=parseInt(I[I.length-1],10),R=j.toIndex!==undefined?j.toIndex:undefined,U=this.oModel.getProperty("/tileActionModeActive"),V=j.toGroupId?this._getGroupIndex(j.toGroupId):H.index,W=j.toGroupId?this.oModel.getProperty("/groups/"+V):H,X=this;var Y=this._getIndexForConvert(O,N,R,H,W),Z={"tileIndex":N,"groupIndex":q,"group":H};function $(){J.tileIsBeingMoved=true;var a1=this.oPageOperationAdapter.moveTile(J,Y,H,W,O==="links"?"tile":"link");a1.then(function(b1){X._showMoveTileMessage(J,H,W);X._handleAfterSortable(function(K,b1){var c1=X._getPathOfTile(K),d1=b1.content;if(c1){if(O==="tiles"){X._attachLinkPressHandlers(d1);X._addDraggableAttribute(d1);X._changeLinkScope(d1,U?"Actions":"Display");}var e1={"tileIndex":R,"groupIndex":V,"group":W},f1={"tile":J,"view":d1,"type":O,"tileObj":b1.object};J.tileIsBeingMoved=true;X.replaceTileViewAfterConvert(Z,e1,f1);e.emit("updateGroups",Date.now());u.handleTilesVisibility();if(j.callBack){j.callBack(d1);}}})(K,b1);y();},function(){X._handleAfterSortable(X._resetGroupsOnFailure.bind(X))("fail_to_move_tile_msg");});}x($.bind(this));},replaceTileViewAfterConvert:function(i,j,k){var q=k.tile,E=q.content;q.tileIsBeingMoved=false;q.content=[k.view];q.object=k.tileObj;q.originalTileId=this.oPageOperationAdapter.getTileId(k.tileObj);i.group[k.type].splice(i.tileIndex,1);if(j.tileIndex!==undefined){j.group[k.type==="tiles"?"links":"tiles"].splice(j.tileIndex,0,q);}else{j.group[k.type==="tiles"?"links":"tiles"].push(q);}this.oModel.setProperty("/groups/"+j.groupIndex,j.group);this.oModel.setProperty("/groups/"+i.groupIndex,i.group);if(k.type==="links"){this._handleTileAppearanceAnimation(q.content[0].getParent());}else{this._handleTileAppearanceAnimation(q.content[0]);}if(E&&E[0]){E[0].destroy();}},_getIndexForConvert:function(i,j,k,q,E){var H;if(i==="tiles"){if(k!==undefined){H=E[i].length+k;}else{H=E[i].length+E.links.length;}if(q.groupId===E.groupId){H--;}}else{H=k||q.tiles.length;j+=q.tiles.length;}return{"tileIndex":j,"newTileIndex":H};},_getIndexForMove:function(i,j,k,q,E){var H;if(i==="tiles"){H=k!==undefined?k:q[i].length;}else{if(k!==undefined){H=q.tiles.length+k;}else{H=q.tiles.length+q.links.length;}j+=E.tiles.length;}return{"tileIndex":j,"newTileIndex":H};},_getTileInfo:function(i,j,I){var k;Q.each(i,function(q,E){var H=false;Q.each(E[I],function(J,K){if(K.uuid===j){k={"oTile":K,"tileIndex":J,"oGroup":E,"groupIndex":q};H=true;return false;}return undefined;});return!H;});return k;},_getNewGroupInfo:function(i,N){var j;Q.each(i,function(k,q){if(q.groupId===N){j={"oNewGroup":q,"newGroupIndex":k};}});return j;},_moveTile:function(i,E,j){var k=j.toIndex,N=j.toGroupId,q=j.sTileId,H=j.source,I=j.sTileType==="tiles"||j.sTileType==="tile"?"tile":"link",J=j.sToItems,K=j.sFromItems,O=this.oModel.getProperty("/tileActionModeActive"),R=this.oModel.getProperty("/groups"),U,V,W,X,Y,Z={},$=this;X=this._getTileInfo(R,q,K);Y=this._getNewGroupInfo(R,N);if(X.oGroup.groupId===Y.oNewGroup.groupId&&(H==="movetileDialog"||k===null||H==="movelinkDialog")){return;}if(I==="link"){X.oTile.content[0].addStyleClass("sapUshellZeroOpacity");}if(I==="tile"&&J==="tiles"){if(k&&k>Y.oNewGroup[J].length){k=Y.oNewGroup[J].length;}}if(X.oGroup.groupId===N&&J===K){if(k===null||k===undefined){X.oGroup[J].splice(X.tileIndex,1);k=X.oGroup[J].length;X.oGroup[J].push(X.oTile);}else{k=this._adjustTileIndex(k,X.oTile,X.oGroup,J);this._moveInArray(X.oGroup[J],X.tileIndex,k);}this.oModel.setProperty("/groups/"+X.groupIndex+"/"+J,X.oGroup[J]);}else{W=this.oModel.getProperty("/personalization");X.oGroup[K].splice(X.tileIndex,1);X.oGroup.visibilityModes=u.calcVisibilityModes(X.oGroup,W);this.oModel.setProperty("/groups/"+X.groupIndex+"/"+K,X.oGroup[K]);if(k===null||k===undefined){k=Y.oNewGroup[J].length;Y.oNewGroup[J].push(X.oTile);}else{k=this._adjustTileIndex(k,X.oTile,Y.oNewGroup,J);Y.oNewGroup[J].splice(k,0,X.oTile);}Y.oNewGroup.visibilityModes=u.calcVisibilityModes(Y.oNewGroup,W);this.oModel.setProperty("/groups/"+Y.newGroupIndex+"/"+J,Y.oNewGroup[J]);}e.emit("updateGroups",Date.now());u.handleTilesVisibility();U=this.oModel.getProperty("/groups/"+X.groupIndex);V=this.oModel.getProperty("/groups/"+Y.newGroupIndex);Z=this._getIndexForMove(K,X.tileIndex,k,Y.oNewGroup,U);function a1(){X.oTile.tileIsBeingMoved=true;this.oPageOperationAdapter.moveTile(X.oTile,Z,U,V,I).then(function(b1){var c1=$._getPathOfTile(q);$._showMoveTileMessage(X.oTile,U,V);if(c1){$.oModel.setProperty(c1+"/object",b1.object);$.oModel.setProperty(c1+"/originalTileId",b1.originalTileId);var d1=$.oModel.getProperty(c1+"/content"),e1=b1.content;if(J==="links"){$._changeLinkScope(e1,O?"Actions":"Display");$._attachLinkPressHandlers(e1);$._addDraggableAttribute(e1);$._handleTileAppearanceAnimation(e1);X.oTile.content=[e1];$.oModel.setProperty(c1,Q.extend({},X.oTile));$.oModel.setProperty("/groups/"+Y.newGroupIndex+"/"+J,$.oModel.getProperty("/groups/"+Y.newGroupIndex+"/"+J));}else{$.oModel.setProperty(c1+"/content",[e1]);}if(d1&&d1[0]){var f1=e1.onAfterRendering;e1.onAfterRendering=function(){f1.apply(this);d1[0].destroy();e1.onAfterRendering=f1;};}$.oModel.setProperty(c1+"/tileIsBeingMoved",false);if(j.callBack){j.callBack(e1);}}y();},function(){$._resetGroupsOnFailure("fail_to_move_tile_msg");});}x(a1.bind(this));},_showMoveTileMessage:function(i,j,k){var q=this.oPageOperationAdapter.getTileTitle(i),E=k.title,H=r.i18n.getText("added_tile_to_group"),I=q+" "+H+" "+E;if(j.groupId!==k.groupId){M.show(I);}},_adjustTileIndex:function(j,k,q,I){var E=0,H=false,i=0;for(i=0;i<q[I].length&&E<j;i++){if(q[I][i].isTileIntentSupported){if(q[I][i]===k){H=true;}else{E++;}}}if(H){return i-1;}return i;},getModel:function(){return this.oModel;},getDashboardView:function(){return this.oDashboardView;},setDashboardView:function(i){this.oDashboardView=i;return this;},setTileVisible:function(i,V){this.oPageOperationAdapter.setTileVisible(i.object,V);},refreshTile:function(i){this.oPageOperationAdapter.refreshTile(i.object);},updateSettings:function(i){this.oModel=i.model||this.oModel;this.oConfig=i.config||this.oConfig;this.oRouter=i.router||this.oRouter;this.oDashboardView=i.view||this.oDashboardView;},_resetGroupsOnFailure:function(i,j){z();m.showLocalizedError(i,j);this.bStartLoadRemainSegment=false;this.loadPersonalizedGroups();this.oModel.updateBindings(true);},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments);},_bindSegment:function(i,j){var k,q,E,H;for(k=0;k<j.length;k++){E=j[k];H=E.index;q=i[H];if(q){q.isRendered=true;q.tiles=q.tiles.concat(E.tiles);q.links=q.links.concat(E.links);}}return i;},createGroupsModelFrame:function(i,j){var k,q=[],O,E;E=function(H){var I=Q.extend({},H);I.tiles=[];I.pendingLinks=[];I.links=[];return I;};for(k=0;k<i.length;k++){O=i[k];q[k]=E(O);q[k].isRendered=false;q[k].visibilityModes=u.calcVisibilityModes(O,j);}return q;},_splitGroups:function(i,j){var k,q=[],E=0,I=this.oModel.getProperty("/homePageGroupDisplay")==="tabs",H=0,J;var K=500;for(k=0;k<i.length;k++){J=i[k];q.push(J);if(!this.segmentsStore.length){E+=this.PagingManager.getGroupHeight(J,j===k);}else{H+=J.tiles.length+J.links.length;}if(I&&!this.segmentsStore.length&&E>0){q.loadTilesView=true;this.segmentsStore.push(q);q=[];E=0;}if(E>=1||H>=K){this.segmentsStore.push(q);q=[];E=0;H=0;}}if(q.length){this.segmentsStore.push(q);}},_processSegment:function(i){var j=this.segmentsStore.shift();if(!j){return i;}if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")!=="tabs"||j.loadTilesView){this.getSegmentContentViews(j);}}i=this._bindSegment(i,j);return i;},getSegmentContentViews:function(i){var j,k,q,E;for(j=0;j<i.length;j++){q=i[j];for(k=0;k<q.tiles.length;k++){E=q.tiles[k];if(E.isTileIntentSupported){this.getTileView(E);}}for(k=0;k<q.links.length;k++){E=q.links[k];if(E.isTileIntentSupported){this.getTileView(E,q.index);}}}this.bIsFirstSegmentViewLoaded=true;},getSegmentTabContentViews:function(i,E,j){var k,q,H=j.iSelectedGroup,I;I=this.oModel.getProperty("/groups/"+H);for(k=0;k<I.tiles.length;k++){q=I.tiles[k];if(q.isTileIntentSupported){this.getTileView(q);}}for(k=0;k<I.links.length;k++){q=I.links[k];if(q.isTileIntentSupported){this.getTileView(q,H);}}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups();},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate();}},handleFirstSegmentLoaded:function(){var i=this.oModel.getProperty("/groups");if(this.aGroupsFrame){Array.prototype.push.apply(i,this.aGroupsFrame);this.aGroupsFrame=null;}this._initializeAnchorNavigationBar();if(!this.bStartLoadRemainSegment){this._processRemainingSegments();}},_initializeAnchorNavigationBar:function(){var i,j=sap.ushell.components.getHomepageManager().getDashboardView();i=j.getAnchorItemTemplate();this.oDashboardView.oAnchorNavigationBar.bindAggregation("groups",{path:"/groups",template:i});},_processRemainingSegments:function(){var U;if(this.segmentsStore.length>0){window.setTimeout(function(){U=this._processSegment(this.oModel.getProperty("/groups"));this.oModel.setProperty("/groups",U);this.bIsFirstSegment=false;this._processRemainingSegments();}.bind(this),0);}else{this.bIsGroupsModelLoading=false;this._updateModelWithTileView(0,0);u.handleTilesVisibility();sap.ui.getCore().getEventBus().publish("launchpad","dashboardModelContentLoaded");e.emit("updateGroups",Date.now());}},_setGroupModel:function(j){if(this.bIsGroupsModelLoading){L.info("Skip set the group model, because the group model is still loading");return;}var i=0,k,q=0,E=0,H=0,I,J,K=null,N,O,R=[];this.bIsGroupsModelLoading=true;try{q=this.oModel.getProperty("/groups").length;}catch(U){}for(i=j.length;i<q;++i){d.destroyFLPAggregationModel(this.oModel.getProperty("/groups/"+i));}if(!this.PagingManager){var V=Q("#dashboardGroups").width();if(!V){V=window.innerWidth;}var W=Q("#sapUshellDashboardPage-cont").height();if(W<100){W=window.innerHeight;}this.PagingManager=new P("dashboardPaging",{supportedElements:{tile:{className:"sapUshellTile"},link:{className:"sapUshellLinkTile"}},containerHeight:W,containerWidth:V});}j.forEach(function(X){if(X.isGroupVisible){E+=X.tiles.length;}});this.bIsScrollModeAccordingKPI=E>this.iMinNumOfTilesForBlindLoading;this.aGroupsFrame=this.createGroupsModelFrame(j,this.oModel.getProperty("/personalization"));for(i=0;i<this.aGroupsFrame.length;i++){if(this.aGroupsFrame[i].isGroupVisible&&this.aGroupsFrame[i].visibilityModes[0]){if(K===null){K=i;this.aGroupsFrame[i].isGroupSelected=true;this.oModel.setProperty("/iSelectedGroup",i);}H++;if(H>1){this.aGroupsFrame[K].showGroupHeader=false;break;}}}this._splitGroups(j,K);J=this.segmentsStore[0]?this.segmentsStore[0].length:0;I=this.aGroupsFrame.splice(0,J);o.start("FLP:DashboardManager._processSegment","_processSegment","FLP");R=this._processSegment(I);j.every(function(X,Y){if(X.isDefaultGroup){k=Y;return false;}return true;});R.indexOfDefaultGroup=k;if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){N=this.getDashboardView();O=N.oDashboardGroupsBox;O.getBinding("groups").filter([N.oFilterSelectedGroup]);}o.end("FLP:DashboardManager._processSegment");this.oModel.setProperty("/groups",R);this.aGroupModel=R;if(this.oDashboardView){e.once("firstSegmentCompleteLoaded").do(function(){u.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true});}).do(this.handleFirstSegmentLoaded.bind(this));}else{setTimeout(function(){Array.prototype.push.apply(this.aGroupModel,this.aGroupsFrame);this.aGroupsFrame=null;this.bStartLoadRemainSegment=true;this._processRemainingSegments();}.bind(this),0);}if(this.bIsFirstSegmentViewLoaded){e.emit("firstSegmentCompleteLoaded",true);}o.end("FLP:DashboardManager.loadGroupsFromArray");Q.sap.flpmeasure.end(0,"Process & render the first segment/tiles");},getPreparedGroupModel:function(){return this.aGroupModel;},_loadGroup:function(i,N){var j=this,k="/groups/"+i,O=j.oModel.getProperty(k),I=O.isLastGroup,q=O.groupId;d.destroyFLPAggregationModel(O);if(q){N.groupId=q;}N.isLastGroup=I;N.index=i;N.isRendered=true;this.oModel.setProperty(k,N);},_hasPendingLinks:function(j){for(var i=0;i<j.length;i++){if(j[i].content[0]===undefined){return true;}}return false;},_addModelToTileViewUpdateQueue:function(i,j){this.tileViewUpdateQueue.push({uuid:i,view:j});},_updateModelWithTileView:function(i,j){var k=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID);}this.tileViewUpdateTimeoutID=window.setTimeout(function(){k.tileViewUpdateTimeoutID=undefined;k.oSortableDeferred.done(function(){k._updateModelWithTilesViews(i,j);});},50);},_updateGroupModelWithTilesViews:function(i,k,E,H){var I,U,J,K,N=k||0;for(var j=N;j<i.length;j=j+1){I=i[j];for(var q=0;q<this.tileViewUpdateQueue.length;q++){U=this.tileViewUpdateQueue[q];if(I.uuid===U.uuid){E.push(q);if(U.view){if(H){I.content=[U.view];}else{I.content[0].destroy();I.content=[U.view];}this.oDashboardLoadingManager.setTileResolved(I);J=this.oPageOperationAdapter.getTileSize(I.object);K=((J!==null)&&(J==="1x2"))||false;if(I.long!==K){I.long=K;}}else{I.content[0].setState("Failed");}break;}}}},_updateModelWithTilesViews:function(j,k){var q=this.oModel.getProperty("/groups"),E=j||0,H=[];if(!q||this.tileViewUpdateQueue.length===0){return;}for(var i=E;i<q.length;i=i+1){this._updateGroupModelWithTilesViews(q[i].tiles,k,H);if(q[i].links){this._updateGroupModelWithTilesViews(q[i].links,k,H,true);if(q[i].pendingLinks.length>0){if(!q[i].links){q[i].links=[];}q[i].links=q[i].links.concat(q[i].pendingLinks);q[i].pendingLinks=[];}}}var I=[],J;for(J=0;J<this.tileViewUpdateQueue.length;J++){if(H.indexOf(J)===-1){I.push(this.tileViewUpdateQueue[J]);}}this.tileViewUpdateQueue=I;this.oModel.setProperty("/groups",q);},getModelTileById:function(i,I){var j=this.oModel.getProperty("/groups"),k,q=false;j.every(function(E){E[I].every(function(H){if(H.uuid===i||H.originalTileId===i){k=H;q=true;}return!q;});return!q;});return k;},_addDraggableAttribute:function(V){if(this.isIeHtml5DnD()){V.addEventDelegate({onAfterRendering:function(){this.$().attr("draggable","true");}.bind(V)});}},_attachLinkPressHandlers:function(V){var E=sap.ui.getCore().getEventBus(),i=V.attachPress?V:V.getContent()[0];i.attachPress(function(j){var k=V.getBindingContext().getObject().tileIsBeingMoved;if(!k&&this.getScope&&this.getScope()==="Actions"){switch(j.getParameters().action){case"Press":sap.ushell.components.homepage.ActionMode._openActionsMenu(j,V);break;case"Remove":var q=V.getBindingContext().getObject().uuid;E.publish("launchpad","deleteTile",{tileId:q,items:"links"});break;default:break;}}else{E.publish("launchpad","dashboardTileLinkClick");}});},handleDisplayModeChange:function(N){this.oModel.setProperty("/homePageGroupDisplay",N);switch(N){case"scroll":this._handleDisplayModeChangeToScroll();break;case"tabs":this._handleDisplayModeChangeToTabs();break;}},_handleDisplayModeChangeToTabs:function(){var j=this.oModel.getProperty("/iSelectedGroup"),k=this.oModel.getProperty("/groups");if(k.length>0){for(var i=0;i<k.length;i++){this.oModel.setProperty("/groups/"+i+"/isGroupSelected",false);}this.oModel.setProperty("/groups/"+j+"/isGroupSelected",true);}},_handleDisplayModeChangeToScroll:function(){if(this.isBlindLoading()){return;}var k=this.oModel.getProperty("/groups"),q,E,H,I=[],i,j;for(i=0;i<k.length;i++){q=k[i];E=q.tiles||[];for(j=0;j<E.length;j++){H=E[j];if(H.content.length===0){this.getTileView(H,i);}}I=q.links||[];for(j=0;j<I.length;j++){this.getTileView(I[j],i);}}this.oModel.refresh(false);var J=this.oModel.getProperty("/iSelectedGroup");if(J){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","scrollToGroup",{groupId:k[J].groupId});},100);}},getTileViewsFromArray:function(R){var i=this;if(R.length===0){return;}R.forEach(function(j){i.getTileView(j.oTile,j.iGroup);});this.oModel.refresh(false);if(this.bIsFirstSegmentViewLoaded===false){this.bIsFirstSegmentViewLoaded=true;e.emit("firstSegmentCompleteLoaded",true);}},getTileView:function(i,j){var k=this.oPageOperationAdapter.getTileType(i.object);if(this.oDashboardLoadingManager.isTileViewRequestIssued(i)){return;}this.oDashboardLoadingManager.setTileInProgress(i);this.oPageOperationAdapter.setTileVisible(i.object,false);if(k==="card"){this._loadCardData(i);}else{this._loadTileData(i,j,k);}},_loadCardData:function(i){var j=sap.ui.getCore().byId(i.controlId),k=Q.sap.flpmeasure.startFunc(0,"Loading of data and rendering for all cards",5,"loadCardData",i.object);if(j&&j.setManifest&&this.isBlindLoading()){j.setManifest(i.manifest);}i.content=[i.manifest];this.oDashboardLoadingManager.setTileResolved(i);Q.sap.flpmeasure.endFunc(0,"Loading of data and rendering for all cards",k);},getCurrentHiddenGroupIds:function(i){return this.oPageOperationAdapter.getCurrentHiddenGroupIds(i);},_loadTileData:function(i,j,k){var q=this,E=this.oPageOperationAdapter.getTileView(i),H,I,J,U=this._addModelToTileViewUpdateQueue,K,N=false,O=i.uuid,R=false,V=Q.sap.flpmeasure.startFunc(0,"Service + model binding and rendering for all tile-Views",5,"getTileView",i.object);if(E.state()==="resolved"){R=true;}E.done(function(W){if(W.oController&&W.oController.navigationTargetUrl&&!i.isCustomTile){i.target=W.oController.navigationTargetUrl;}K=W;if(K.getComponentInstance){o.average("FLP:getComponentInstance","get info for navMode","FLP1");var X=K.getComponentInstance().getComponentData();if(X&&X.properties){i.navigationMode=X.properties.navigationMode;}o.end("FLP:getComponentInstance");}q.oDashboardLoadingManager.setTileResolved(i);H=W.getMode?W.getMode():"ContentMode";if(q.bLinkPersonalizationSupported&&H==="LineMode"){q._attachLinkPressHandlers(K);q._addDraggableAttribute(K);if(j>=0){I=q.oModel.getProperty("/groups");if(I[j]){i.content=[K];J=q.oModel.getProperty("/groups/"+j+"/links");q.oModel.setProperty("/groups/"+j+"/links",[]);q.oModel.setProperty("/groups/"+j+"/links",J);}}}else if(q.isBlindLoading()){if(i.content&&i.content.length>0){i.content[0].destroy();}i.content=[K];if(j>=0&&!R){q.oModel.refresh(false);}}if(q.isBlindLoading()){var Y=q.oPageOperationAdapter.getTileSize(i.object);var Z=Y==="1x2";if(i.long!==Z){i.long=Z;}}else if(H==="LineMode"){i.content=[K];if(N){J=q.oModel.getProperty("/groups/"+j+"/links");q.oModel.setProperty("/groups/"+j+"/links",[]);q.oModel.setProperty("/groups/"+j+"/links",J);}}else if(i.content.length===0){i.content=[K];}else{U.apply(q,[O,K]);q._updateModelWithTileView(0,0);}Q.sap.flpmeasure.endFunc(0,"Service + model binding and rendering for all tile-Views",V);});E.fail(function(){if(q.oPageOperationAdapter.getTileType(i.object)==="link"&&q.bLinkPersonalizationSupported){K=q.oPageOperationAdapter.getFailedLinkView(i);}else{K=new T({state:"Failed"});}i.content=[K];});if(!K){if(q.oPageOperationAdapter.getTileType(i.object)==="link"){N=true;K=new G({mode:"LineMode"});}else{K=new T();}i.content=[K];}},isIeHtml5DnD:function(){return(D.browser.msie||D.browser.edge)&&(D.system.combi||D.system.tablet);},loadPersonalizedGroups:function(){var i=this;var j=new Q.Deferred();this.oPageOperationAdapter.getPage().then(function(k){i._setGroupModel(k);j.resolve();},function(){m.showLocalizedError("fail_to_load_groups_msg");});Q.sap.flpmeasure.start(0,"Service: Get Data for Dashboard",4);o.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return j.promise();}});});
