// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/components/applicationIntegration/elements/model","sap/ui/Device","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/EventHub","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement"],function(A,E,D,C,u,r,a,R,q,M){"use strict";function b(){var i,t=this,c,s,d;this.getIsTitleChanged=function(){return i;};this.getIsRelatedAppsChanged=function(){return d;};this.getHierarchyDefaultValue=function(){var h=[];var e=C.last("/core/shell/model/currentState/stateName");if(e&&((e==="app"||e==="embedded"))){h=[{icon:"sap-icon://home",title:r.i18n.getText("actionHomePage"),intent:s?"#"+s:"#"}];}return h;};this.init=function(I){s=I;};this.getIsHierarchyChanged=function(){return c;};this.onHierarchyChange=function(e){c=true;var h=e.getParameters().data,H,f=[],g=C.last("/core/shell/model/currentState/stateName");if(!h){h=[];}H=t.getHierarchyDefaultValue();h.forEach(function(I,j){f[j]=q.extend({},I);});f=f.concat(H);if(g==="home"){E.updateStateProperty("application/hierarchy",f,false,["home"]);}E.updateStateProperty("application/hierarchy",f,true);};this.onRelatedAppsChange=function(e){d=true;var o=e.getParameters().data,f=C.last("/core/shell/model/currentState/stateName");if(!o){o=[];}if(f==="home"){E.updateStateProperty("application/relatedApps",o,false,["home"]);}E.updateStateProperty("application/relatedApps",o,true);};this.resetShellUIServiceHandlers=function(){d=false;c=false;i=false;};this.onTitleChange=function(e){i=true;var T=e.getParameters().data;if(!T){T=this.getAppMeta().getTitleDefaultValue();}var f=C.last("/core/shell/model/currentState/stateName");if(f==="home"){E.updateStateProperty("application/title",T,false,["home"]);}E.updateStateProperty("application/title",T,true);R.genericSetItem("application/title",T);window.document.title=T;u.setPerformanceMark("FLP -- title change");a.emit("TitleChanged",T);};this._getDefaultFavIcon=function(p){var f=p.get("sapUiShellFavicon");if(f){var m=/url[\s]*\('?"?([^'")]*)'?"?\)/.exec(f);if(m){f=m[1];}else if(f==="''"||f==="none"){f=null;}}if(!f){var e=q.sap.getModulePath("sap.ushell");return e+"/themes/base/img/launchpad_favicon.ico";}return f;};this.getFavIconHref=function(){return q("link").filter("[rel=\"shortcut icon\"]").attr("href")||"";};this.getAppIcon=function(){var I="sap-icon://folder",e=A.getMetadata();if(e&&e.icon){I=e.icon;}return I;};this.setAppIcons=function(m){sap.ui.require(["sap/ui/core/theming/Parameters"],function(P){M.start("FLP:ShellController.setAppIcons","setAppIcons","FLP");var e=q.sap.getModulePath("sap.ushell"),l=(m&&m.homeScreenIconPhone)||(e+"/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png"),L=(m&&m["homeScreenIconPhone@2"])||(e+"/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png"),o=(m&&m.homeScreenIconTablet)||(e+"/themes/base/img/launchicons/72_iPad_Desktop_Launch.png"),f=(m&&m["homeScreenIconTablet@2"])||(e+"/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png"),F=(m&&m.favIcon)||(this._getDefaultFavIcon(P)),g=this.getFavIconHref();if(D.os.ios){q.sap.setIcons({"phone":l,"phone@2":L,"tablet":o,"tablet@2":f,"favicon":F,"precomposed":false});}else if(g!==F){q.sap.setIcons({"phone":"","phone@2":"","tablet":"","tablet@2":"","favicon":F,"precomposed":true});}M.end("FLP:ShellController.setAppIcons");}.bind(this));};this._applyContentDensityByPriority=function(e,f){var g;if(e===undefined){if(D.system.combi){var h=sap.ushell.Container.getService("UserInfo"),U=h.getUser(),j="autoDetect";if(U){j=U.getContentDensity();}switch(j){case"cozy":e=false;break;case"compact":e=true;break;default:g=A.getMetadata();if(g.compactContentDensity&&!g.cozyContentDensity){e=true;}else{e=false;}}}else{g=A.getMetadata();if(g.compactContentDensity&&!g.cozyContentDensity){e=true;}else if(!g.compactContentDensity&&g.cozyContentDensity){e=false;}else{e=this._isCompactContentDensityByDevice();}}}this._applyContentDensityClass(e,f);};this._applyContentDensityClass=function(e,f){var I=this._isCompactContentDensityByDevice();return new Promise(function(g,h){function j(k){q("body").toggleClass("sapUiSizeCompact",k).toggleClass("sapUiSizeCozy",!k);if(f===true){sap.ui.require(["sap/ushell/components/applicationIntegration/AppLifeCycle"],function(l){l.postMessageToIframeApp("sap.ushell.appRuntime","uiDensityChange",{"isTouch":(k?"0":"1")});});}g();}if(e===undefined){sap.ushell.Container.getServiceAsync("UserInfo").then(function(k){var U=k.getUser?k.getUser():undefined;j(U&&U.getContentDensity()==="cozy"?false:I);});}else{j(!!e);}});};this._isCompactContentDensityByDevice=function(){return!D.support.touch||D.system.combi;};this.getTitleDefaultValue=function(){var T="",e=A.getMetadata();if(e&&e.title){T=e.title;}return T;};this.create=function(){};this.restore=function(I){this._applyContentDensityByPriority();this.setAppIcons(I);};this.store=function(I){};this.destroy=function(I){};}return new b();},true);
