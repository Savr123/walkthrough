// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/elements/model","sap/ushell/components/applicationIntegration/Storage","sap/ushell/components/applicationIntegration/application/BlueBoxHandler","sap/ushell/ui5service/ShellUIService","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ushell/components/applicationIntegration/configuration/AppMeta","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ui/Device","sap/ushell/Config","sap/ushell/ui5service/AppIsolationService","sap/ushell/ApplicationType","sap/ushell/components/applicationIntegration/DelegationBootstrap","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/Log"],function(E,S,B,a,A,R,b,c,d,u,D,C,e,f,g,U,q,L){"use strict";function h(){var v,i=["URL"],r,s,j,I={},o,k=false,l={},m={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},n,G=[],p={};this.shellElements=function(){return b;};this.service=function(){return R;};this.isCurrentApp=function(t){return(l.appId===t);};this.isAppWithSimilarShellHashInCache=function(t,F){var w=S.get(t);if(w){if(w.shellHash===F){return true;}return false;}return false;};this.isAppInCache=function(t){return!!S.get(t);};this.normalizeAppId=function(t){var w="-component",x=t.endsWith(w);if(x){return t.substring(0,t.length-w.length);}return t;};this.onComponentCreated=function(t,w,x){var y=x.component,z=this.normalizeAppId(y.getId());if(this.isAppInCache(z)){S.get(z).app=y;this.active(z);}else{l.app=y;if(y.active){y.active();}}};this.onGetMe=function(t,w,x){x.AppLifeCycle=this;};this.store=function(t){var w=S.get(t);if(w){A.store(w.app);R.store(w.service);c.store(w.meta);}};this.destroy=function(t,F){var w=S.get(t),x;this.removeControl(t);if(w){x=B.getStateFul(F.getUrl());if(x){var H=B.getHandler();H.destroy(x,t);}else{w.container.destroy();}S.remove(t);}else{A.destroy(F);b.destroy(F);c.destroy(F);}};this.restore=function(t){var w=S.get(t);if(w){A.restore(w.app);R.restore(w.service);c.restore(w.meta);}};this.active=function(t){var w=S.get(t);if(w){A.active(w.app);}};this.handleExitStateful=function(F,t){var w,H=B.getHandler();if(S.get(F)){w=B.getStorageKey(t);return H.store(t,w);}return H.destroy(t);};this.handleExitApplication=function(F,t,w){var x;if(F&&t){if(t.getUrl()&&B.getStateFul(t.getUrl())){this.handleExitStateful(F,t);}else if(S.get(F)){this.store(F);}else if(t.getApplicationType&&this.applicationIsStatefulType(t.getApplicationType())){if(w){t.postMessageRequest("sap.gui.triggerCloseSessionImmediately");}}else{x=i.indexOf(t.getApplicationType)>=0;if(this.isAppOfTypeCached(F,x)===false){this.destroy(F,t);}}if(F.indexOf("Shell-appfinder-component")>0){sap.ui.getCore().getEventBus().publish("sap.ushell","appFinderAfterNavigate");}}};this.onAfterNavigate=function(F,t,T,w){var x=T.indexOf("Shell-appfinder-component")>0||T.indexOf("Shell-home-component")>0;this.handleExitApplication(F,t,x);if(T){if(S.get(T)){this.restore(T);}else{}}};this.storeApp=function(t,w,T,F){if(!this.isAppInCache(t)){S.set(t,{service:R.create(),shellHash:F,appId:t,stt:"loading",appRelatedElements:b.getAppRelatedElement(),container:w,meta:d.getMetadata(T),app:undefined});if(B.isTypeSupported(this.calculateAppType(T))){B.setStorageKey(w,t);}return true;}return false;};this.resoterApp=function(t){if(this.isAppInCache(t)){l=S.get(t);if(B.getStorageKey(l.container)){B.setStorageKey(l.container,t);}}};this.isAppOfTypeCached=function(t,w){if(!k&&t.indexOf(r)!==-1){return true;}if(!k&&t.indexOf("Shell-appfinder")!==-1){return true;}if(new U(window.location.href).get("sap-keep-alive")=="true"&&w){return true;}return false;};h.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};this.calculateAppType=function(t){if(t.applicationType==="URL"&&t.additionalInformation&&t.additionalInformation.startsWith("SAPUI5.Component=")){return"SAPUI5";}return t.applicationType;};this.openApp=function(t,T,w,F){var x,y=i.indexOf(T.applicationType)>=0,z=this.calculateAppType(T);var H="application"+t;if(B.isTypeSupported(z)){x=B.getStateFul(T.url);if(!x){var J=B.getHandler();if(J&&J.setup){J.setup(T,H);}x=this.createApplicationContainer(t,T);B.set(T.url,x);x.setIsStateful(true);}if(this.isAppOfTypeCached(H,y)||this.isCachedEnabledAsAppParameter(w,T)){if(!this.isAppInCache(H)){this.storeApp(H,x,T,F);}this.resoterApp(H);}else{l={appId:H,stt:"loading",container:x,meta:d.getMetadata(T),app:undefined};}}else if(this.isAppOfTypeCached(H,y)||this.isCachedEnabledAsAppParameter(w,T)){if(!this.isAppInCache(H)){x=this.createApplicationContainer(t,T);this.storeApp(H,x,T,F);}this.resoterApp(H);}else if(this.applicationIsStatefulType(T.applicationType)){x=this.getStatefulContainer(T.applicationType);if(!x){x=this.createApplicationContainer(t,T);this.setStatefulContainer(T.applicationType,x);x.setIsStateful(true);}l={appId:H,stt:"loading",container:x,meta:d.getMetadata(T),app:undefined};}else{x=this.createApplicationContainer(t,T);l={appId:H,stt:"loading",container:x,meta:d.getMetadata(T),app:undefined};}};this.getAppMeta=function(){return c;};this.evict=function(t){var w,x=t.value,y=t.key;this.removeControl(y);if(x.container.getUrl&&x.container.getUrl()){w=B.getStateFul(x.container.getUrl());}if(w){var H=B.getHandler();H.destroy(w,y);}else{x.container.destroy();}};this.init=function(t,w,x,y,z,F,H){var J=this,K;if(D.system.phone){K=10;if(H&&H.limit&&H.limit.phone){K=H.limit.phone;}}else if(D.system.tablet){K=10;if(H&&H.limit&&H.limit.tablet){K=H.limit.tablet;}}else if(D.system.desktop){K=15;if(H&&H.limit&&H.limit.desktop){K=H.limit.desktop;}}else{K=10;}g.init(this.registerShellCommunicationHandler);g.bootstrap();s=new a({scopeObject:z.ownerComponent,scopeType:"component"});o=new e({scopeObject:z.ownerComponent,scopeType:"component"});j=t;v=w;r=x;c.init(r);k=y;B.init({oShellUIService:s,oAppIsolationService:o},H,this);S.init(K,function(N){this.evict(N);}.bind(this));this.registerShellCommunicationHandler({"sap.ushell.services.appLifeCycle":{oRequestCalls:{"create":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(N){L.info("sap.ushell.services.appLifeCycle.create:"+N);}).catch(function(N){L.error("Error: sap.ushell.services.appLifeCycle.create:"+N);});}},"destroy":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(N){L.info("sap.ushell.services.appLifeCycle.destroy:"+N);}).catch(function(N){L.error("Error: sap.ushell.services.appLifeCycle.destroy:"+N);});}},"store":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(N){L.info("sap.ushell.services.appLifeCycle.store:"+N);}).catch(function(N){L.error("Error: sap.ushell.services.appLifeCycle.store:"+N);});}},"restore":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(N){L.info("sap.ushell.services.appLifeCycle.restore:"+N);}).catch(function(N){L.error("Error: sap.ushell.services.appLifeCycle.restore:"+N);});}}},oServiceCalls:{"subscribe":{executeServiceCallFn:function(N){B.mapCapabilities(N.oContainer,N.oMessageData.body);return new q.Deferred().resolve({}).promise();}},"setup":{executeServiceCallFn:function(N){return new q.Deferred().resolve().promise();}}}}});this.registerShellCommunicationHandler({"sap.ushell.eventDelegation":{oRequestCalls:{"registerEventHandler":{isActiveOnly:false,distributionType:["URL"]}},oServiceCalls:{"registerEventHandler":{executeServiceCallFn:function(N){var O=M(N);return new q.Deferred().resolve(O).promise();}}}}});function M(N){var O=N.oMessageData.body.eventSerObj;return J.registerEventHandler(O);}sap.ui.getCore().getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);b.init(this.getElementsModel(),F);};this.addControl=function(t){v.addCenterViewPort(t);};this.removeControl=function(t){if(!B.getById(t)){v.removeCenterViewPort(t,true);}};this.removeApplication=function(t){var w=this.getControl(t);if(w){this.removeControl(w.getId());w.destroy();}};this.getControl=function(t){return v&&(v.getViewPortControl("centerViewPort","application-"+t)||v.getViewPortControl("centerViewPort","applicationShellPage-"+t));};this.getViewPortContainer=function(){return v;};this.navTo=function(t){v.navTo("centerViewPort",t,"show");};this.getCurrentApplication=function(){return l;};this.setApplicationFullWidth=function(t){var w=this.getCurrentApplication();if(w.container){w.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!t);}};this.createComponent=function(t,P){this.shellElements().setDangling(true);return A.createComponent(t,P);};this.getAppContainer=function(t,w,x,y,F){w.shellUIService=s.getInterface();w.appIsolationService=o.getInterface();w.targetNavigationMode=x?"explace":"inplace";this.openApp(t,w,y,F);if(G.length>0){l.container.registerShellCommunicationHandler(G);}if(p.UI5APP){l.container.setIframeHandlers(p.UI5APP);}return l.container;};this.getShellUIService=function(){return s;};this.getAppIsolationService=function(){return o;};this.initShellUIService=function(t){s._attachHierarchyChanged(c.onHierarchyChange.bind(this));s._attachTitleChanged(c.onTitleChange.bind(this));s._attachRelatedAppsChanged(c.onRelatedAppsChange.bind(this));s._attachBackNavigationChanged(t.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(t){var w={};if(t){var x={"GUI":true};Object.keys(t).filter(function(y){return t[y]===true&&x[y];}).map(function(y){var z=y;if(z==="GUI"){z="TR";}return z;}).forEach(function(y){w[y]=null;});}n=w;};this.setStatefulApplicationContainer=function(t){n=t;};this.getStatefulApplicationContainer=function(){return n;};this.applicationIsStatefulType=function(t){return n.hasOwnProperty(t);};this.getStatefulContainer=function(t){return n[t];};this.setStatefulContainer=function(t,w){n[t]=w;};this.statefulContainerForTypeExists=function(t){return!!this.getStatefulContainer(t);};this.getAllApplicationContainers=function(){return Object.keys(n).map(function(K){return n[K];}).filter(function(t){return!!t;});};this.getElementsModel=function(){return E;};this.activeContainer=function(t){var w=this.getAllApplicationContainers();w.forEach(function(x){L.info("Deactivating container "+x.getId());x.setActive(false);});if(t){L.info("Activating container "+t.getId());t.setActive(true);}};this.showApplicationContainer=function(t){this.navTo(t.getId());t.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");};this.reuseStateFulContainerAndRestore=function(t,T,H,F){var w=this,x=I[F];if(B.getStorageKey(t)){B.setStorageKey(t,x);}return H.restore(t,x).then(function(){w.showApplicationContainer(t);},function(y){L.error(y&&y.message||y);});};this.reuseStateFulContainer=function(t,w,T,H,F){var x=this;I[F]=T;if(B.getStorageKey(t)){B.setStorageKey(t,T);}return H.create(t,w,T).then(function(){x.showApplicationContainer(t);},function(y){L.error(y&&y.message||y);});};this.reuseApplicationContainer=function(t,w,x){var y=this;return t.setNewApplicationContext(w,x).then(function(){y.navTo(t.getId());t.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");},function(z){L.error(z&&z.message||z);});};this.createApplicationContainer=function(t,w){return A.createApplicationContainer(t,w);};this.publishNavigationStateEvents=function(t,w,O){var x,y=t.getId?t.getId():"",z=this;var F=d.getMetadata(),H=F.icon,T=F.title;t.addEventDelegate({onAfterRendering:O});x=t.exit;t.exit=function(){if(x){x.apply(this,arguments);}z.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var J=q.extend(true,{},w);delete J.componentHandle;J.appId=y;J.usageIcon=H;J.usageTitle=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",J);L.info("app was closed");},0);var P=z._publicEventDataFromResolutionResult(w);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(t){var P={};if(!t){return t;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(w){P[w]=t[w];});Object.freeze(P);return P;};this.isCachedEnabledAsAppParameter=function(t,T){if(t&&t.params&&t.params["sap-keep-alive"]){if(t.params["sap-keep-alive"]=="true"){return true;}}if(T&&T.url){if(new U(T.url).get("sap-keep-alive")=="true"){return true;}}return false;};this.getInMemoryInstance=function(t,F){var w="application-"+t,x=S.get(w);if(x){if(x.shellHash===F){return{isInstanceSupported:true,appId:x.appId,container:x.container};}return{isInstanceSupported:false,appId:x.appId,container:x.container};}return{isInstanceSupported:false,appId:undefined,container:undefined};};this.handleOpenStateful=function(t,w,T,x,y,F){var H=B.getHandler();if(S.get(T)&&t===false){this.reuseStateFulContainerAndRestore(x,T,H,F);}else{this.reuseStateFulContainer(x,y.url,T,H,F);if(w){if(!this.isAppInCache(T)){this.storeApp(T,x,y,F);}}}};this.handleControl=function(t,w,x,T,W,F){var y=this.getControl(t),z=this.statefulContainerForTypeExists(T.applicationType),H,M=d.getMetadata(T),J=i.indexOf(T.applicationType)>=0,K="application-"+t,N=this.isAppOfTypeCached(K,J)||this.isCachedEnabledAsAppParameter(x,T),O=T.applicationType,P=false,Q;O=this.calculateAppType(T);Q=f.getDefaultFullWidthSetting(O);H=B.isTypeSupported(O);if(H){y=B.getStateFul(T.url);if(!y){y=W(t,M,x,T,w,T.fullWidth||M.fullWidth||Q,F);this.resoterApp(y.getId());this.navTo(y.getId());P=true;}}else if(!z&&y&&!N){this.destroy(y.getId(),y);y=W(t,M,x,T,w,T.fullWidth||M.fullWidth||Q,F);}else if(!y){y=W(t,M,x,T,w,T.fullWidth||M.fullWidth||Q,F);}if(!z&&!H){this.resoterApp(y.getId());this.navTo(y.getId());}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(y);if(H){var V="application"+w,X=this,Y=v.getCurrentCenterPage(),Z=sap.ui.getCore().byId(Y);if(Z.getApplicationType&&!P){this.handleExitStateful(Y,Z).then(function(){X.handleOpenStateful(P,N,V,y,T,F);});}else{X.handleOpenStateful(P,N,V,y,T,F);}}else if(z){this.reuseApplicationContainer(y,T.applicationType,T.url);}};this.switchViewState=function(t,w,x){var y=t,z;if(m[t]&&m[t][j]){y=m[t][j];}var F=C.last("/core/shell/model/currentState/stateName")==="home";if(!F&&(!l.appId||!S.get(l.appId))){E.destroyManageQueue();}z=S.get("application"+x);if(z){b.restore(z);}else{b.assignNew(t);}E.switchState(y,w,x);this.shellElements().setDangling(false);this.shellElements().processDangling();if(t==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen","");if(!window.hasher.getHash().indexOf("Action-search")===0){var H=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+H.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(H.getProperty("/uiFilter/dataSource").getJson()));}}};this.registerShellCommunicationHandler=function(t){A.registerShellCommunicationHandler(t);};this.registerIframeCommunicationHandler=function(H,t){p[t]=H;};this.postMessageToIframeApp=function(t,w,M,W){var x,y=A.getActiveAppContainer(),z=[];if(y&&(B.isCapabilitySupported(y,t,w)||A.isAppTypeSupported(y,t,w))){z.push(A.postMessageToIframeApp(y,t,w,M,W));}if(!A.isActiveOnly(t,w)){S.forEach(function(H){if(H&&H.value&&H.value.container){if(B.isCapabilitySupported(H.value.container,t,w)||A.isAppTypeSupported(H.value.container,t,w)){z.push(A.postMessageToIframeApp(H.value.container,t,w,M,W));}}});}x=A.getResponseHandler(t,w);var F=Promise.all(z);if(x){x(F);}return F;};this.postMessageToIframeAppAccordingToPolicy=function(t,w,M,W,P){var x,y=A.getActiveAppContainer(),z=[];if(y&&A.isAppTypeSupportedByPolicy(y,P)){z.push(A.postMessageToIframeApp(y,t,w,M,W));}if(!P.isActiveOnly){S.forEach(function(H){if(H&&H.value&&H.value.container){if(A.isAppTypeSupported(H.value.container,t,w)){z.push(A.postMessageToIframeApp(H.value.container,t,w,M,W));}}});}x=A.getResponseHandler(t,w);var F=Promise.all(z);if(x){x(F);}return F;};this.registerTunnels=function(t){g.registerTunnels(t,this.registerShellCommunicationHandler);};this.registerEvents=function(t){g.registerEvents(t,this.registerShellCommunicationHandler);};}return new h();},true);
