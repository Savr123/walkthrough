// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/ui5service/UserStatus","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/service/ServiceFactoryRegistry","sap/ushell/resources","sap/ushell/ui/launchpad/UserStatusItem","sap/m/Switch","sap/m/library","sap/ui/model/json/JSONModel","sap/ui/core/theming/Parameters","sap/ui/Device","sap/m/Popover","sap/ui/core/IconPool"],function(U,A,L,q,S,r,a,b,m,J,P,D,c,I){"use strict";var d=m.PlacementType;var f=m.SwitchType;sap.ui.controller("sap.ushell.components.shell.UserSettings.userAccount.UserAccountSelector",{onInit:function(){var t=this;var s=sap.ushell.Container.getRenderer("fiori2").getShellController();var o=s.getView();this.oShellConfig=(o.getViewData()?o.getViewData().config:{})||{};this.imgConsentEnabled=this.oShellConfig.enableUserImgConsent?this.oShellConfig.enableUserImgConsent:false;this.userStatusEnabled=this.oShellConfig.enableOnlineStatus&&U.prototype.isEnabled;this.userStatusEnabled=this.userStatusEnabled?this.userStatusEnabled:false;if(this.imgConsentEnabled){try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser();}catch(e){L.error("Getting UserInfo service failed.");this.oUser=sap.ushell.Container.getUser();}this.currentUserImgConsent=this.oUser.getImageConsent();this.origUserImgConsent=this.currentUserImgConsent;this.addImgConsentEnableSwitch(this.currentUserImgConsent);}if(this.userStatusEnabled){if(this.isServiceEnable()){this.originalEnableStatus=null;this.originalUserStatus=null;var g=S.get("sap.ushell.ui5service.UserStatus");var h=g.createInstance();h.then(function(g){t.oUserStatusService=g;var p=t._getUserStatusSetting();p.then(function(u){var i=u&&u.userStatusEnabled?u.userStatusEnabled:false;var j=u&&u.userStatusDefault?u.userStatusDefault:undefined;this.originalEnableStatus=i;this.originalUserStatus=j;t.userStatusButton=t._getOnlineStatusPopOver(this.originalUserStatus);t.addUserStatusDropdown();t.addUserEnableSwitch(i);}.bind(t));},function(){});}}},getContent:function(){var o=q.Deferred();var R=r.getTranslationModel();this.getView().setModel(R,"i18n");this.getView().setModel(this.getConfigurationModel(),"config");o.resolve(this.getView());return o.promise();},getValue:function(){var o=q.Deferred();o.resolve(sap.ushell.Container.getUser().getFullName());return o.promise();},onCancel:function(){if(this.userStatusEnabled){if(this.isServiceEnable()){this.oUserEnableOnlineStatusSwitch.setState(this.originalEnableStatus);this.userStatusButton.setStatus(a.prototype.STATUS_ENUM[this.originalUserStatus]);}}if(this.imgConsentEnabled){this.currentUserImgConsent=this.oUser.getImageConsent();this.oUserEnableImgConsentSwitch.setState(this.currentUserImgConsent);}},onSave:function(){var R=q.Deferred(),w,u,e,p=[];if(this.userStatusEnabled){u=this.onSaveUserStatus();p.push(u);}if(this.imgConsentEnabled){e=this.onSaveUserImgConsent();p.push(e);}w=q.when.apply(null,p);w.done(function(){R.resolve();});return R.promise();},onSaveUserImgConsent:function(){var e=q.Deferred();var u;if(this.oUser.getImageConsent()!==this.currentUserImgConsent){if(this.currentUserImgConsent!==undefined){this.oUser.setImageConsent(this.currentUserImgConsent);u=this.userInfoService.updateUserPreferences(this.oUser);u.done(function(){this.oUser.resetChangedProperty("isImageConsent");this.origUserImgConsent=this.currentUserImgConsent;e.resolve();}.bind(this));u.fail(function(E){this.oUser.setImageConsent(this.origUserImgConsent);this.oUser.resetChangedProperty("isImageConsent");this.currentUserImgConsent=this.origUserImgConsent;L.error(E);e.reject(E);}.bind(this));}else{e.reject(this.currentUserImgConsent+"is undefined");}}else{e.resolve();}return e.promise();},onSaveUserStatus:function(){var o=q.Deferred(),u;if(this.isServiceEnable()){if(this.originalEnableStatus!==this.oUserEnableOnlineStatusSwitch.getState()||this.originalUserStatus!==this.userStatusButton.getStatus().status){if(!this.oUserEnableOnlineStatusSwitch.getState()){u=null;this.oUserStatusService.setStatus(null);}else{u=this.userStatusButton.getStatus()?this.userStatusButton.getStatus().status:"AVAILABLE";}this._writeUserStatusSettingToPersonalization({userStatusEnabled:this.oUserEnableOnlineStatusSwitch.getState(),userStatusDefault:u});if(!this.originalEnableStatus&&this.oUserEnableOnlineStatusSwitch.getState()){this.oUserStatusService.setStatus(u);}this.originalEnableStatus=this.oUserEnableOnlineStatusSwitch.getState();this.originalUserStatus=u;}}o.resolve();return o.promise();},addUserStatusDropdown:function(){var u=sap.ui.getCore().byId("UserAccountSelector--userStatusDropDownFlexBox");u.addItem(this.userStatusButton);},addUserEnableSwitch:function(e){var u=sap.ui.getCore().byId("UserAccountSelector--userStatusEnableFlexBox");this.oUserEnableOnlineStatusSwitch=new b({type:f.Default,state:e,change:function(E){this.userStatusButton.setEnabled(E.mParameters.state);this.userStatusButton.$().attr("tabindex",E.mParameters.state?0:-1);}.bind(this)});this.oUserEnableOnlineStatusSwitch.addCustomData(new A({key:"aria-labelledBy",value:"UserAccountSelector--sapUshellEnableStatusLabel",writeToDom:true}));this.userStatusButton.setEnabled(e);this.userStatusButton.$().attr("tabindex",e?0:-1);if(!u){L.error("UserAccountSelector: addUserEnableSwitch was called before the renderer");return;}u.addItem(this.oUserEnableOnlineStatusSwitch);},isServiceEnable:function(){return U?U.prototype.isEnabled:false;},getConfigurationModel:function(){var C=new J({});var u=sap.ushell.Container.getUser();C.setData({isRTL:sap.ui.getCore().getConfiguration().getRTL(),sapUiContentIconColor:P.get("sapUiContentIconColor"),isStatusEnable:this.originalEnableStatus?this.originalEnableStatus:false,flexAlignItems:D.system.phone?"Stretch":"Center",textAlign:D.system.phone?"Left":"Right",textDirection:D.system.phone?"Column":"Row",labelWidth:D.system.phone?"auto":"12rem",name:u.getFullName(),mail:u.getEmail(),server:window.location.host,imgConsentEnabled:this.imgConsentEnabled,isImageConsent:this.currentUserImgConsent,userStatusEnabled:this.userStatusEnabled});return C;},_getOnlineStatusPopOver:function(u){var p=new c({placement:d.Bottom,showArrow:true,showHeader:false,content:[new a({status:a.prototype.STATUS_ENUM.AVAILABLE,isOpener:false,press:function(){o.setStatus(a.prototype.STATUS_ENUM.AVAILABLE);p.close();}}).addStyleClass("sapUserStatusContainer"),new a({status:a.prototype.STATUS_ENUM.AWAY,isOpener:false,press:function(){o.setStatus(a.prototype.STATUS_ENUM.AWAY);p.close();}}).addStyleClass("sapUserStatusContainer"),new a({status:a.prototype.STATUS_ENUM.BUSY,isOpener:false,press:function(){o.setStatus(a.prototype.STATUS_ENUM.BUSY);p.close();}}).addStyleClass("sapUserStatusContainer"),new a({status:a.prototype.STATUS_ENUM.APPEAR_OFFLINE,isOpener:false,press:function(){o.setStatus(a.prototype.STATUS_ENUM.APPEAR_OFFLINE);p.close();}}).addStyleClass("sapUserStatusContainer")]});var o=new a({tooltip:"{i18n>headerActionsTooltip}",enabled:false,ariaLabel:sap.ushell.Container.getUser().getFullName(),image:I.getIconURI("account"),status:u?a.prototype.STATUS_ENUM[u]:a.prototype.STATUS_ENUM.AVAILABLE,press:function(e){var B=sap.ui.getCore().byId(e.mParameters.id);p.openBy(B);},contentList:p}).addStyleClass("sapUserStatusOpener");return o;},_writeUserStatusSettingToPersonalization:function(u){var o,p;try{p=this._getUserSettingsPersonalizer().setPersData(u);}catch(e){L.error("Personalization service does not work:");L.error(e.name+": "+e.message);o=new q.Deferred();o.reject(e);p=o.promise();}return p;},_getUserSettingsPersonalizer:function(){if(this.oUserPersonalizer===undefined){this.oUserPersonalizer=this._createUserPersonalizer();}return this.oUserPersonalizer;},_createUserPersonalizer:function(){var p=sap.ushell.Container.getService("Personalization"),C,s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},o={container:"sap.ushell.services.UserStatus",item:"userStatusData"},e=p.getPersonalizer(o,s,C);return e;},_getUserStatusSetting:function(){var p=this._getUserSettingsPersonalizer();return p.getPersData();},addImgConsentEnableSwitch:function(e){var u=sap.ui.getCore().byId("UserAccountSelector--userImgConsentEnableFlexBox");this.oUserEnableImgConsentSwitch=new b({customTextOff:r.i18n.getText("No"),customTextOn:r.i18n.getText("Yes"),type:f.Default,state:e,change:this.setCurrentUserImgConsent.bind(this)});this.oUserEnableImgConsentSwitch.addCustomData(new A({key:"aria-labelledBy",value:"UserAccountSelector--sapUshellUserImageConsentSwitchLabel",writeToDom:true}));if(!u){L.error("UserAccountSelector: addImgConsentEnableSwitch was called before the renderer");return;}u.addItem(this.oUserEnableImgConsentSwitch);},setCurrentUserImgConsent:function(e){this.currentUserImgConsent=e.mParameters.state;},termsOfUserPress:function(){var t=sap.ui.getCore().byId("UserAccountSelector--termsOfUseTextFlexBox");var e=sap.ui.getCore().byId("UserAccountSelector--termsOfUseLink");var i=t.getVisible();if(i){t.setVisible(false);e.setText(r.i18n.getText("userImageConsentDialogShowTermsOfUse"));}else{e.setText(r.i18n.getText("userImageConsentDialogHideTermsOfUse"));t.setVisible(true);}}});});
