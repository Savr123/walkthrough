// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/resources","sap/m/ActionSheet","sap/m/library","sap/m/Button","sap/ui/thirdparty/jquery"],function(C,r,A,m,B,q){"use strict";var P=m.PlacementType;var a=function(){this.oEventBus=sap.ui.getCore().getEventBus();this.oEventBus.subscribe("launchpad","actionModeInactive",this.scrollToViewPoint,this);this.oEventBus.subscribe("launchpad","actionModeActive",this.scrollToViewPoint,this);this.viewPoint=undefined;this.init=function(M){this.oModel=M;};};a.prototype.activate=function(){this.oModel.setProperty("/tileActionModeActive",true);this.aOrigHiddenGroupsIds=this.getHomepageManager().getCurrentHiddenGroupIds(this.oModel);var d=sap.ui.getCore().byId("dashboardGroups");d.addLinksToUnselectedGroups();var t=sap.ui.getCore().byId("ActionModeBtn");if(t){t.setTooltip(r.i18n.getText("exitEditMode"));t.setText(r.i18n.getText("exitEditMode"));if(t.setSelected){t.setSelected(true);}}this.oEventBus.publish("launchpad","actionModeActive");};a.prototype.scrollToViewPoint=function(){if(!this.viewPoint){return;}var d=this.viewPoint;d.restoreLastFocusedTile=true;if(!this.oModel.getProperty("/tileActionModeActive")){var j=q(".sapUshellTileContainerHeader[tabindex=0]");if(j&&j.length>0){var b=j[0].closest(".sapUshellTileContainer");if(b){d.restoreLastFocusedTileContainerById=b.id;}}}d.iDuration=0;window.setTimeout(q.proxy(this.oEventBus.publish,this.oEventBus,"launchpad","scrollToGroup",d),0);};a.prototype.deactivate=function(){var t=sap.ui.getCore().byId("TileActions");this.oModel.setProperty("/tileActionModeActive",false);this.oEventBus.publish("launchpad","actionModeInactive",this.aOrigHiddenGroupsIds);if(t!==undefined){t.destroy();}sap.ui.require(["sap/m/MessageToast"],function(M){M.show(r.i18n.getText("savedChanges"),{duration:4000});});var T=sap.ui.getCore().byId("ActionModeBtn");if(T){T.setTooltip(r.i18n.getText("activateEditMode"));T.setText(r.i18n.getText("activateEditMode"));if(T.setSelected){T.setSelected(false);}}};a.prototype.toggleActionMode=function(M,s,d){var t=M.getProperty("/tileActionModeActive"),c=M.getProperty("/topGroupInViewPortIndex"),h=M.getProperty("/homePageGroupDisplay"),g=M.getProperty("/groups")||[],f=null,n=0;if(!d){d=[];}var v=d.filter(function(i){return i.getVisible();});g.forEach(function(o,i){if(o.isGroupVisible&&o.visibilityModes[t?0:1]){n+=1;if(f===null){f=i;}o.showGroupHeader=true;}});if(n>1){g[f].showGroupHeader=false;}var G=C.last("/core/home/gridContainer");if(!t&&G){g[f].showGroupHeader=true;}var b=v[c];if(b){var e=t?-49:49;var j=(h==="tabs")?d[0].getDomRef():b.getDomRef();var S=0;if(j){S=j.offsetTop;}var k=document.getElementById("sapUshellDashboardPage-cont").scrollTop-S;this.viewPoint={group:v[c],fromTop:k+e};}else{this.viewPoint={fromTop:0};}if(t){this.deactivate();}else{this.activate();}};a.prototype.activateGroupEditMode=function(g){var j=q(g.getDomRef()).find(".sapUshellTileContainerContent");j.addClass("sapUshellTileContainerEditMode");};a.prototype.getHomepageManager=function(){if(!this.oHomepageManager){this.oHomepageManager=sap.ushell.components.getHomepageManager();}return this.oHomepageManager;};a.prototype._openActionsMenu=function(e,v){var t=this,T=v||e.getSource(),b=[],o=sap.ui.getCore().byId("TileActions"),i,n,c,d,f,h,g,j;if(T){f=T.getBindingContext().getObject().object;b=this.getHomepageManager().getTileActions(f);}t.oTileControl=T;q(".sapUshellTileActionLayerDivSelected").removeClass("sapUshellTileActionLayerDivSelected");g=q(e.getSource().getDomRef()).find(".sapUshellTileActionLayerDiv");g.addClass("sapUshellTileActionLayerDivSelected");if(o===undefined){o=new A("TileActions",{placement:P.Bottom,afterClose:function(){q(".sapUshellTileActionLayerDivSelected").removeClass("sapUshellTileActionLayerDivSelected");var E=sap.ui.getCore().getEventBus();E.publish("dashboard","actionSheetClose",t.oTileControl);}});}else{o.destroyButtons();}var k=T.getModel();var G=T.getParent().getBindingContext().getPath();if(b.length===0||k.getProperty(G+"/isGroupLocked")){n=new B({text:r.i18n.getText("tileHasNoActions"),enabled:false});o.addButton(n);}else{for(i=0;i<b.length;i++){d=b[i];h=(function(d){return function(){t._handleActionPress(d,T);};}(d));c=new B({text:d.text,icon:d.icon,press:h});o.addButton(c);}}j=e.getSource().getActionSheetIcon?e.getSource().getActionSheetIcon():undefined;if(j){o.openBy(j);}else{var M=sap.ui.getCore().byId(e.getSource().getId()+"-action-more");if(M){o.openBy(M);}else{o.openBy(e.getSource());}}};a.prototype._handleActionPress=function(o,t){if(o.press){o.press.call(o,t);}else if(o.targetURL){if(o.targetURL.indexOf("#")===0){hasher.setHash(o.targetURL);}else{window.open(o.targetURL,"_blank");}}else{sap.ui.require(["sap/m/MessageToast"],function(M){M.show("No Action");});}};return new a();},true);
