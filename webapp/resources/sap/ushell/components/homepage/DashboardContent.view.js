// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/library","sap/m/Page","sap/ui/core/AccessibleLandmarkRole","sap/ui/core/mvc/View","sap/ui/Device","sap/ui/model/Filter","sap/ushell/components/homepage/ComponentKeysHandler","sap/ushell/components/homepage/DashboardGroupsBox","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/ushell/resources","sap/ushell/ui/launchpad/AnchorItem","sap/ushell/ui/launchpad/AnchorNavigationBar","sap/ushell/utils","sap/ui/core/Component","sap/ui/model/FilterOperator"],function(q,m,P,A,V,D,F,C,a,b,E,c,r,d,e,u,f,g){"use strict";sap.ui.jsview("sap.ushell.components.homepage.DashboardContent",{createContent:function(o){this.oModel=this.getModel();var h=this.oModel.getProperty("/personalization"),H=sap.ushell.components.getHomepageManager?sap.ushell.components.getHomepageManager():undefined;this.isCombi=D.system.combi;this.isTouch=this.isCombi?false:(D.system.phone||D.system.tablet);this.parentComponent=f.getOwnerComponentFor(this);this.addStyleClass("sapUshellDashboardView");this.ieHtml5DnD=h&&H&&H.isIeHtml5DnD();this.oRenderer=sap.ushell.Container.getRenderer("fiori2");sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","contentRefresh",this._onDashboardShown,this);this.oDoable=E.once("CoreResourcesComplementLoaded").do(function(){this.oAnchorNavigationBar.setOverflowEnabled(true);if(h){sap.ui.require(["sap/ushell/components/homepage/ActionMode"],function(j){j.init(this.oModel);}.bind(this));this._createFooter();this._createActionModeMenuButton();}}.bind(this));this.oRenderer.getRouter().getRoute("home").attachMatched(this._onDashboardShown,this);this.oAnchorNavigationBar=this._getAnchorNavigationBar(o);var i=new a();this.oDashboardGroupsBox=i.createGroupsBox(o,this.oModel);this.oFilterSelectedGroup=new F("isGroupSelected",g.EQ,true);this.oPage=new P("sapUshellDashboardPage",{customHeader:this.oAnchorNavigationBar,landmarkInfo:{headerRole:A.Navigation},floatingFooter:true,content:[this.oDashboardGroupsBox]});this.oPage.addEventDelegate({onAfterRendering:function(){var j=this.getDomRef(),s=j.getElementsByTagName("section");q(s[0]).off("scrollstop",o.handleDashboardScroll);q(s[0]).on("scrollstop",o.handleDashboardScroll);}.bind(this)});return this.oPage;},getAnchorItemTemplate:function(){var t=this,h=b.last("/core/extension/enableHelp");var o=new d({index:"{index}",title:"{title}",groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",writeHelpId:h,selected:false,isGroupRendered:"{isRendered}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(i,j,v){if(!v[i?1:0]){return false;}return j||i;}},locked:"{isGroupLocked}",isGroupDisabled:{parts:["isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(i,I,s){return i&&I&&s==="tabs";}},press:function(i){t.oAnchorNavigationBar.handleAnchorItemPress(i);}});o.attachBrowserEvent("focus",function(){this.setNavigationBarItemsVisibility();}.bind(this.oAnchorNavigationBar));return o;},_getAnchorNavigationBar:function(o){var h=new e("anchorNavigationBar",{selectedItemIndex:"{/topGroupInViewPortIndex}",itemPress:[function(i){this._handleAnchorItemPress(i);},o],overflowEnabled:false});h.addEventDelegate({onsapskipforward:function(i){i.preventDefault();c.setIsFocusHandledByAnotherHandler(true);C.goToTileContainer(i,this.bGroupWasPressed);this.bGroupWasPressed=false;},onsapskipback:function(i){i.preventDefault();c.setIsFocusHandledByAnotherHandler(true);c.sendFocusBackToShell(i);},onsapenter:function(i){i.srcControl.getDomRef().click();},onsapspace:function(i){i.srcControl.getDomRef().click();}});h.addStyleClass("sapContrastPlus");return h;},_actionModeButtonPress:function(){this.oDashboardGroupsBox.getBinding("groups").filter([]);var h=this.oDashboardGroupsBox.getGroups();sap.ushell.components.homepage.ActionMode.toggleActionMode(this.oModel,"Menu Item",h);this.oAnchorNavigationBar.updateVisibility();if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){if(this.oModel.getProperty("/tileActionModeActive")){var G=this.oModel.getProperty("/groups"),s;for(var i=0;i<G.length;i++){if(G[i].isGroupSelected){s=i;break;}}this.getController()._scrollToGroup("launchpad","scrollToGroup",{group:{getGroupId:function(){return G[s].groupId;}},groupChanged:false,focus:true});}else{this.getController()._deactivateActionModeInTabsState();}}},_createActionModeMenuButton:function(){var o={id:"ActionModeBtn",text:r.i18n.getText("activateEditMode"),icon:"sap-icon://edit",press:this._actionModeButtonPress.bind(this)};this.oTileActionsButton=sap.ui.getCore().byId(o.id);if(this.oTileActionsButton){this.oTileActionsButton.setTooltip(o.text);this.oTileActionsButton.setText(o.text);this.oTileActionsButton.attachPress(o.press);}else{var h={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:o,bIsVisible:true,aStates:["home"]};this.oRenderer.addUserAction(h).done(function(i){this.oTileActionsButton=i;if(b.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}}.bind(this));}},_handleEditModeChange:function(){if(this.oTileActionsButton){this.oTileActionsButton.toggleStyleClass("sapUshellAcionItemActive");}},_createFooter:function(){sap.ui.require(["sap/m/Bar","sap/m/Button","sap/m/ToolbarSpacer","sap/ui/core/InvisibleText"],function(B,h,T,I){var o=new B("sapUshellDashboardFooter",{visible:"{/tileActionModeActive}",contentRight:[new T()]});if(!this.oDoneBtnLabel){this.oDoneBtnLabel=new I({text:r.i18n.getText("exitEditMode")});this.oDoneBtnLabel.toStatic();}var i=new h("sapUshellDashboardFooterDoneBtn",{type:m.ButtonType.Emphasized,text:r.i18n.getText("closeEditMode"),ariaLabelledBy:this.oDoneBtnLabel.getId(),press:this._actionModeButtonPress.bind(this)});i.addEventDelegate({onsapskipforward:function(j){j.preventDefault();c.setIsFocusHandledByAnotherHandler(true);c.sendFocusBackToShell(j);},onsapskipback:function(j){j.preventDefault();c.setIsFocusHandledByAnotherHandler(true);C.goToFirstVisibleTileContainer();},onsaptabprevious:function(j){j.preventDefault();c.setIsFocusHandledByAnotherHandler(true);C.goToFirstVisibleTileContainer();},onsaptabnext:function(j){j.preventDefault();c.setIsFocusHandledByAnotherHandler(true);c.sendFocusBackToShell(j);}});o.addContentRight(i);this.oPage.setFooter(o);}.bind(this));},_onDashboardShown:function(){var i=this.oRenderer&&this.oRenderer.getCurrentCoreView()==="home";if(i){if(!D.system.phone){this.oRenderer.showRightFloatingContainer(false);}u.handleTilesVisibility();u.refreshTiles();C.goToTileContainer();}},getControllerName:function(){return"sap.ushell.components.homepage.DashboardContent";},exit:function(){V.prototype.exit.apply(this,arguments);if(this.oAnchorNavigationBar){this.oAnchorNavigationBar.handleExit();this.oAnchorNavigationBar.destroy();}if(this.oTileActionsButton){this.oTileActionsButton.destroy();}if(this.oDoable){this.oDoable.off();}if(this.oDoneBtnLabel){this.oDoneBtnLabel.destroy();}sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRefresh",this._onDashboardShown,this);}});},false);
