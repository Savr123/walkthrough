// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_AppState/WindowAdapter","sap/ushell/services/_AppState/SequentializingAdapter","sap/ushell/services/_AppState/AppState","sap/ushell/services/_AppState/Sequentializer","sap/ushell/utils","sap/ui/thirdparty/jquery"],function(W,S,A,a,u,q){"use strict";function g(c){return u.isDefined(c)&&u.isDefined(c.transient)?!!c.transient:true;}function b(o,c,p,C){this._oConfig=C&&C.config;this._sSessionKey="";this._oAdapter=new S(o);this._oAdapter=new W(this,this._oAdapter,C);}b.prototype._getSessionKey=function(){if(!this._sSessionKey){this._sSessionKey=this._getGeneratedKey();}return this._sSessionKey;};b.prototype.getAppState=function(k){var d=new q.Deferred(),t=this,o;this._loadAppState(k).done(function(k,D,p,P){o=new A(t,k,false,D,undefined,undefined,undefined,p,P);d.resolve(o);}).fail(function(){o=new A(t,k);d.resolve(o);});return d.promise();};b.prototype._getGeneratedKey=function(){var s=sap.ushell.Container.getService("Personalization").getGeneratedKey();s=("AS"+s).substring(0,40);return s;};b.prototype.createEmptyAppState=function(c,t,p,P){var k=this._getGeneratedKey(),o,s="",d="",U=u.isDefined(t)?t:g(this._oConfig),e=this.getSupportedPersistencyMethods();if(p!==undefined){var i=e.find(function(f){return f===p;});if(!i){throw new Error("PersistencyMethod "+p+" is not supported");}}if(c){if(!(c instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}if(c.getMetadata&&c.getMetadata()&&typeof c.getMetadata().getName==="function"){s=c.getMetadata().getName()||"";}if(!s&&c.getMetadata&&c.getMetadata().getComponentName){s=c.getMetadata().getComponentName();}if(c.getMetadata&&c.getMetadata()&&typeof c.getMetadata().getManifest==="function"&&typeof c.getMetadata().getManifest()==="object"&&typeof c.getMetadata().getManifest()["sap.app"]==="object"){d=c.getMetadata().getManifest()["sap.app"].ach||"";}}if(U===true){p=P=undefined;}else if(p===undefined){if(e.PersonalState!==undefined){p=e.PersonalState;}}o=new A(this,k,true,undefined,s,d,U,p,P);return o;};b.prototype.createEmptyUnmodifiableAppState=function(){var k=this._getGeneratedKey(),o;o=new A(this,k,false);return o;};b.prototype._saveAppState=function(k,d,s,c,t,p,P){var e=this._getSessionKey(),U=u.isDefined(t)?t:g(this._oConfig);return this._oAdapter.saveAppState(k,e,d,s,c,U,p,P);};b.prototype._loadAppState=function(k){return this._oAdapter.loadAppState(k);};b._getSequentializer=function(){return new a();};b.prototype.getSupportedPersistencyMethods=function(){if(this._oAdapter.getSupportedPersistencyMethods){return this._oAdapter.getSupportedPersistencyMethods();}return[];};b.prototype.makeStatePersistent=function(k,p,P){return new Promise(function(r,R){this.getAppState(k).done(function(o){if(o._iPersistencyMethod!==p||JSON.stringify(o._oPersistencySettings)!==JSON.stringify(P)){o.bTransient=false;o._iPersistencyMethod=p;o._oPersistencySettings=P;this._saveAppState(k,o._sData,o._sAppName,o._sACHComponent,false,p,P).done(function(){r();}).fail(function(){R();});}else{r();}}).fail(function(){R();});});};b.WindowAdapter=W;b.hasNoAdapter=false;return b;},true);
