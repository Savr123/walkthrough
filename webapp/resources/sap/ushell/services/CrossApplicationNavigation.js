// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/services/_CrossApplicationNavigation/utils","sap/ushell/utils/type","sap/ushell/TechnicalParameters","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/base/util/isPlainObject","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/merge","sap/ushell/utils","sap/ushell/library"],function(a,u,t,T,A,i,U,q,O,m,b){"use strict";function C(c,p,s){var o,S;if(s&&s.config){S=s.config;}function g(v,e){var r,f,h;if(typeof v!=="string"&&!i(v)&&v!==undefined){q.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(v===undefined){return undefined;}var n;if(e){if(typeof e.getComponentData!=="function"||!i(e.getComponentData())||!e.getComponentData().startupParameters||!i(e.getComponentData().startupParameters)){q.sap.log.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation");}else{h=e.getComponentData().startupParameters;if(h.hasOwnProperty("sap-system")){f=h["sap-system"][0];}if(h.hasOwnProperty("sap-ushell-next-navmode")){n=h["sap-ushell-next-navmode"][0];}}}else{r=a.getCurrentApplication();if(r&&r["sap-system"]){f=r["sap-system"];}else if(r&&r.url){f=new U(r.url).get("sap-system");}if(r&&r["sap-ushell-next-navmode"]){n=r["sap-ushell-next-navmode"];}else if(r&&r.url){n=new U(r.url).get("sap-ushell-next-navmode");}}var I=u._injectParameters({type:t,inject:{"sap-system":f,"sap-ushell-navmode":n},args:v});return I;}function d(v){var e,f,h;if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return v;}if(!S||!S["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return v;}}if(typeof v!=="string"&&!i(v)&&v!==undefined){q.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(v===undefined){return undefined;}if(i(v)){f=q.extend(true,{},v);if(f.target&&f.target.shellHash){if(typeof f.target.shellHash==="string"){if(f.target.shellHash!=="#"&&f.target.shellHash!==""){f.target.shellHash=d(f.target.shellHash);}}return f;}f.params=f.params||{};f.params["sap-ushell-enc-test"]=["A B%20C"];return f;}h=v;if(!/[?&]sap-system=/.test(h)){e=(h.indexOf("?")>-1)?"&":"?";h+=e+"sap-ushell-enc-test="+encodeURIComponent("A B%20C");}return h;}this._extractInnerAppRoute=function(I){var e=this,P,f;if(typeof I==="string"){P=I.split("&/");f=P.shift();return{intent:f,innerAppRoute:P.length>0?"&/"+P.join("&/"):""};}if(Object.prototype.toString.apply(I)==="[object Object]"){var h=O.get("target.shellHash",I);if(typeof h==="string"){var r=e._extractInnerAppRoute(h);I.target.shellHash=r.intent;return{intent:I,innerAppRoute:r.innerAppRoute};}if(I.hasOwnProperty("appSpecificRoute")){var v=I.appSpecificRoute;delete I.appSpecificRoute;var j=typeof v==="string"&&v.indexOf("&/")!==0&&v.length>0;return{innerAppRoute:j?"&/"+v:v,intent:I};}return{intent:I,innerAppRoute:""};}q.sap.log.error("Invalid input parameter","expected string or object","sap.ushell.services.CrossApplicationNavigation");return{intent:I};};this._injectInnerAppRoute=function(I,e){var f,h=this;if(!e){return I;}if(typeof I==="string"){return I+e;}if(Object.prototype.toString.apply(I)==="[object Object]"){f=O.get("target.shellHash",I);if(typeof f==="string"){I.target.shellHash=h._injectInnerAppRoute(f,e);return I;}I.appSpecificRoute=e;}return I;};this.hrefForExternal=function(e,f,h){var j,E,I;if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){j=m({},e);E=this._extractInnerAppRoute(j);I=E.intent;u.addXAppStateFromParameter(I,"sap-xapp-state-data");j=g(I,f);j=u._injectStickyParameters({args:j,appLifeCycle:A,technicalParameters:T,type:t});j=d(j);j=this._injectInnerAppRoute(j,E.innerAppRoute);return sap.ushell.Container.getService("ShellNavigation").hrefForExternal(j,undefined,f,h);}q.sap.log.debug("Shell not available, no Cross App Navigation");if(h){return(new q.Deferred()).resolve("").promise();}return"";};this.expandCompactHash=function(h){return sap.ushell.Container.getService("NavTargetResolution").expandCompactHash(h);};this.backToPreviousApp=function(){if(this.isInitialNavigation()){this.toExternal({target:{shellHash:"#"},writeHistory:false});return;}this.historyBack();};this.historyBack=function(e){var f=-1;if(e&&typeof e==="number"){if(e<=0){q.sap.log.warning("historyBack called with an argument <= 0 and will result in a forward navigation or refresh","expected was an argument > 0","sap.ushell.services.CrossApplicationNavigation#historyBack");}f=e*-1;}window.history.go(f);};this.isInitialNavigation=function(){var e=sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation");if(!e){q.sap.log.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true;}var I=e.isInitialNavigation();if(typeof I==="undefined"){return true;}return I;};this.toExternal=function(e,f){var h,E,I,w=e.writeHistory;if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){h=m({},e);this._processShellHashWithParams(h);E=this._extractInnerAppRoute(h);I=E.intent;u.addXAppStateFromParameter(I,"sap-xapp-state-data");h=g(I,f);h=u._injectStickyParameters({args:h,appLifeCycle:A,technicalParameters:T,type:t});h=d(h);delete h.writeHistory;h=this._injectInnerAppRoute(h,E.innerAppRoute);sap.ushell.Container.getService("ShellNavigation").toExternal(h,f,w);return;}q.sap.log.debug("Shell not avialable, no Cross App Navigation");return;};this.hrefForAppSpecificHash=function(e){if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){return sap.ushell.Container.getService("ShellNavigation").hrefForAppSpecificHash(e);}q.sap.log.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(e);};this.getPrimaryIntent=function(e,P){var Q={},f,r=/^#\w+-displayFactSheet(?:$|\?.)/;Q.tags=["primaryAction"];Q.semanticObject=e;if(P){Q.params=P;}return this.getLinks(Q).then(function(l){if(l.length===0){delete Q.tags;Q.action="displayFactSheet";f=function(L,h){var E;if(L.intent===h.intent){return 0;}E=r.test(L.intent)^r.test(h.intent);if(E){return r.test(L.intent)?-1:1;}return L.intent<h.intent?-1:1;};return this.getLinks(Q);}f=function(L,h){if(L.intent===h.intent){return 0;}return L.intent<h.intent?-1:1;};return l;}.bind(this)).then(function(l){return l.length===0?null:l.sort(f)[0];});};this.getSemanticObjectLinks=function(e,P,I,f,h,j){var k,l,E;k=u._injectStickyParameters({args:{params:P},appLifeCycle:A,technicalParameters:T,type:t});k=g(k,f).params;k=d({params:k}).params;l=sap.ushell.Container.getService("NavTargetResolution");var v;if(Array.isArray(e)){v=[];e.forEach(function(n){v.push([{semanticObject:n[0],params:n[1],ignoreFormFactor:!!n[2],ui5Component:n[3],appStateKey:n[4],compactIntents:!!(n[5])}]);});}else{v={semanticObject:e,params:k,ignoreFormFactor:I,ui5Component:f,appStateKey:h,compactIntents:!!j};}E=b.invokeUnfoldingArrayArguments(l.getLinks.bind(l),[v]);return E;};this.getLinks=function(v){var e;e=b.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[v]);return e;};this._getLinks=function(n){var N,P,e,f=sap.ushell.Container.getService("NavTargetResolution");if(typeof n==="undefined"){n={};}N=q.extend(true,{},n);N.compactIntents=!!N.compactIntents;N.action=N.action||undefined;N.paramsOptions=u.extractGetLinksParameterOptions(N.params);N=u._injectStickyParameters({args:N,appLifeCycle:A,technicalParameters:T,type:t});P=N.params?u.extractGetLinksParameterDefinition(N.params):N.params;e=g({params:P},N.ui5Component).params;e=d({params:e}).params;if(N.appStateKey){e["sap-xapp-state"]=[N.appStateKey];delete N.appStateKey;}N.params=e;return f.getLinks(N);};this.getDistinctSemanticObjects=function(){var e=sap.ushell.Container.getService("NavTargetResolution");return e.getDistinctSemanticObjects();};this.isIntentSupported=function(I,e){var D=new q.Deferred(),f={},h=I.map(function(j){var k=g(j,e);f[k]=j;return k;});sap.ushell.Container.getService("NavTargetResolution").isIntentSupported(h).done(function(j){var k={};Object.keys(j).forEach(function(K){k[f[K]]=j[K];});D.resolve(k);}).fail(D.reject.bind(D));return D.promise();};this.isNavigationSupported=function(I,e){var f=I.map(function(h){return g(h,e);});return sap.ushell.Container.getService("NavTargetResolution").isNavigationSupported(f);};this.isUrlSupported=function(e){var D=new q.Deferred(),f,h;if(typeof e!=="string"){D.reject();return D.promise();}f=sap.ushell.Container.getService("URLParsing");if(f.isIntentUrl(e)){h=f.getHash(e);this.isIntentSupported(["#"+h]).done(function(r){if(r["#"+h]&&r["#"+h].supported){D.resolve();}else{D.reject();}}).fail(function(){D.reject();});}else{D.resolve();}return D.promise();};this.createComponentInstance=function(I,e,f){var h,j,k,l;if(!e){e={};}else{l=Object.keys(e).length;if(l>1||(l===1&&!e.componentData)){throw"`oConfig` argument should either be an empty object or contain only the `componentData` property.";}}if(e.componentData){delete e.componentData.startupParameters;delete e.componentData.config;delete e.componentData["sap-xapp-state"];}h=sap.ushell.Container;j=h.getService("URLParsing");k=j.constructShellHash(j.parseShellHash(I));if(!k){return new q.Deferred(function(D){D.reject("Navigation intent invalid!");}).promise();}return h.getService("NavTargetResolution").resolveHashFragment("#"+k).then(function(r){if(r.applicationType!==sap.ushell.components.container.ApplicationType.URL&&!(/^SAPUI5\.Component=/.test(r.additionalInformation))){return new q.Deferred(function(D){D.reject("The resolved target mapping is not of type UI5 component.");}).promise();}r=q.extend(true,{},r,e);if(!r.ui5ComponentName&&r.additionalInformation){r.ui5ComponentName=r.additionalInformation.replace(/^SAPUI5\.Component=/,"");}return new q.Deferred(function(D){var n=h.getService("Ui5ComponentLoader");if(f){f.runAsOwner(function(){v(r);});}else{v(r);}function v(w){w.loadDefaultDependencies=false;n.createComponent(w).then(function(x){D.resolve(x.componentHandle.getInstance());},function(E){E=E||"";q.sap.log.error("Cannot create UI5 component: "+E,E.stack,"sap.ushell.services.CrossApplicationNavigation");D.reject(E);});}}).promise();});};this.createEmptyAppState=function(e,f,P,h){if(!o){o=sap.ushell.Container.getService("AppState");}if(!(e instanceof sap.ui.core.UIComponent)){throw new Error("oAppComponent passed must be a UI5 Component");}return o.createEmptyAppState(e,f,P,h);};this.getStartupAppState=function(e){this._checkComponent(e);var f=e.getComponentData()&&e.getComponentData()["sap-xapp-state"]&&e.getComponentData()["sap-xapp-state"][0];return this.getAppState(e,f);};this._checkComponent=function(e){if(!(e instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}};this.getAppState=function(e,f){var h,D=new q.Deferred();this._checkComponent(e);if(!o){o=sap.ushell.Container.getService("AppState");}if(typeof f!=="string"){if(f!==undefined){q.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){h=o.createEmptyUnmodifiableAppState(e);D.resolve(h);},0);return D.promise();}return o.getAppState(f);};this.getAppStateData=function(e){return b.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[e]);};this._getAppStateData=function(e){var D=new q.Deferred();if(!o){o=sap.ushell.Container.getService("AppState");}if(typeof e!=="string"){if(e!==undefined){q.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){D.resolve(undefined);},0);}else{o.getAppState(e).done(function(f){D.resolve(f.getData());}).fail(D.resolve.bind(D,undefined));}return D.promise();};this.saveMultipleAppStates=function(e){var r=[],D=new q.Deferred();e.forEach(function(f){r.push(f.save());});q.when.apply(this,r).done(function(){D.resolve(r);}).fail(function(){D.reject("save failed");});return D.promise();};this._processShellHashWithParams=function(e){var f,h;if(e&&e.processParams===true&&e.target&&e.target.shellHash&&e.params){f=sap.ushell.Container.getService("URLParsing");h=f.parseShellHash(e.target.shellHash);e.target={semanticObject:h.semanticObject,action:h.action,contextRaw:h.contextRaw};e.appSpecificRoute=h.appSpecificRoute;e.params=Object.assign({},e.params,h.params);}};this.getSupportedAppStatePersistencyMethods=function(){if(!o){o=sap.ushell.Container.getService("AppState");}return o.getSupportedPersistencyMethods();};this.makeStatePersistent=function(k,P,e){if(!o){o=sap.ushell.Container.getService("AppState");}return o.makeStatePersistent(k,P,e);};}C.hasNoAdapter=true;return C;},true);
