// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/Control","sap/ui/performance/Measurement","sap/base/util/uid"],function(u,S,U,a,E,b,C,M,c){"use strict";var d="sap.ushell.services.Container",f="sap.ushell.Container.dirtyState.",o,p,F;function g(){close();}function r(){document.location="about:blank";}function h(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function j(s){return(o.services&&o.services[s])||{};}function k(n,s,P,A){var e=j(n).adapter||{},i=e.module||h(s.getPlatform())+"."+n+"Adapter";function q(){return new(jQuery.sap.getObject(i))(s,P,{config:e.config||{}});}if(A){return new Promise(function(t,v){var w=i.replace(/\./g,"/");sap.ui.require([w],function(){try{t(q());}catch(x){v(x);}});});}jQuery.sap.require(i);return q();}function l(A){var n=new E(),q=false,R=[],s={},t="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",v={},G,w,L=u.getLocalStorage(),x=new u.Map(),y="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",z=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e,i){var H,I,J;M.start("FLP:Container.InitLoading","Initial Loading","FLP");u.setPerformanceMark("FLP - renderer created");e=e||o.defaultRenderer;if(!e){throw new Error("Missing renderer name");}J=(o.renderers&&o.renderers[e])||{};I=J.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(J.componentData&&J.componentData.config){H={config:J.componentData.config};}function K(){var N=new(jQuery.sap.getObject(I))({componentData:H}),O=N instanceof sap.ui.core.UIComponent?new sap.ui.core.ComponentContainer({component:N,height:"100%",width:"100%"}):N;if(!(O instanceof C)){throw new Error("Unsupported renderer type for name "+e);}O.placeAt=function(P,Q){var T=P,V="canvas",W=document.body;if(P===W.id){T=document.createElement("div");T.setAttribute("id",V);T.classList.add("sapUShellFullHeight");switch(Q){case"first":if(W.firstChild){W.insertBefore(T,W.firstChild);break;}case"only":W.innerHTML="";default:W.appendChild(T);}P=V;Q="";}C.prototype.placeAt.call(this,P,Q);};s[e]=N;n.fireEvent("rendererCreated",{renderer:N});return O;}if(i){return new Promise(function(N,O){var P=I.replace(/\./g,"/");sap.ui.require([P],function(){try{N(K());}catch(Q){O(Q);}});});}jQuery.sap.require(I);return K();};this.getRenderer=function(e){var i,H;e=e||o.defaultRenderer;if(e){i=s[e];}else{H=Object.keys(s);if(H.length===1){i=s[H[0]];}else{jQuery.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,d);}}if(i&&i.isA("sap.ui.core.ComponentContainer")){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,H=new jQuery.Deferred(),I=c(),J,P=0,K=this.DirtyState.CLEAN;function N(){if(P===0||K===z.DirtyState.DIRTY){H.resolve(K);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+K,null,"sap.ushell.Container");}}function O(Q){if(Q.key.indexOf(f)===0&&Q.newValue!==z.DirtyState.INITIAL&&Q.newValue!==z.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+Q.key+" value: "+Q.newValue,null,"sap.ushell.Container");if(Q.newValue===z.DirtyState.DIRTY||Q.newValue===z.DirtyState.MAYBE_DIRTY){K=Q.newValue;}P-=1;N();}}try{L.setItem(I,"CHECK");L.removeItem(I);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return H.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=H;window.addEventListener("storage",O);H.always(function(){window.removeEventListener("storage",O);G=undefined;});for(i=L.length-1;i>=0;i-=1){J=L.key(i);if(J.indexOf(f)===0){if(L.getItem(J)==="PENDING"){L.removeItem(J);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+J,null,"sap.ushell.Container");}else{P+=1;u.localStorageSetItem(J,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+J,null,"sap.ushell.Container");}}}N();setTimeout(function(){if(H.state()!=="resolved"){H.resolve("MAYBE_DIRTY");jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return H.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){q=q||R[i].call();}return q;};this.setDirtyFlag=function(i){q=i;};this.sessionKeepAlive=function(){if(A.sessionKeepAlive){A.sessionKeepAlive();}};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}R.push(e);};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}var H=-1;for(var i=R.length-1;i>=0;i--){if(R[i]===e){H=i;break;}}if(H===-1){return;}R.splice(H,1);};this.getService=function(e,P,i){var H={},I,K,J,N,O,Q;function T(X){var Y=new jQuery.Deferred();if(!X){throw new Error("Missing system");}Y.resolve(k(e,X,P));sap.ushell.Container.addRemoteSystem(X);return Y.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}O=j(e);I=O.module||"sap.ushell.services."+e;K=I+"/"+(P||"");Q={config:O.config||{}};function V(X,N){H.createAdapter=T;return new X(N,H,P,Q);}function W(J,i){var X;if(J.hasNoAdapter){X=new J(H,P,Q);}else{N=k(e,A.getSystem(),P,i);if(i){return N.then(function(Y){var X=V(J,Y);x.put(K,X);return X;});}X=V(J,N);}x.put(K,X);return i?Promise.resolve(X):X;}if(!x.containsKey(K)){if(i){return new Promise(function(X){sap.ui.require([I.replace(/[.]/g,"/")],function(Y){X(W(Y,true));});});}J=sap.ui.requireSync(I.replace(/[.]/g,"/"));return W(J);}if(i){return Promise.resolve(x.get(K));}return x.get(K);};this.getServiceAsync=function(e,P){return Promise.resolve(this.getService(e,P,true));};function B(){var H,I,i,K;for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(t)===0){try{H=K.substring(t.length);I=JSON.parse(L.getItem(K));v[H]=new S(I);}catch(e){L.removeItem(K);}}}return v;}function D(){if(typeof OData==="undefined"){return;}function e(i,H,I){jQuery.sap.log.warning(i,null,"sap.ushell.Container");if(I){setTimeout(I.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,H,I){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",H,I);};OData.request=function(i,H,I){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",H,I);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=v[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}v[i]=e;u.localStorageSetItem(t+i,e);};this.addRemoteSystemForServiceUrl=function(e){var i,H={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return;}i=/^[^?]*;o=([^\/;?]*)/.exec(e);if(i&&i.length>=2){H.alias=i[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){H.platform="hana";H.alias=H.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){H.platform="abap";}if(H.alias&&H.platform){this.addRemoteSystem(new S(H));}};this.attachLogoutEvent=function(e){n.attachEvent("Logout",e);};this.detachLogoutEvent=function(e){n.detachEvent("Logout",e);};this.attachRendererCreatedEvent=function(e){n.attachEvent("rendererCreated",e);};this.detachRendererCreatedEvent=function(e){n.detachEvent("rendererCreated",e);};this.defaultLogout=function(){var i=new jQuery.Deferred();function H(){A.logout(true).always(function(){L.removeItem(y);i.resolve();});}function I(){if(n.fireEvent("Logout",true)){H();}else{setTimeout(H,1000);}}function J(){var v,K=[];if(w){window.removeEventListener("storage",w);}u.localStorageSetItem(y,"pending");z._suppressOData();v=z._getRemoteSystems();Object.keys(v).forEach(function(N){try{K.push(k("Container",v[N]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+N,e.toString(),"sap.ushell.Container");}L.removeItem(t+N);});jQuery.when.apply(jQuery,K).done(I);}if(typeof A.addFurtherRemoteSystems==="function"){A.addFurtherRemoteSystems().always(J);}else{J();}return i.promise();};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e;};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e;}};this.setXhrLogonTimeout=function(P,T){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(P,T);}};this.getFLPUrl=function(i){var e=u.getLocationHref(),H=e.indexOf(this.getService("URLParsing").getShellHash(e));if(H===-1||i===true){return e;}return e.substr(0,H-1);};this._closeWindow=g;this._redirectWindow=r;this._getRemoteSystems=B;this._suppressOData=D;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,H){z.addRemoteSystemForServiceUrl(H);});if(typeof A.logoutRedirect==="function"){w=function(e){function i(){z._closeWindow();z._redirectWindow();}if(sap.ushell.Container!==z){return;}if(e.key.indexOf(t)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===y){if(e.newValue==="pending"){z._suppressOData();if(n.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener("storage",w);}this._getFunctionsForUnitTest=function(){return{createAdapter:k};};}function m(s,A){s.forEach(function(e){var i=U.createServiceFactory(e,A);b.register("sap.ushell.ui5service."+e,i);});}function _(s){s.forEach(function(e){var i=a.createServiceFactory(e);b.register("sap.ushell.ui5service."+e,i);});}sap.ushell.bootstrap=function(P,A){var e,D=new jQuery.Deferred();jQuery.sap.initMobile();if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+F);jQuery.sap.log.error(e,e.stack,d);throw e;}F=(new Error()).stack;o=jQuery.extend({},true,window["sap-ushell-config"]||{});p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(o.modulePaths){Object.keys(o.modulePaths).forEach(function(i){jQuery.sap.registerModulePath(i,o.modulePaths[i]);});}m(["Personalization","URLParsing","CrossApplicationNavigation"],true);m(["Configuration"],false);_(["CardNavigation","CardUserRecents","CardUserFrequents"]);var s=new S({alias:"",platform:o.platform||P});k("Container",s,null,true).then(function(i){i.load().then(function(){function n(){var t,v;var w=window["sap-ushell-config"];if(!w||!w.services){return false;}t=w.services.PluginManager;v=t&&t.config;return v&&v.loadPluginsFromSite;}sap.ushell.Container=new l(i);var q=[sap.ushell.Container.getServiceAsync("PluginManager")];if(n()){q.push(sap.ushell.Container.getServiceAsync("CommonDataModel"));}Promise.all(q).then(function(t){var v=t[0],w=t[1];var x=w?w.getPlugins():jQuery.when({});x.then(function(y){var z=jQuery.extend(true,{},o.bootstrapPlugins,y);v.registerPlugins(z);});}).then(function(){if(u.hasFLPReadyNotificationCapability()){u.getPrivateEpcm().doEventFlpReady();}});D.resolve();});});return D.promise();};});
