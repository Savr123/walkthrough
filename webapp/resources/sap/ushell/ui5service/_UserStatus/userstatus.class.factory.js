// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/EventProvider","sap/ushell/ui/launchpad/UserStatusItem","sap/base/util/isPlainObject","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/m/Popover","sap/m/library","sap/ui/core/IconPool","sap/ui/Device","sap/m/Label","sap/ushell/resources","sap/m/Switch","sap/m/FlexBox","sap/m/Text","sap/ui/layout/VerticalLayout","sap/m/Button","sap/m/Dialog"],function(E,U,i,V,q,P,m,I,D,L,r,S,F,T,a,B,b){"use strict";var c=m.SwitchType;var d=m.PlacementType;return function(s){var f=s.serviceRegistry,g=s.serviceFactory,h=s.service,o=new E(),O={statusChanged:"statusChanged",serviceStateChanged:"serviceStateChanged"},A;var j=h.extend("sap.ushell.ui5service.UserStatus",{init:function(){var t=this,p=this.getInterface();j.prototype.isEnabled=false;p.init=function(){t._amendPublicServiceInstance.call(t,this);};f.register("sap.ushell.ui5service.UserStatus",new g(p));j.prototype.AvailableStatus={AVAILABLE:"AVAILABLE",AWAY:"AWAY",BUSY:"BUSY",APPEAR_OFFLINE:"APPEAR_OFFLINE"};},_setActiveComponentId:function(e){A=e;},_getActiveComponentId:function(){return A;},_getEventProvider:function(){return o;},_ensureArrayOfObjectOfStrings:function(v,M){var e=q.isArray(v)&&v.every(function(k){return q.isPlainObject(k)&&Object.keys(k).length>0&&Object.keys(k).every(function(K){return typeof k[K]==="string";});});if(!e){q.sap.log.error("'"+M+"' was called with invalid parameters","An array of non-empty objects with string values is expected","sap.ushell.ui5service.UserStatus");}return e;},_ensureFunction:function(v,M){var t=typeof v;if(t!=="function"){q.sap.log.error("'"+M+"' was called with invalid arguments","the parameter should be a function, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_ensureString:function(v,M){var t=typeof v;if(t!=="string"){q.sap.log.error("'"+M+"' was called with invalid arguments","the parameter should be a string, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_addCallAllowedCheck:function(p,e){var t=this;p[e]=function(){var C=p.getContext();if(!C||C.scopeObject.getId()!==A){q.sap.log.warning("Call to "+e+" is not allowed","This may be caused by an app component other than the active '"+A+"' that tries to call the method","sap.ushell.ui5service.UserStatus");return undefined;}return t[e].apply(p,arguments);};},_amendPublicServiceInstance:function(p){var t=this,C;C=p.getContext();if(typeof C==="undefined"){return;}["setStatus","attachStatusChanged","detachStatusChanged"].forEach(function(M){t._addCallAllowedCheck(p,M);});if(C.scopeType==="component"){this._setActiveComponentId(C.scopeObject.getId());return;}q.sap.log.error("Invalid context for UserStatus interface","The context must be empty or an object like { scopeType: ..., scopeObject: ... }","sap.ushell.ui5service.UserStatus");},setEnabled:function(e){o.fireEvent(O.serviceStateChanged,{data:e});j.prototype.isEnabled=e;this._getUserStatusSetting().then(function(u){if(u===undefined||u.userStatusEnabled===undefined){this._showLegalPopup();}else if(u.userStatusEnabled){this.setStatus(u.userStatusDefault);}else if(!u.userStatusEnabled){this.setStatus(null);}}.bind(this));return;},attachEnabledStatusChanged:function(e){this._getEventProvider().attachEvent(O.serviceStateChanged,e);},detachEnabledStatusChanged:function(e){this._getEventProvider().detachEvent(O.serviceStateChanged,e);},setStatus:function(n){if(!j.prototype.isEnabled){throw new Error("Unable to change status because the UserStatus service is disabled.");}if(!j.prototype.AvailableStatus[n]&&n!==null){throw new Error("Enter a valid status.");}this._getUserStatusSetting().then(function(u){if((n!==null)&&(u===undefined||u.userStatusEnabled===undefined||!u.userStatusEnabled)){throw new Error("Unable to change status; user has not explicitly opted-in to share their online status.");}o.fireEvent(O.statusChanged,{data:n});return;});},getUxdVersion:function(){if((new V(sap.ui.version).compareTo("1.37.0"))>=0){return 2;}return 1;},attachStatusChanged:function(e){this._getEventProvider().attachEvent(O.statusChanged,e);},detachStatusChanged:function(e){this._getEventProvider().detachEvent(O.statusChanged,e);},_getOnlineStatusPopOver:function(u){var p=new P({placement:d.Bottom,showArrow:true,showHeader:false,content:[new U({status:U.prototype.STATUS_ENUM.AVAILABLE,isOpener:false,press:function(){e.setStatus(U.prototype.STATUS_ENUM.AVAILABLE);p.close();}}).addStyleClass("sapUserStatusContainer"),new U({status:U.prototype.STATUS_ENUM.AWAY,isOpener:false,press:function(){e.setStatus(U.prototype.STATUS_ENUM.AWAY);p.close();}}).addStyleClass("sapUserStatusContainer"),new U({status:U.prototype.STATUS_ENUM.BUSY,isOpener:false,press:function(){e.setStatus(U.prototype.STATUS_ENUM.BUSY);p.close();}}).addStyleClass("sapUserStatusContainer"),new U({status:U.prototype.STATUS_ENUM.APPEAR_OFFLINE,isOpener:false,press:function(){e.setStatus(U.prototype.STATUS_ENUM.APPEAR_OFFLINE);p.close();}}).addStyleClass("sapUserStatusContainer")]});var e=new U({tooltip:"{i18n>headerActionsTooltip}",enabled:false,ariaLabel:sap.ushell.Container.getUser().getFullName(),image:I.getIconURI("account"),status:u?U.prototype.STATUS_ENUM[u]:U.prototype.STATUS_ENUM.AVAILABLE,press:function(k){var l=sap.ui.getCore().byId(k.mParameters.id);p.openBy(l);},contentList:p}).addStyleClass("sapUserStatusOpener");return e;},_showLegalPopup:function(){var t=this;setTimeout(function(){var k=sap.ui.getCore().getConfiguration().getRTL()?"Left":"Right",l=D.system.phone?"auto":"14rem",n=D.system.phone?"auto":"10rem";var p=new L({text:r.i18n.getText("enableStatusMessageBoxFld")+":",width:l,textAlign:k});var u=new S("enableStatusSwitch",{type:c.Default,change:function(e){x.setEnabled(e.mParameters.state);x.$().attr("tabindex",e.mParameters.state?0:-1);}});var v=new F({alignItems:"Center",direction:"Row",items:[p,u]}).addStyleClass("sapUshellUserStatusFlexBox");var w=new L({text:r.i18n.getText("userStatusMessageBoxDropdownLabelFld")+":",width:n,textAlign:k}).addStyleClass("sapUshellUserStatusSignInAsLabel");var x=t._getOnlineStatusPopOver(U.prototype.STATUS_ENUM.AVAILABLE.status);x.$().attr("tabindex",x.getEnabled()?0:-1);var y=new T({text:r.i18n.getText("userStatusMessageBoxInfoTextLine1")}).addStyleClass("sapUshellUserStatusLegalTextLine").addStyleClass("sapUshellUserStatusLegalTextFirstLine");var z=new T({text:r.i18n.getText("userStatusMessageBoxInfoTextLine2")}).addStyleClass("sapUshellUserStatusLegalTextLine");var C=new F({alignItems:"Center",direction:"Row",items:[w,x]}).addStyleClass("sapUshellUserStatusFlexBox");var G=new a("userStatusDialogLayout",{content:[v,C,y,z]});var H=new B("saveButton",{text:r.i18n.getText("okBtn"),press:function(){t._writeUserStatusSettingToPersonalization({userStatusEnabled:u.getState(),userStatusDefault:u.getState()?x.getStatus().status:null});t.setStatus(u.getState()?x.getStatus().status:null);J.close();}});var J=new b("agreementMessageBox",{title:r.i18n.getText("userStatusAgreementMessageBoxTitle"),modal:true,stretch:D.system.phone,buttons:[H],afterClose:function(e){t._getUserStatusSetting().then(function(K){if(K===undefined||K.userStatusEnabled===undefined){t._writeUserStatusSettingToPersonalization({userStatusEnabled:false,userStatusDefault:null});t.setStatus(null);}J.destroy();});}}).addStyleClass("sapUshellUserStatusDialog");J.addContent(G);J.open();},100);},_getUserStatusSetting:function(){var p=this._getUserSettingsPersonalizer();return p.getPersData();},_writeUserStatusSettingToPersonalization:function(u){var e,p;try{p=this._getUserSettingsPersonalizer().setPersData(u);}catch(k){q.sap.log.error("Personalization service does not work:");q.sap.log.error(k.name+": "+k.message);e=new q.Deferred();e.reject(k);p=e.promise();}return p;},_getUserSettingsPersonalizer:function(){this.oUserPersonalizer=this._createUserPersonalizer();return this.oUserPersonalizer;},_createUserPersonalizer:function(){var p=sap.ushell.Container.getService("Personalization"),C,e={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},k={container:"sap.ushell.services.UserStatus",item:"userStatusData"},l=p.getPersonalizer(k,e,C);return l;}});return j;};});
