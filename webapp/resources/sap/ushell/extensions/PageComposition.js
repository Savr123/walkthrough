// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/extensions/ExtensionHelper","sap/ushell/components/HomepageManager","sap/ushell/extensions/_PageComposition/Factory","sap/ushell/components/homepage/DashboardGroupsBox","sap/ushell/Config","sap/ushell/ui/shell/ShellAppTitle"],function(L,E,H,F,D,C,S){"use strict";var h=sap.ushell.components.getHomepageManager();var s=sap.ui.getCore().byId("shell-header");var d=h.getDashboardView();function _(t){s.setAppTitle(new S({text:t}));}function a(){C.emit("/core/pageComposition/composerState","composing");}function b(){h.getModel().setProperty("/groups",[]);C.emit("/core/pageComposition/composerState","initial");C.emit("/core/pageComposition/currentPageId",null);C.emit("/core/pageComposition/editMode",false);sap.ui.getCore().getEventBus().publish("launchpad","actionModeInactive");}function c(){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(r){r.toExternal({target:{shellHash:"#Shell-compose"}});});}function e(){b();c();}function f(r){var G=r.getSource();var t=G.getHeaderText();a();sap.ui.require(["sap/ushell/extensions/_PageComposition/Factory/TileSelector"],function(T){T.create(T.loadCatalogTileData).selectTiles(t).then(h.addTilesToGroupByCatalogTileId.bind(h,G));});}function g(P){if(!P){return Promise.reject();}return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(r){return r.getPage(P);}).then(function(r){h.importModelData(r);});}function i(){var P=C.last("/core/pageComposition/currentPageId");if(!P){throw Error("No pageId set");}Promise.all([sap.ushell.Container.getServiceAsync("PagePersistence"),sap.ushell.Container.getServiceAsync("PageReferencing")]).then(function(r){var t=r[0];var u=r[1];t.getPage(P).then(function(v){var G=h.exportModelData();return{page:v,groups:G};}).then(function(v){return u.createReferencePage(v.page,v.groups);}).then(function(v){t.updatePage(v);e();}).catch(L.error);},L.error);}function j(){L.trace("User cancelled saving of page");}function k(){var P=sap.ui.getCore().byId("sapUshellDashboardPage");var B=F.createAddGroupButton(function(){var r=sap.ui.getCore().getEventBus();r.publish("launchpad","createGroupAt",{title:"",location:0,isRendered:true});r.publish("launchpad","actionModeActive");},h.getModel());P.insertContent(B,0);}function l(){var r=d.oPage.getFooter();var t=F.createFooterSaveButton(i,j);var u=F.createFooterCloseButton(e);r.removeAllContentLeft();r.removeAllContentMiddle();r.removeAllContentRight();r.insertContentRight(t);r.insertContentRight(u);}function m(P){var t=this;var G=[];P.content.sections.forEach(function(r){var u=t.oPageOperationAdapter.getPreparedGroupModel({title:r.title});u.groupId=r.id;u.tiles=r.visualizations.map(function(T){return t.oPageOperationAdapter.getTileModelByCatalogTileId(T.vizId);});G.push(u);});if(G.length>0){G[G.length-1].isLastGroup=true;}t.getModel().setProperty("/groups",G);}function n(){var t=this,G=this.getModel().getProperty("/groups");function r(T){return{target:t.oPageOperationAdapter.getTileTarget(T),tileCatalogId:T.tileCatalogId};}return G.reduce(function(R,u){R.push({id:u.groupId,title:u.title,tiles:u.tiles.map(r)});return R;},[]);}function o(){E.add(H,"importModelData",m);E.add(H,"exportModelData",n);E.override(H,"isBlindLoading",function(){return true;});E.registerExtension("HomepageManagerExtension",H);}function p(){E.override(D,"_handleAddTileToGroup",f);E.registerExtension("DashboardGroupsBoxExtension",D);}function q(){o();p();l();k();C.emit("/core/home/enableTransientMode",true);_("FLP Page Composer");sap.ui.getCore().getEventBus().subscribe("sap.ushell","appOpened",function(r,t,u){if(u.sShellHash==="Shell-compose"){b();}});C.on("/core/shell/model/currentState/stateName").do(function(r){if(r!=="home"){return;}var P=C.last("/core/pageComposition/currentPageId");if(!P){return;}if(C.last("/core/pageComposition/editMode")){d.oTileActionsButton.firePress();a();g(P).then(function(){sap.ui.getCore().getEventBus().publish("launchpad","actionModeActive");});return;}g(P);});}q();});
