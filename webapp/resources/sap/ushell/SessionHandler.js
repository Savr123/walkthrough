// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/resources","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/json/JSONModel","sap/m/VBox","sap/ui/core/library","sap/ushell/ui/launchpad/LoadingDialog","sap/ui/thirdparty/jquery"],function(r,d,b,t,J,V,c,L,q){"use strict";var a=c.ValueState;var S=function(A){var e=this;this.init=function(C){sap.ushell.Container.registerLogout(this.logout);q.sap.measure.start("SessionTimeoutInit","Inititialize Session Timeout","FLP_SHELL");this.config=C;this.oModel=new J();if(this.config.enableAutomaticSignout===undefined){this.config.enableAutomaticSignout=false;}if(this.config.sessionTimeoutReminderInMinutes===undefined){this.config.sessionTimeoutReminderInMinutes=0;}this.oModel.setProperty("/SessionRemainingTimeInSeconds",this.config.sessionTimeoutReminderInMinutes*60);this.counter=0;this.oKeepAliveDialog=undefined;this.oLocalStorage=q.sap.storage(q.sap.storage.Type.local,"com.sap.ushell.adapters.local.session");this.registerCommHandlers();this.putTimestampInStorage(this._getCurrentDate());this.putContinueWorkingVisibilityInStorage(null);this.attachUserEvents();this.notifyServer();this.notifyUserInactivity();q.sap.measure.end("SessionTimeoutInit");};this.registerCommHandlers=function(){A.registerShellCommunicationHandler({"sap.ushell.sessionHandler":{oRequestCalls:{"logout":{isActiveOnly:false,distributionType:["URL"]},"extendSessionEvent":{isActiveOnly:false,distributionType:["URL"]}},oServiceCalls:{"notifyUserActive":{executeServiceCallFn:function(){e.userActivityHandler();return new q.Deferred().resolve().promise();}}}}});};this.notifyUserInactivity=function(){var f=this._getCurrentDate()-new Date(this.getTimestampFromStorage()),g=f/(1000*60),h=this.config.sessionTimeoutIntervalInMinutes-this.config.sessionTimeoutReminderInMinutes;if(g<h){setTimeout(this.notifyUserInactivity.bind(this),(h-g)*60*1000);}else if(this.config.sessionTimeoutReminderInMinutes>0){this.putContinueWorkingVisibilityInStorage(null);this.detachUserEvents();this.handleSessionRemainingTime(this.config.sessionTimeoutReminderInMinutes*60,true);this.oContinueWorkingDialog=this.createContinueWorkingDialog();this.oContinueWorkingDialog.open();}else{this.handleSessionOver();}};this.handleSessionOver=function(){clearTimeout(this.notifyServerTimer);sap.ui.getCore().getEventBus().publish("launchpad","sessionTimeout");if(this.config.enableAutomaticSignout===true){this.logout();}else{this.createSessionExpiredDialog().open();}};this.notifyServer=function(){var f=this._getCurrentDate()-new Date(this.getTimestampFromStorage()),g=f/(1000*60);if(g<=this.config.sessionTimeoutIntervalInMinutes){sap.ushell.Container.sessionKeepAlive();A.postMessageToIframeApp("sap.ushell.sessionHandler","extendSessionEvent",{});}else{}this.notifyServerTimer=setTimeout(this.notifyServer.bind(this),this.config.sessionTimeoutIntervalInMinutes*60*1000);};this.handleSessionRemainingTime=function(R){var s=this.getContinueWorkingVisibilityFromStorage();if(s!=undefined&&s===false&&this.oContinueWorkingDialog&&this.oContinueWorkingDialog.isOpen()){this.continueWorkingButtonPressHandler();}if(R===0){if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close();}this.handleSessionOver();}else{R=R-1;this.oModel.setProperty("/SessionRemainingTimeInSeconds",R);this.remainingTimer=setTimeout(e.handleSessionRemainingTime.bind(e,R,false),1000);}};this.createContinueWorkingDialog=function(){this.oMessageVBox=new V();this.oSessionKeepAliveLabel=new t({text:{parts:["/SessionRemainingTimeInSeconds"],formatter:function(s){var i=s>60,T,f,m;T=i?r.i18n.getText("sessionTimeoutMessage_units_minutes"):r.i18n.getText("sessionTimeoutMessage_units_seconds");f=i?Math.ceil(s/60):s;if(e.config.enableAutomaticSignout){m=r.i18n.getText("sessionTimeoutMessage_kioskMode_main",[f,T]);}else{m=r.i18n.getText("sessionTimeoutMessage_main",[f,T]);}return m;}}});this.oMessageVBox.addItem(this.oSessionKeepAliveLabel);if(this.config.enableAutomaticSignout===false){this.oLostDataReminder=new t({text:r.i18n.getText("sessionTimeoutMessage_unsavedData")});this.oMessageVBox.addItem(this.oLostDataReminder);}this.oSessionKeepAliveLabel.setModel(this.oModel);this.oSessionKeepAliveDialog=new d("sapUshellKeepAliveDialog",{title:r.i18n.getText("sessionTimeoutMessage_title"),type:"Message",state:a.Warning,content:this.oMessageVBox,beginButton:this.getContinueWorkingButton(),afterClose:function(){this.oSessionKeepAliveDialog.destroy();}.bind(this)});if(this.config.enableAutomaticSignout===true){this.oSignOutButton=new b({text:r.i18n.getText("logoutBtn_title"),tooltip:r.i18n.getText("logoutBtn_tooltip"),press:this.logout.bind(this)});this.oSessionKeepAliveDialog.setEndButton(this.oSignOutButton);}return this.oSessionKeepAliveDialog;};this.getContinueWorkingButton=function(){return new b({text:r.i18n.getText("sessionTimeoutMessage_continue_button_title"),press:e.continueWorkingButtonPressHandler.bind(e)});};this.continueWorkingButtonPressHandler=function(){if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close();}clearTimeout(this.remainingTimer);this.putTimestampInStorage(this._getCurrentDate());this.notifyUserInactivity();this.attachUserEvents();this.putContinueWorkingVisibilityInStorage(false);A.postMessageToIframeApp("sap.ushell.sessionHandler","extendSessionEvent",{});};this.createSessionExpiredDialog=function(){this.oSessionExpiredDialog=new d("sapUshellSessioTimedOutDialog",{title:r.i18n.getText("sessionExpiredMessage_title"),type:"Message",state:a.Warning,content:new t({text:r.i18n.getText("sessionExpiredMessage_main")}),beginButton:this.getReloadButton(),afterClose:function(){this.oSessionExpiredDialog.destroy();}.bind(this)});return this.oSessionExpiredDialog;};this.getReloadButton=function(){return new b({text:r.i18n.getText("sessionExpiredMessage_reloadPage_button_title"),press:function(){e.oSessionExpiredDialog.close();location.reload();}});};this.attachUserEvents=function(){q(document).on("mousedown.sessionTimeout mousemove.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("keyup.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("touchstart.sessionTimeout",this.userActivityHandler.bind(this));sap.ushell.Container.getService("AppLifeCycle").attachAppLoaded({},this.userActivityHandler,this);};this.detachUserEvents=function(){q(document).off("mousedown.sessionTimeout mousemove.sessionTimeout");q(document).off("keydown.sessionTimeout");q(document).off("touchstart.sessionTimeout");sap.ushell.Container.getService("AppLifeCycle").detachAppLoaded(this.userActivityHandler,this);};this.putTimestampInStorage=function(f){q.sap.measure.average("SessionTimeoutPutLocalStorage","Put timestamp in local storage Average","FLP_SHELL");this.oLocalStorage.put("lastActivityTime",f);q.sap.measure.end("SessionTimeoutPutLocalStorage");};this.putContinueWorkingVisibilityInStorage=function(v){this.oLocalStorage.put("showContinueWorkingDialog",v);};this.getContinueWorkingVisibilityFromStorage=function(){return this.oLocalStorage.get("showContinueWorkingDialog");};this.getTimestampFromStorage=function(){return this.oLocalStorage.get("lastActivityTime");};this.userActivityHandler=function(){if(this.oUserActivityTimer!==undefined){return;}this.oUserActivityTimer=setTimeout(function(){e.putTimestampInStorage(e._getCurrentDate());e.oUserActivityTimer=undefined;},1000);};this._getCurrentDate=function(){return new Date();};this.logout=function(){var l=new L({text:""});A.postMessageToIframeApp("sap.ushell.sessionHandler","logout",{},true).then(function(){e.detachUserEvents();clearTimeout(e.oUserActivityTimer);clearTimeout(e.remainingTimer);clearTimeout(e.notifyServerTimer);l.openLoadingScreen();l.showAppInfo(r.i18n.getText("beforeLogoutMsg"),null);sap.ushell.Container.setDirtyFlag(false);sap.ushell.Container.defaultLogout();});};};return S;},true);
