//Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/Config","sap/ushell/extensions/_PageComposition/Factory/PageSaveDialog","sap/base/Log","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/m/MessageToast","sap/ushell/resources","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(C,a,P,L,D,B,T,M,r,b,F,J){"use strict";return C.extend("sap.ushell.applications.PageComposerLegacy.Controller",{onInit:function(){this.oDeleteDialogModel=new J({sApprovalText:""});},_navigateHome:function(){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(c){c.toExternal({target:{shellHash:"#Shell-home"}});});},onItemPress:function(e){var p=e.getParameter("listItem").getBindingContext().getObject();a.emit("/core/extension/PageComposition",true);a.emit("/core/pageComposition/currentPageId",p.Id);a.emit("/core/pageComposition/editMode",false);a.emit("/core/pageComposition/composerState","initial");this._navigateHome();},onSelectionChange:function(e){var t=e.getSource();var n=t.getSelectedItems().length;var d=n>0;var c=n===1;var o=this.getView().getModel("buttonStates");o.setProperty("/isDeleteEnabled",d);o.setProperty("/isCopyEnabled",c);},onEdit:function(e){var p=e.getSource().getParent().getBindingContext().getObject();a.emit("/core/extension/PageComposition",true);a.emit("/core/pageComposition/currentPageId",p.Id);a.emit("/core/pageComposition/editMode",true);a.emit("/core/pageComposition/composerState","composing");this._navigateHome();},onAdd:function(){P.create().getPageSaveInformation().then(function(p){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(c){return c.createReferencePage(p,[]);}).then(function(R){return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(c){return c.createPage(R);});}).then(function(){a.emit("/core/extension/PageComposition",true);a.emit("/core/pageComposition/editMode",true);a.emit("/core/pageComposition/composerState","composing");a.emit("/core/pageComposition/currentPageId",p.content.id);this._navigateHome();}.bind(this)).catch(L.error);}.bind(this)).catch(L.error);},_confirmDelete:function(){var t=this.byId("sapUshellPagesTable");var i=t.getSelectedItems().map(function(c){return c.getBindingContext().getObject();});return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(c){var d=i.map(function(I){return c.deletePage(I.Id);});return Promise.all(d);}).then(function(){this.getOwnerComponent().refreshModel().then(function(){t.fireSelectionChange();});}.bind(this)).catch(L.error);},formatDate:function(d){var o=new Date(d);if(!o){return d;}var f=b.getInstance({format:"yMMMd"});return f.format(new Date(o));},onDeleteCancel:function(){var d=this.byId("pageOverviewDeleteDialog");d.close();},onDeleteConfirm:function(){var d=this.byId("pageOverviewDeleteDialog");this._confirmDelete();M.show(r.i18nModel.getProperty("pageOverviewSuccess"));d.close();},_formatDeleteDialogText:function(){var v=this.getView();var t=this.byId("sapUshellPagesTable");var R=v.getModel("i18n").getResourceBundle();var i=t.getSelectedItems().map(function(c){return c.getBindingContext().getObject();});var I=i.map(function(o){return o.Id;}).join("\n");return R.getText("pageOverviewDeleteText")+"\n\n"+I;},onDelete:function(){var v=this.getView();var t=this.byId("sapUshellPagesTable");if(t.getSelectedItems().length===0){return;}var A=this._formatDeleteDialogText();this.oDeleteDialogModel.setProperty("/sApprovalText",A);if(!this.oDeleteDialogPromise){this.oDeleteDialogPromise=F.load({id:v.getId(),name:"sap.ushell.applications.PageComposerLegacy.view.DeleteDialog",controller:this}).then(function(f){f.setModel(this.oDeleteDialogModel);f.setModel(r.i18nModel,"i18n");v.addDependent(f);return f;}.bind(this));}this.oDeleteDialogPromise.then(function(f){f.open();});}});},false);
