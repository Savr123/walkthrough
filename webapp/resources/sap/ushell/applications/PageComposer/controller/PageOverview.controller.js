//Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/applications/PageComposer/controller/BaseController","sap/ushell/Config","sap/ushell/extensions/_PageComposition/Factory/PageSaveDialog","sap/base/Log","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/m/MessageToast","sap/ushell/resources","sap/ui/model/json/JSONModel","sap/ushell/applications/PageComposer/model/formatter"],function(B,C,P,L,D,a,T,M,r,J,f){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.Main",{onInit:function(){this.oDeleteDialogModel=new J({approvalText:""});this.oCopyDialogModel=new J({page:null,approvalText:""});this.getRouter().getRoute("overview").attachPatternMatched(this._onPageOverviewMatched,this);this.setModel(this._createInitialButtonStateModel(),"buttonStates");},formatter:f,onItemPress:function(e){var p=e.getParameter("listItem").getBindingContext().getObject();this._navigateToDetail(p.content.id);},_onPageOverviewMatched:function(){this.refreshModel();},_navigateToEdit:function(p){this.getRouter().navTo("edit",{pageId:encodeURIComponent(p)});},_navigateToDetail:function(p){this.getRouter().navTo("detail",{pageId:encodeURIComponent(p)});},onSelectionChange:function(e){var t=e.getSource();var n=t.getSelectedItems().length;var d=n>0;var c=n===1;var b=this.getView().getModel("buttonStates");b.setProperty("/isDeleteEnabled",d);b.setProperty("/isCopyEnabled",c);},onEdit:function(e){var p=e.getSource().getParent().getBindingContext().getObject();this._navigateToEdit(p.content.id);},onAdd:function(){P.create().getPageSaveInformation(this.getView()).then(function(p){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(b){return b.createReferencePage(p,[]);}).then(function(R){return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(b){return b.createPage(R);});}).then(function(){this._navigateToEdit(p.content.id);M.show(r.i18nModel.getProperty("pageOverviewCreateSuccess"));}.bind(this)).catch(L.error);}.bind(this)).catch(L.error);},_deletePage:function(e){var d=e.getSource().getParent();var t=this.byId("sapUshellPagesTable");var i=t.getSelectedItems().map(function(b){return b.getBindingContext().getObject();});return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(b){var c=i.map(function(I){return b.deletePage(I.content.id);});return Promise.all(c);}).then(function(){this.refreshModel().then(function(){t.fireSelectionChange();M.show(r.i18nModel.getProperty("pageOverviewSuccess"));d.close();});}.bind(this)).catch(L.error);},_formatDeleteDialogText:function(){var t=this.byId("sapUshellPagesTable");var R=this.getResourceBundle();var i=t.getSelectedItems().map(function(b){return b.getBindingContext().getObject();});var I=f.deleteDialogText(i);return R.getText("pageOverviewDeleteText")+"\n\n"+I;},onDelete:function(){var t=this.byId("sapUshellPagesTable");if(t.getSelectedItems().length===0){return;}var A=this._formatDeleteDialogText();this.oDeleteDialogModel.setProperty("/approvalText",A);this.getOwnerComponent().showDeleteDialog(this.oDeleteDialogModel,this._deletePage.bind(this));},onCopy:function(){var t=this.byId("sapUshellPagesTable");var i=t.getSelectedItems().map(function(b){return b.getBindingContext().getObject();});if(i.length!==1){return;}var s=i[0];this.oCopyDialogModel.setProperty("/page",s);this.getOwnerComponent().showCopyDialog(this.oCopyDialogModel,this._copyPage.bind(this));},_copyPage:function(e){},refreshModel:function(){return this._loadAvailablePages().then(function(p){this.setModel(new J(p));}.bind(this));},_loadAvailablePages:function(){return sap.ushell.Container.getServiceAsync("PagePersistence").then(function(b){return b.getPages();}).then(function(p){return{pages:p};});},_createInitialButtonStateModel:function(){return new J({isDeleteEnabled:false,isCopyEnabled:false});}});},false);
