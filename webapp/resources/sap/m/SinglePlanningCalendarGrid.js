/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./SinglePlanningCalendarUtilities','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/Locale','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/date/UniversalDate','sap/ui/core/dnd/DragInfo','sap/ui/core/dnd/DropInfo','sap/ui/core/dnd/DragDropInfo','sap/ui/unified/library','sap/ui/unified/CalendarAppointment','sap/ui/unified/calendar/DatesRow','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/events/KeyCodes','./SinglePlanningCalendarGridRenderer','sap/ui/Device','sap/ui/core/delegate/ItemNavigation',"sap/ui/thirdparty/jquery",'./PlanningCalendarLegend'],function(S,C,L,a,I,D,U,b,c,d,u,e,f,g,h,K,k,l,m,q,P){"use strict";var R=69,n=48,B=34,o=25,H=3600000/2,O=60*1000,M=86400000,p=7;var r=C.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}}}}});r.prototype.init=function(){var i=new Date(),j=new f(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:i}).addStyleClass("sapMSinglePCColumnHeader"),v=(60-i.getSeconds())*1000;this.setAggregation("_columnHeaders",j);this.setStartDate(i);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._configureAppointmentsResize();this._configureAppointmentsCreate();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatAriaApp=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' HH:mm:ss a"});this._oFormatAriaFullDayCell=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY"});this._oFormatAriaCell=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' HH"});this._sLegendId=undefined;setTimeout(this._updateRowHeaderAndNowMarker.bind(this),v);};r.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation;}};r.prototype.onBeforeRendering=function(){var A=this._createAppointmentsMap(this.getAppointments()),i=this.getStartDate(),j=g.fromLocalJSDate(i),v=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(A.appointments,this.getStartDate(),v);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(A.blockers,j,v);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==v||this._oOldStartDate!==i){this._createBlockersDndPlaceholders(i,v);this._createAppointmentsDndPlaceholders(i,v);}};r.prototype.onmousedown=function(E){var i=E.target.classList;this._isResizeHandleBottomMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleBottom");this._isResizeHandleTopMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleTop");};r.prototype._isResizingPerformed=function(){return this._isResizeHandleBottomMouseDownTarget||this._isResizeHandleTopMouseDownTarget;};r.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new d({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),v=this.isAllDayAppointment(A.getStartDate(),A.getEndDate()),w=function(){var $=q(i.getIndicator()),x=A.$().outerHeight(),y=A.$().outerWidth(),G=j.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),z=j.getDomRef().getBoundingClientRect(),F=(z.left+y)-(G.left+G.width);if(v){$.css("min-height",x);$.css("min-width",Math.min(y,y-F));}else{$.css("min-height",i.getDropControl().$().outerHeight());$.css("min-width",i.getDropControl().$().outerWidth());}};if(!i.getIndicator()){setTimeout(w,0);}else{w();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),v=j.getDate().getJSDate(),w,x=E.getParameter("browserEvent"),y=(x.metaKey||x.ctrlKey),z=this.isAllDayAppointment(A.getStartDate(),A.getEndDate());w=new Date(v);if(z){w.setMilliseconds(A.getEndDate().getTime()-A.getStartDate().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(z&&A.getStartDate().getTime()===v.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:v,endDate:w,copy:y});}.bind(this)}));};r.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new d({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()||this._isResizingPerformed()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),v=this.isAllDayAppointment(A.getStartDate(),A.getEndDate()),w=function(){var $=q(i.getIndicator()),x=A.$().outerHeight(),G=j.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),y=i.getDropControl().getDomRef().getBoundingClientRect(),z=(y.top+x)-(G.top+G.height);if(v){$.css("min-height",2*i.getDropControl().$().outerHeight());}else{$.css("min-height",Math.min(x,x-z));}};if(!i.getIndicator()){setTimeout(w,0);}else{w();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),v=j.getDate().getJSDate(),w,x=E.getParameter("browserEvent"),y=(x.metaKey||x.ctrlKey),z=this.isAllDayAppointment(A.getStartDate(),A.getEndDate());w=new Date(v);if(z){w.setHours(w.getHours()+1);}else{w.setMilliseconds(A.getEndDate().getTime()-A.getStartDate().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!z&&A.getStartDate().getTime()===v.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:v,endDate:w,copy:y});}.bind(this)}));};r.prototype._configureAppointmentsResize=function(){var i=new d({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsResize()||!this._isResizingPerformed()){E.preventDefault();return;}var j=E.getParameter("dragSession"),$=this.$().find(".sapMSinglePCOverlay"),v=q(j.getIndicator()),w=j.getDragControl().$();if(this._isResizeHandleBottomMouseDownTarget){j.setData("bottomHandle","true");}if(this._isResizeHandleTopMouseDownTarget){j.setData("topHandle","true");}v.addClass("sapUiDnDIndicatorHide");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");},0);q(document).one("dragend",function(){var A=j.getComplexData("appointmentStartingBoundaries");$.removeClass("sapMSinglePCOverlayDragging");v.removeClass("sapUiDnDIndicatorHide");w.css({top:A.top,height:A.height,"z-index":"auto",opacity:1});});if(!l.browser.msie&&!l.browser.edge){E.getParameter("browserEvent").dataTransfer.setDragImage(s(),0,0);}}.bind(this),dragEnter:function(E){var j=E.getParameter("dragSession"),A=j.getDragControl().$().get(0),v=j.getDropControl().getDomRef(),w=j.getComplexData("appointmentStartingBoundaries"),x=function(){var $=q(j.getIndicator());$.addClass("sapUiDnDIndicatorHide");},T,y,z,V,F;if(!w){w={top:A.offsetTop,bottom:A.offsetTop+A.getBoundingClientRect().height,height:A.getBoundingClientRect().height};j.setComplexData("appointmentStartingBoundaries",w);}V=j.getData("bottomHandle")?w.top:w.bottom;T=Math.min(V,v.offsetTop);y=Math.max(V,v.offsetTop+v.getBoundingClientRect().height);z=y-T;F={top:T,height:z,"z-index":1,opacity:0.8};j.getDragControl().$().css(F);if(!j.getIndicator()){setTimeout(x,0);}else{x();}},drop:function(E){var j=E.getParameter("dragSession"),A=j.getDragControl(),v=this.indexOfAggregation("_intervalPlaceholders",j.getDropControl()),w=j.getComplexData("appointmentStartingBoundaries"),x;x=this._calcResizeNewHoursAppPos(A.getStartDate(),A.getEndDate(),v,j.getData("bottomHandle"));this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");q(j.getIndicator()).removeClass("sapUiDnDIndicatorHide");A.$().css({top:w.top,height:w.height,"z-index":"auto",opacity:1});if(A.getEndDate().getTime()===x.endDate.getTime()&&A.getStartDate().getTime()===x.startDate.getTime()){return;}this.fireAppointmentResize({appointment:A,startDate:x.startDate,endDate:x.endDate});}.bind(this)});this.addDragDropConfig(i);};r.prototype._configureAppointmentsCreate=function(){this.addDragDropConfig(new d({targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsCreate()){E.preventDefault();return;}var $=this.$().find(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");});if(!l.browser.msie&&!l.browser.edge){E.getParameter("browserEvent").dataTransfer.setDragImage(s(),0,0);}}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),v=j.getDomRef(),w=v.offsetHeight,x=v.offsetTop,y=x,z=v.getBoundingClientRect().left,A=z,F=j.$().parents(".sapMSinglePCColumn").get(0),$=q(".sapUiAppCreate");if(!$.get(0)){$=q("<div></div>").addClass("sapUiCalendarApp sapUiCalendarAppType01 sapUiAppCreate");$.appendTo(F);}q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");if(!i.getComplexData("startingRectsDropArea")){i.setComplexData("startingRectsDropArea",{top:x,left:z});i.setComplexData("startingDropDate",j.getDate());}else{y=i.getComplexData("startingRectsDropArea").top;A=i.getComplexData("startingRectsDropArea").left;}if(z!==A){E.preventDefault();return false;}j.$().closest(".sapMSinglePCColumn").find(".sapMSinglePCAppointments").addClass("sapUiDnDDragging");$.css({top:Math.min(y,x)+2,height:Math.abs(y-x)+w-4,left:3,right:3,"z-index":2});i.setIndicatorConfig({display:"none"});},drop:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),T=30*60*1000,v=i.getComplexData("startingDropDate").getTime(),w=j.getDate().getJSDate().getTime(),x=Math.min(v,w),y=Math.max(v,w)+T;this.fireAppointmentCreate({startDate:new Date(x),endDate:new Date(y)});q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");}.bind(this)}));};r.prototype._calcResizeNewHoursAppPos=function(A,i,j,v){var w=new Date(this.getStartDate().getFullYear(),this.getStartDate().getMonth(),this.getStartDate().getDate()),x=30*60*1000,y=w.getTime()+j*x,z=y+x,V=v?A.getTime():i.getTime(),E=Math.min(V,y),F=Math.max(V,z);return{startDate:new Date(E),endDate:new Date(F)};};r.prototype._adjustAppointmentsHeightforCompact=function(i,j,v){var A,$,w,x,y,z,E,F,G=this._getRowHeight(),J=this;if(this._oAppointmentsToRender[i]){this._oAppointmentsToRender[i].oAppointmentsList.getIterator().forEach(function(N){A=N.getData();$=q("div[data-sap-day='"+i+"'].sapMSinglePCColumn #"+A.getId());w=A.getStartDate();x=A.getEndDate();E=j.getTime()>w.getTime();F=v.getTime()<x.getTime();y=E?0:J._calculateTopPosition(w);z=F?0:J._calculateBottomPosition(x);$.css("top",y);$.css("bottom",z);$.find(".sapUiCalendarApp").css("min-height",G/2-3);});}};r.prototype._adjustBlockersHeightforCompact=function(){var i=this._getBlockersToRender().iMaxlevel,j=(i+1)*this._getBlockerRowHeight(),v=this._getColumns()===1?j+p:j,w=this._getBlockerRowHeight();if(i>0){v=v+3;}this.$().find(".sapMSinglePCBlockersColumns").css("height",v);this._oBlockersToRender.oBlockersList.getIterator().forEach(function(x){x.getData().$().css("top",w*x.level+1);});};r.prototype._adjustBlockersHeightforCozy=function(){var i=this._getBlockersToRender()&&this._getBlockersToRender().iMaxlevel,j;if(this._getColumns()===1){j=(i+1)*this._getBlockerRowHeight();this.$().find(".sapMSinglePCBlockersColumns").css("height",j+p);}};r.prototype.onAfterRendering=function(){var j=this._getColumns(),v=this.getStartDate(),w=this._getRowHeight();if(w===n){for(var i=0;i<j;i++){var x=new g(v.getFullYear(),v.getMonth(),v.getDate()+i),y=this._getDateFormatter().format(x.toLocalJSDate()),z=new U(x.getYear(),x.getMonth(),x.getDate(),this._getVisibleStartHour()),A=new U(x.getYear(),x.getMonth(),x.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(y,z,A);}this._adjustBlockersHeightforCompact();}else{this._adjustBlockersHeightforCozy();}this._updateRowHeaderAndNowMarker();_.call(this);};r.prototype.onkeydown=function(E){var A=E.srcControl,i=!(E.ctrlKey||E.metaKey),G;if(E.which===K.SPACE||E.which===K.ENTER){if(A&&A.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:A,appointments:this._toggleAppointmentSelection(A,i)});}else if(E.target.classList.contains("sapMSinglePCRow")||E.target.classList.contains("sapMSinglePCBlockersColumn")){G=E.target;this.fireEvent("cellPress",{startDate:this._getDateFormatter().parse(G.getAttribute("data-sap-start-date")),endDate:this._getDateFormatter().parse(G.getAttribute("data-sap-end-date"))});}E.preventDefault();}};r.prototype._appFocusHandler=function(E,i){var A=sap.ui.getCore().byId(E.target.id),j=A&&A.isA("sap.ui.unified.CalendarAppointment");if(j){this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});this._focusCellWithKeyboard(A,i);E.preventDefault();}};r.prototype._cellFocusHandler=function(E,i){var G=E.target,F=this._getDateFormatter(),j;if(G.classList.contains("sapMSinglePCRow")||G.classList.contains("sapMSinglePCBlockersColumn")){j=F.parse(G.getAttribute("data-sap-start-date"));if(this._isBorderReached(j,i)){this.fireEvent("borderReached",{startDate:j,next:i===K.ARROW_RIGHT,fullDay:G.classList.contains("sapMSinglePCBlockersColumn")});}}};r.prototype.onsapup=function(E){this._appFocusHandler(E,K.ARROW_UP);};r.prototype.onsapdown=function(E){this._appFocusHandler(E,K.ARROW_DOWN);};r.prototype.onsapright=function(E){this._appFocusHandler(E,K.ARROW_RIGHT);this._cellFocusHandler(E,K.ARROW_RIGHT);};r.prototype.onsapleft=function(E){this._appFocusHandler(E,K.ARROW_LEFT);this._cellFocusHandler(E,K.ARROW_LEFT);};r.prototype.setStartDate=function(i){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(i);return this.setProperty("startDate",i);};r.prototype.applyFocusInfo=function(F){var v=this._getVisibleBlockers(),V=this._getVisibleAppointments(),w=Object.keys(V),x,i,j;for(i=0;i<v.length;++i){if(v[i].getId()===F.id){v[i].focus();return this;}}for(i=0;i<w.length;++i){x=V[w[i]];for(j=0;j<x.length;++j){if(x[j].getId()===F.id){x[j].focus();return this;}}}return this;};r.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(A){return A.getSelected();});};r.prototype._toggleAppointmentSelection=function(A,j){var v=[],w,x,i;if(j){w=this.getAppointments();for(i=0,x=w.length;i<x;i++){if((!A||w[i].getId()!==A.getId())&&w[i].getSelected()){w[i].setProperty("selected",false,true);v.push(w[i]);q('[data-sap-ui='+w[i].getId()+']').attr("aria-selected","false").find(".sapUiCalendarApp").removeClass("sapUiCalendarAppSel");}}}if(A){A.setProperty("selected",!A.getSelected(),true);v.push(A);q('[data-sap-ui='+A.getId()+']').attr("aria-selected",A.getSelected()).find(".sapUiCalendarApp").toggleClass("sapUiCalendarAppSel",A.getSelected());}return v;};r.prototype._isBorderReached=function(F,i){var G=g.fromLocalJSDate(this.getStartDate()),j=new g(G.getYear(),G.getMonth(),G.getDate()+this._getColumns()-1),T=g.fromLocalJSDate(F),v=i===K.ARROW_LEFT&&T.isSame(G),w=i===K.ARROW_RIGHT&&T.isSame(j);return v||w;};r.prototype._focusCellWithKeyboard=function(A,i){var F=this.isAllDayAppointment(A.getStartDate(),A.getEndDate()),j=this._getDateFormatter(),v=new Date(A.getStartDate().getFullYear(),A.getStartDate().getMonth(),A.getStartDate().getDate(),A.getStartDate().getHours()),G=new Date(this.getStartDate().getFullYear(),this.getStartDate().getMonth(),this.getStartDate().getDate(),this.getStartDate().getHours());if(v<G){v=G;}if(this._isBorderReached(v,i)){this.fireEvent("borderReached",{startDate:v,next:i===K.ARROW_RIGHT,fullDay:F});return;}switch(i){case K.ARROW_UP:if(!F){v.setHours(v.getHours()-1);}break;case K.ARROW_DOWN:if(!F){v.setHours(v.getHours()+1);}break;case K.ARROW_LEFT:v.setDate(v.getDate()-1);break;case K.ARROW_RIGHT:v.setDate(v.getDate()+1);break;default:}if(F&&i!==K.ARROW_DOWN){q("[data-sap-start-date='"+j.format(v)+"'].sapMSinglePCBlockersColumn").focus();}else{q("[data-sap-start-date='"+j.format(v)+"'].sapMSinglePCRow").focus();}};r.prototype.ontap=function(E){var A=E.srcControl,i=!(E.ctrlKey||E.metaKey);if(A&&A.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:A,appointments:this._toggleAppointmentSelection(A,i)});}else if(E.target.classList.contains("sapMSinglePCRow")||E.target.classList.contains("sapMSinglePCBlockersColumn")){this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});}};r.prototype._getVisibleStartHour=function(){return 0;};r.prototype._getVisibleEndHour=function(){return 23;};r.prototype._isVisibleHour=function(){return true;};r.prototype._isOutsideVisibleHours=function(){return false;};r.prototype._shouldHideRowHeader=function(i){var j=new Date().getHours(),v=h._areCurrentMinutesLessThan(15)&&j===i,w=h._areCurrentMinutesMoreThan(45)&&j===i-1;return v||w;};r.prototype._parseDateStringAndHours=function(i,j){var v=this._getDateFormatter().parse(i);if(j){v.setHours(j);}return v;};r.prototype._getDateFormatter=function(){if(!(this._oDateFormat instanceof D)){this._oDateFormat=D.getDateTimeInstance({pattern:"YYYYMMdd-HHmm"});}return this._oDateFormat;};r.prototype._formatTimeAsString=function(i){var j=this._getHoursPattern()+":mm",F=D.getDateTimeInstance({pattern:j},new a(this._getCoreLocaleId()));return F.format(i);};r.prototype._addAMPM=function(i){var A=this._getAMPMFormat();return" "+A.format(i);};r.prototype._calculateTopPosition=function(i){var j=i.getHours()-this._getVisibleStartHour(),v=i.getMinutes(),w=this._getRowHeight();return Math.floor((w*j)+(w/60)*v);};r.prototype._calculateBottomPosition=function(i){var j=this._getVisibleEndHour()+1-i.getHours(),v=i.getMinutes(),w=this._getRowHeight();return Math.floor((w*j)-(w/60)*v);};r.prototype._updateRowHeaderAndNowMarker=function(){var i=new Date();this._updateNowMarker(i);this._updateRowHeaders(i);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),O);};r.prototype._updateNowMarker=function(i){var $=this.$("nowMarker"),j=this.$("nowMarkerText"),v=this.$("nowMarkerAMPM"),w=this._isOutsideVisibleHours(i.getHours());$.toggleClass("sapMSinglePCNowMarkerHidden",w);$.css("top",this._calculateTopPosition(i)+"px");j.text(this._formatTimeAsString(i));v.text(this._addAMPM(i));j.append(v);};r.prototype._updateRowHeaders=function(i){var $=this.$(),j=i.getHours(),N=j+1;$.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(j)){$.find(".sapMSinglePCRowHeader"+j).addClass("sapMSinglePCRowHeaderHidden");}else if(this._shouldHideRowHeader(N)){$.find(".sapMSinglePCRowHeader"+N).addClass("sapMSinglePCRowHeaderHidden");}};r.prototype._createAppointmentsMap=function(A){var i=this;return A.reduce(function(j,v){var w=v.getStartDate(),x=v.getEndDate(),y,z,E;if(!w||!x){return j;}if(!i.isAllDayAppointment(w,x)){y=g.fromLocalJSDate(w);z=g.fromLocalJSDate(x);while(y.isSameOrBefore(z)){E=i._getDateFormatter().format(y.toLocalJSDate());if(!j.appointments[E]){j.appointments[E]=[];}j.appointments[E].push(v);y.setDate(y.getDate()+1);}}else{j.blockers.push(v);}return j;},{appointments:{},blockers:[]});};r.prototype._calculateVisibleAppointments=function(A,j,v){var V={},w,x,y;for(var i=0;i<v;i++){w=new g(j.getFullYear(),j.getMonth(),j.getDate()+i);x=this._getDateFormatter().format(w.toLocalJSDate());y=this._isAppointmentFitInVisibleHours(w);if(A[x]){V[x]=A[x].filter(y,this).sort(this._sortAppointmentsByStartHourCallBack);}}return V;};r.prototype._isAppointmentFitInVisibleHours=function(i){return function(A){var j=A.getStartDate().getTime(),v=A.getEndDate().getTime(),w=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleStartHour())).getTime(),x=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleEndHour(),59,59)).getTime();var y=j<w&&v>x,z=j>=w&&j<x,E=v>w&&v<=x;return y||z||E;};};r.prototype._calculateAppointmentsLevelsAndWidth=function(v){var i=this;return Object.keys(v).reduce(function(A,j){var w=0,x=new S.list(),y=v[j];y.forEach(function(z){var E=new S.node(z),F=z.getStartDate().getTime();if(x.getSize()===0){x.add(E);return;}x.getIterator().forEach(function(G){var J=true,N=G.getData(),Q=N.getStartDate().getTime(),T=N.getEndDate().getTime(),V=T-Q;if(V<H){T=T+(H-V);}if(F>=Q&&F<T){E.level++;w=Math.max(w,E.level);}if(G.next&&G.next.level===E.level){J=false;}if(F>=T&&J){this.interrupt();}});x.insertAfterLevel(E.level,E);});A[j]={oAppointmentsList:i._calculateAppointmentsWidth(x),iMaxLevel:w};return A;},{});};r.prototype._calculateAppointmentsWidth=function(A){A.getIterator().forEach(function(i){var j=i.getData(),v=i.level,w=i.level,x=j.getStartDate().getTime(),y=j.getEndDate().getTime(),z=y-x;if(z<H){y=y+(H-z);}new S.iterator(A).forEach(function(E){var F=E.getData(),G=E.level,J=F.getStartDate().getTime(),N=F.getEndDate().getTime(),Q=N-J;if(Q<H){N=N+(H-Q);}if(w>=G){return;}if(x>=J&&x<N||y>J&&y<N||x<=J&&y>=N){i.width=G-w;this.interrupt();return;}if(v<G){v=G;i.width++;}});});return A;};r.prototype._calculateVisibleBlockers=function(i,j,v){var w=new g(j.getYear(),j.getMonth(),j.getDate()+v-1),x=this._isBlockerVisible(j,w);return i.filter(x).sort(this._sortAppointmentsByStartHourCallBack);};r.prototype._isBlockerVisible=function(v,V){return function(A){var i=g.fromLocalJSDate(A.getStartDate()),j=g.fromLocalJSDate(A.getEndDate());var w=i.isBefore(v)&&j.isAfter(V),x=h._isBetween(i,v,V,true),E=h._isBetween(j,v,V,true);return w||x||E;};};r.prototype._calculateBlockersLevelsAndWidth=function(v){var i=0,j=new S.list();v.forEach(function(w){var x=new S.node(w),y=g.fromLocalJSDate(w.getStartDate()),z=g.fromLocalJSDate(w.getEndDate());x.width=h._daysBetween(z,y);if(j.getSize()===0){j.add(x);return;}j.getIterator().forEach(function(A){var E=true,F=A.getData(),G=g.fromLocalJSDate(F.getStartDate()),J=g.fromLocalJSDate(F.getEndDate());if(y.isSameOrAfter(G)&&y.isSameOrBefore(J)){x.level++;i=Math.max(i,x.level);}if(A.next&&A.next.level===x.level){E=false;}if(y.isSameOrAfter(J)&&E){this.interrupt();}});j.insertAfterLevel(x.level,x);},this);return{oBlockersList:j,iMaxlevel:i};};r.prototype._sortAppointmentsByStartHourCallBack=function(A,i){return A.getStartDate().getTime()-i.getStartDate().getTime()||i.getEndDate().getTime()-A.getEndDate().getTime();};r.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments;};r.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender;};r.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers;};r.prototype._getBlockersToRender=function(){return this._oBlockersToRender;};r.prototype._setColumns=function(i){this._iOldColumns=this._iColumns;this._iColumns=i;this.getAggregation("_columnHeaders").setDays(i);this.invalidate();return this;};r.prototype._getColumns=function(){return this._iColumns;};r.prototype._getRowHeight=function(){return this._isCompact()?n:R;};r.prototype._getBlockerRowHeight=function(){return this._isCompact()?o:B;};r.prototype._isCompact=function(){var i=this.getDomRef();while(i&&i.classList){if(i.classList.contains("sapUiSizeCompact")){return true;}i=i.parentNode;}return false;};r.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};r.prototype._getCoreLocaleData=function(){var i,j;if(!this._oLocaleData){i=this._getCoreLocaleId();j=new a(i);this._oLocaleData=L.getInstance(j);}return this._oLocaleData;};r.prototype._hasAMPM=function(){var i=this._getCoreLocaleData();return i.getTimePattern("short").search("a")>=0;};r.prototype._getHoursFormat=function(){var i=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==i){var j=new a(i),v=this._getHoursPattern();this._oHoursFormat=D.getTimeInstance({pattern:v},j);}return this._oHoursFormat;};r.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H";};r.prototype._getAMPMFormat=function(){var i=this._getCoreLocaleId(),j=new a(i);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==i){this._oAMPMFormat=D.getTimeInstance({pattern:"a"},j);}return this._oAMPMFormat;};r.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders");};r.prototype._getAppointmentAnnouncementInfo=function(A){var i=this._oUnifiedRB.getText("CALENDAR_START_TIME"),E=this._oUnifiedRB.getText("CALENDAR_END_TIME"),F=this._oFormatAriaApp.format(A.getStartDate()),j=this._oFormatAriaApp.format(A.getEndDate()),v=i+": "+F+"; "+E+": "+j;return v+"; "+P.findLegendItemForItem(sap.ui.getCore().byId(this._sLegendId),A);};r.prototype.enhanceAccessibilityState=function(i,A){if(i.getId()===this._getColumnHeaders().getId()){A.labelledby=I.getStaticId("sap.m","PLANNINGCALENDAR_DAYS");}};r.prototype._getCellStartEndInfo=function(i,E){var j=this._oUnifiedRB.getText("CALENDAR_START_TIME"),v=this._oUnifiedRB.getText("CALENDAR_END_TIME"),F=!E;if(F){return j+": "+this._oFormatAriaFullDayCell.format(i)+"; ";}return j+": "+this._oFormatAriaCell.format(i)+"; "+v+": "+this._oFormatAriaCell.format(E)+"; ";};r.prototype.isAllDayAppointment=function(A,i){var j=A.getHours()===0,v=A.getMinutes()===0,w=A.getSeconds()===0,x=A.getMilliseconds()===0,y=j&&v&&w&&x,z=false;if(y){z=this._isEndTime0000(A,i);}return z;};r.prototype._isEndTime0000=function(A,i){return(i.getTime()-A.getTime())%M===0;};r.prototype._createBlockersDndPlaceholders=function(j,v){this.destroyAggregation("_blockersPlaceholders");for(var i=0;i<v;i++){var w=new U(j.getFullYear(),j.getMonth(),j.getDate()+i);var x=new t({date:w});this.addAggregation("_blockersPlaceholders",x,true);}};r.prototype._createAppointmentsDndPlaceholders=function(v,w){var x=this._getVisibleStartHour(),E=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var i=0;i<w;i++){var y=new g(v.getFullYear(),v.getMonth(),v.getDate()+i);if(!this._dndPlaceholdersMap[y]){this._dndPlaceholdersMap[y]=[];}for(var j=x;j<=E;j++){var z=this._dndPlaceholdersMap[y],Y=y.getYear(),A=y.getMonth(),F=y.getDate();z.push(this._createAppointmentsDndPlaceHolder(new U(Y,A,F,j)));z.push(this._createAppointmentsDndPlaceHolder(new U(Y,A,F,j,30)));}}};r.prototype._createAppointmentsDndPlaceHolder=function(i){var j=new t({date:i});this.addAggregation("_intervalPlaceholders",j,true);return j;};function s(){var $=q("<span></span>").addClass("sapUiCalAppResizeGhost");$.appendTo(document.body);setTimeout(function(){$.remove();},0);return $.get(0);}var t=C.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:function(i,j){i.write("<div");i.writeControlData(j);i.addClass("sapMSinglePCPlaceholder");i.writeClasses();i.write("></div>");}});function _(){var i=this.getDomRef(),j=this.$().find(".sapMSinglePCBlockersColumn").toArray();this._aGridCells=Array.prototype.concat(j);for(var v=0;v<=this._getVisibleEndHour();++v){j=this.$().find("div[data-sap-hour='"+v+"']").toArray();this._aGridCells=this._aGridCells.concat(j);}if(!this._oItemNavigation){this._oItemNavigation=new m();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(true,true).setColumns(this._getColumns());this._oItemNavigation.setPageSize(this._aGridCells.length);}return r;});
